<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Bot√≥n Nueva Solicitud</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1><i class="fas fa-bug me-2"></i>Diagn√≥stico: Bot√≥n Nueva Solicitud</h1>
        
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Esta p√°gina ayuda a diagnosticar problemas con el bot√≥n "Nueva Solicitud"
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-vial me-2"></i>Pruebas de Funcionamiento</h5>
                    </div>
                    <div class="card-body">
                        <!-- Bot√≥n de prueba -->
                        <div class="mb-4">
                            <h6>Bot√≥n de Prueba:</h6>
                            <button class="btn btn-primary" id="btnPrueba">
                                <i class="fas fa-plus me-2"></i>Nueva Solicitud (Prueba)
                            </button>
                        </div>

                        <!-- Resultados -->
                        <div class="mb-4">
                            <h6>Resultados de Diagn√≥stico:</h6>
                            <div id="resultados" class="border p-3 bg-light" style="min-height: 200px; font-family: monospace; font-size: 12px;"></div>
                        </div>

                        <!-- Botones de acci√≥n -->
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="ejecutarDiagnostico()">
                                <i class="fas fa-play me-1"></i>Ejecutar Diagn√≥stico
                            </button>
                            <button class="btn btn-info" onclick="probarToken()">
                                <i class="fas fa-key me-1"></i>Probar Token
                            </button>
                            <button class="btn btn-warning" onclick="probarEndpoint()">
                                <i class="fas fa-network-wired me-1"></i>Probar API
                            </button>
                            <button class="btn btn-secondary" onclick="limpiarResultados()">
                                <i class="fas fa-eraser me-1"></i>Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-question-circle me-2"></i>Instrucciones</h6>
                    </div>
                    <div class="card-body">
                        <ol>
                            <li>Ejecuta el diagn√≥stico</li>
                            <li>Revisa los resultados</li>
                            <li>Verifica que tengas un token v√°lido</li>
                            <li>Prueba el endpoint API</li>
                            <li>Si todo est√° bien, el problema puede ser en el frontend</li>
                        </ol>
                        
                        <hr>
                        
                        <h6><i class="fas fa-tools me-2"></i>Soluciones Comunes:</h6>
                        <ul class="small">
                            <li>Recargar la p√°gina</li>
                            <li>Limpiar cache del navegador</li>
                            <li>Verificar consola de errores (F12)</li>
                            <li>Comprobar si JavaScript est√° habilitado</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let resultadosDiv = document.getElementById('resultados');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            resultadosDiv.innerHTML += `[${timestamp}] ${message}\n`;
            resultadosDiv.scrollTop = resultadosDiv.scrollHeight;
        }

        function limpiarResultados() {
            resultadosDiv.innerHTML = '';
        }

        function ejecutarDiagnostico() {
            log('üîç Iniciando diagn√≥stico completo...\n');
            
            // 1. Verificar empleadoSystem
            if (typeof window.empleadoSystem !== 'undefined') {
                log('‚úÖ empleadoSystem existe');
                if (typeof window.empleadoSystem.mostrarSolicitudPermiso === 'function') {
                    log('‚úÖ Funci√≥n mostrarSolicitudPermiso disponible');
                } else {
                    log('‚ùå Funci√≥n mostrarSolicitudPermiso NO disponible');
                }
            } else {
                log('‚ùå empleadoSystem NO existe');
            }
            
            // 2. Verificar token
            const token = localStorage.getItem('empleado_token');
            if (token) {
                log('‚úÖ Token encontrado en localStorage');
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const isValid = payload.exp > Date.now()/1000;
                    log(`${isValid ? '‚úÖ' : '‚ùå'} Token ${isValid ? 'v√°lido' : 'EXPIRADO'}`);
                    log(`   Empleado: ${payload.nombre}`);
                } catch (err) {
                    log('‚ùå Error decodificando token');
                }
            } else {
                log('‚ùå Token NO encontrado');
            }
            
            // 3. Verificar botones en DOM
            const botones = document.querySelectorAll('button');
            let encontrados = 0;
            botones.forEach(btn => {
                if (btn.textContent.includes('Nueva Solicitud')) {
                    encontrados++;
                    log(`‚úÖ Bot√≥n encontrado: onclick="${btn.getAttribute('onclick')}"`);
                }
            });
            log(`Total botones "Nueva Solicitud": ${encontrados}`);
            
            log('\n‚úÖ Diagn√≥stico completado');
        }

        function probarToken() {
            log('üîë Verificando token...');
            const token = localStorage.getItem('empleado_token');
            
            if (!token) {
                log('‚ùå No hay token. Necesitas hacer login primero.');
                return;
            }
            
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                log(`‚úÖ Token decodificado:`);
                log(`   ID: ${payload.id}`);
                log(`   Nombre: ${payload.nombre}`);
                log(`   Expiraci√≥n: ${new Date(payload.exp * 1000).toLocaleString()}`);
                log(`   ¬øV√°lido?: ${payload.exp > Date.now()/1000 ? '‚úÖ S√ç' : '‚ùå EXPIRADO'}`);
            } catch (error) {
                log('‚ùå Error decodificando token: ' + error.message);
            }
        }

        function probarEndpoint() {
            log('üåê Probando endpoint /api/solicitudes-empleado/tipos-permisos...');
            const token = localStorage.getItem('empleado_token');
            
            if (!token) {
                log('‚ùå No hay token para la prueba');
                return;
            }
            
            fetch('/api/solicitudes-empleado/tipos-permisos', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                log(`üì° Response status: ${response.status} ${response.ok ? '‚úÖ' : '‚ùå'}`);
                return response.json();
            })
            .then(data => {
                log(`‚úÖ Tipos de permisos obtenidos: ${data.length}`);
                data.forEach((tipo, i) => {
                    log(`   ${i+1}. ${tipo.nombre} (${tipo.codigo})`);
                });
            })
            .catch(error => {
                log('‚ùå Error en endpoint: ' + error.message);
            });
        }

        // Prueba del bot√≥n
        document.getElementById('btnPrueba').addEventListener('click', function() {
            log('üñ±Ô∏è ¬°Bot√≥n de prueba clickeado correctamente!');
            
            // Intentar ejecutar la funci√≥n si existe
            if (typeof window.empleadoSystem !== 'undefined' && 
                typeof window.empleadoSystem.mostrarSolicitudPermiso === 'function') {
                try {
                    log('üöÄ Ejecutando empleadoSystem.mostrarSolicitudPermiso()...');
                    window.empleadoSystem.mostrarSolicitudPermiso();
                    log('‚úÖ Funci√≥n ejecutada exitosamente');
                } catch (error) {
                    log('‚ùå Error ejecutando funci√≥n: ' + error.message);
                }
            } else {
                log('‚ùå empleadoSystem no disponible para prueba');
            }
        });

        // Ejecutar diagn√≥stico autom√°tico al cargar
        window.addEventListener('load', function() {
            setTimeout(() => {
                log('üèÅ P√°gina cargada. Ejecutando diagn√≥stico inicial...\n');
                ejecutarDiagnostico();
            }, 1000);
        });
    </script>
</body>
</html>