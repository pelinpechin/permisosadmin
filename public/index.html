<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Sistema de Permisos Administrativos v2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --dark-color: #34495e;
            --light-gray: #ecf0f1;
            --border-radius: 12px;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .main-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            box-shadow: 0 25px 45px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dashboard-container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-radius: var(--border-radius);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            min-height: 90vh;
        }

        .brand-logo {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
        }

        .institution-logo {
            max-width: 100px;
            height: auto;
            margin-bottom: 15px;
        }

        .institution-name {
            color: var(--secondary-color);
            font-weight: bold;
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .sidebar .institution-logo {
            max-width: 60px;
            margin-bottom: 10px;
        }

        .sidebar .institution-name {
            color: white;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .btn-custom {
            border-radius: 8px;
            padding: 12px 30px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .sidebar {
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--dark-color) 100%);
            min-height: 100vh;
            color: white;
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            margin: 5px 0;
            transition: all 0.3s ease;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateX(5px);
        }

        .card-custom {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card-custom:hover {
            transform: translateY(-5px);
        }

        .stat-card {
            background: linear-gradient(135deg, var(--secondary-color), #5dade2);
            color: white;
            border-radius: var(--border-radius);
        }

        .stat-card.success {
            background: linear-gradient(135deg, var(--success-color), #58d68d);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, var(--warning-color), #f7dc6f);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, var(--danger-color), #ec7063);
        }

        .form-control:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .table-modern {
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .table-modern thead {
            background: var(--primary-color);
            color: white;
        }

        /* Ancho mínimo para columna de fecha */
        .table th:nth-child(5),
        .table td:nth-child(5) {
            min-width: 140px;
            white-space: nowrap;
        }

        .badge-custom {
            border-radius: 15px;
            padding: 8px 12px;
            font-weight: 600;
        }

        .notification-badge {
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            min-width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1040;
        }

        .spinner-custom {
            width: 60px;
            height: 60px;
            border: 6px solid var(--light-gray);
            border-top: 6px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -250px;
                width: 250px;
                z-index: 1000;
                transition: left 0.3s ease;
            }

            .sidebar.show {
                left: 0;
            }

            .main-content {
                margin-left: 0 !important;
            }
        }

        /* Custom animations */
        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(52, 152, 219, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
        }

        /* Fix for modal input interaction issues */
        .modal .form-control {
            pointer-events: auto !important;
            z-index: 1060 !important;
            position: relative !important;
            background-color: #fff !important;
            border: 1px solid #ced4da !important;
            opacity: 1 !important;
            cursor: text !important;
        }

        .modal .form-control:focus {
            background-color: #fff !important;
            border-color: #86b7fe !important;
            outline: 0 !important;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
        }

        .modal .form-control:hover {
            background-color: #fff !important;
            cursor: text !important;
        }

        /* Ensure modal content is interactive */
        .modal-content {
            z-index: 1055 !important;
            position: relative !important;
        }

        .modal-body {
            z-index: 1056 !important;
            position: relative !important;
        }

        /* Force inputs to be clickable */
        .modal input, .modal select, .modal textarea {
            pointer-events: auto !important;
            user-select: auto !important;
            -webkit-user-select: auto !important;
            -moz-user-select: auto !important;
            -ms-user-select: auto !important;
        }

        /* Ensure modal is above backdrop */
        .modal {
            z-index: 1056 !important;
        }

        .modal-backdrop {
            z-index: 1055 !important;
        }

        .modal-dialog {
            z-index: 1057 !important;
            position: relative !important;
        }

        /* Ensure modal is focusable and interactive */
        .modal.show {
            pointer-events: auto !important;
        }

        .modal.show .modal-dialog {
            pointer-events: auto !important;
        }
    </style>

    <!-- Moment.js y Moment Timezone para manejo de fechas -->
    <script src="/js/moment.min.js"></script>
    <script src="/js/moment-timezone.min.js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="text-center">
            <div class="spinner-custom"></div>
            <p class="mt-3 text-muted">Cargando...</p>
        </div>
    </div>

    <!-- Modal para agregar/editar empleado - FIJO en el body -->
    <div class="modal fade" id="employeeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="employeeModalTitle">Agregar Nuevo Empleado</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="employeeForm">
                        <div class="mb-3">
                            <label for="employeeRut" class="form-label">RUT <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="employeeRut" placeholder="12345678-9" required>
                        </div>
                        <div class="mb-3">
                            <label for="employeeNombre" class="form-label">Nombre Completo <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="employeeNombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="employeeFechaNacimiento" class="form-label">Fecha de Nacimiento</label>
                            <input type="date" class="form-control" id="employeeFechaNacimiento">
                        </div>
                        <div class="mb-3">
                            <label for="employeeCargo" class="form-label">Cargo <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="employeeCargo" required>
                        </div>
                        <div class="mb-3">
                            <label for="employeeVisualizacion" class="form-label">Supervisor</label>
                            <select class="form-select" id="employeeVisualizacion">
                                <option value="">Seleccionar supervisor</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="employeeAutorizacion" class="form-label">Autorizador</label>
                            <select class="form-select" id="employeeAutorizacion">
                                <option value="">Seleccionar autorizador</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="employeeNegociacionColectiva">
                                <label class="form-check-label" for="employeeNegociacionColectiva">
                                    Pertenece a Negociación Colectiva
                                </label>
                            </div>
                        </div>
                        <!-- Campos ocultos con valores por defecto -->
                        <input type="hidden" id="employeeNumero" value="0">
                        <input type="hidden" id="employeeUsoPrimerSemestre" value="0">
                        <input type="hidden" id="employeeUsoSegundoSemestre" value="0">
                        <input type="hidden" id="employeeSinGoce" value="0">
                        <input type="hidden" id="employeeBeneficioLicencia" value="0">
                        <input type="hidden" id="employeeLicenciasTotal" value="0">
                        <input type="hidden" id="employeeAtrasos" value="0">
                        <input type="hidden" id="employeeAtrasosJustificados" value="0">
                        <input type="hidden" id="employeeNoMarcaciones" value="0">
                        <input type="hidden" id="employeeActivo" value="1">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveEmployeeBtn">
                        <i class="fas fa-save me-2"></i>Guardar Empleado
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Anulación -->
    <div class="modal fade" id="anulacionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="fas fa-ban me-2"></i>Anular Permiso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="formAnulacion" onsubmit="anularPermiso(event)">
                    <div class="modal-body">
                        <input type="hidden" id="anulacionPermisoId">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>¿Está seguro que desea anular este permiso?</strong>
                            <p class="mb-0 mt-2">
                                Empleado: <strong id="anulacionEmpleadoNombre"></strong><br>
                                Fecha: <strong id="anulacionFecha"></strong>
                            </p>
                        </div>
                        <div class="mb-3">
                            <label for="motivoAnulacion" class="form-label">Motivo de la anulación <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="motivoAnulacion" rows="4"
                                    placeholder="Ingrese el motivo por el cual se anula este permiso..." required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-ban me-2"></i>Anular Permiso
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Login Section -->
    <div id="loginSection" class="main-container">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6 col-xl-5">
                    <div class="card login-card animate__animated animate__fadeInUp">
                        <div class="card-body p-5">
                            <div class="text-center mb-4">
                                <img src="logo.jpg" alt="Logo Liceo Experimental" class="institution-logo">
                                <h3 class="institution-name">LICEO EXPERIMENTAL</h3>
                                <h2 class="brand-logo">Sistema de Permisos</h2>
                                <p class="text-muted">Gestión Administrativa Avanzada</p>
                            </div>

                            <form id="loginForm">
                                <div class="mb-4">
                                    <label for="username" class="form-label">
                                        <i class="fas fa-user me-2"></i>Usuario o RUT
                                    </label>
                                    <input type="text" class="form-control form-control-lg"
                                           id="username" name="username" required
                                           placeholder="Admin: usuario | Empleado: RUT (12.345.678-9)">
                                </div>

                                <div class="mb-4">
                                    <label for="password" class="form-label">
                                        <i class="fas fa-lock me-2"></i>Contraseña
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control form-control-lg"
                                               id="password" name="password" required
                                               placeholder="Ingrese su contraseña">
                                        <button class="btn btn-outline-secondary" type="button"
                                                onclick="togglePassword()">
                                            <i class="fas fa-eye" id="passwordToggle"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox"
                                               id="rememberMe" name="rememberMe">
                                        <label class="form-check-label" for="rememberMe">
                                            Recordar sesión
                                        </label>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary btn-lg btn-custom w-100 pulse-animation">
                                    <i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesión
                                </button>
                            </form>

                            <div class="text-center mt-4">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Usuario por defecto: <strong>admin</strong> / <strong>admin123</strong>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboardSection" class="d-none">
        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-md-3 col-lg-2 sidebar p-0">
                    <div class="p-3">
                        <div class="text-center mb-4">
                            <img src="logo.jpg" alt="Logo Liceo Experimental" class="institution-logo">
                            <div class="institution-name">LICEO EXPERIMENTAL</div>
                            <h5 class="brand-logo text-white">Permisos Admin</h5>
                        </div>

                        <!-- User Info -->
                        <div class="card bg-transparent border-light mb-3">
                            <div class="card-body p-3 text-center">
                                <div class="mb-2">
                                    <i class="fas fa-user-circle fa-2x text-white"></i>
                                </div>
                                <h6 class="text-white mb-1" id="userDisplayName">Usuario</h6>
                            </div>
                        </div>

                        <!-- Navigation -->
                        <nav class="nav flex-column">
                            <a class="nav-link active" href="#" data-section="dashboard">
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                            </a>
                            <a class="nav-link" href="#" data-section="solicitudes">
                                <i class="fas fa-file-alt me-2"></i>Mis Solicitudes
                            </a>
                            <a class="nav-link" href="#" data-section="nueva-solicitud">
                                <i class="fas fa-plus-circle me-2"></i>Nueva Solicitud
                            </a>
                            <a class="nav-link" href="#" data-section="empleados" id="empleadosLink">
                                <i class="fas fa-users me-2"></i>Empleados
                            </a>
                            <a class="nav-link" href="#" data-section="anulaciones" id="anulacionesLink">
                                <i class="fas fa-ban me-2"></i>Anulaciones
                            </a>
                            <a class="nav-link" href="#" data-section="calendario" id="calendarioLink">
                                <i class="fas fa-calendar-alt me-2"></i>Calendario Equipo
                            </a>
                            <a class="nav-link" href="#" data-section="reportes" id="reportesLink">
                                <i class="fas fa-chart-bar me-2"></i>Reportes
                            </a>
                            <a class="nav-link" href="#" data-section="configuracion" id="configLink">
                                <i class="fas fa-cog me-2"></i>Configuración
                            </a>
                            <hr class="my-3">
                            <a class="nav-link" href="#" id="logoutLink">
                                <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión
                            </a>
                        </nav>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-md-9 col-lg-10 main-content">
                    <div class="dashboard-container p-4 m-3">
                        <!-- Header -->
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h1 class="h3 mb-0" id="pageTitle">Dashboard</h1>
                                <p class="text-muted mb-0" id="pageSubtitle">Panel de control principal</p>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="dropdown me-3">
                                    <button class="btn btn-outline-primary dropdown-toggle" type="button"
                                            id="notificationsDropdown" data-bs-toggle="dropdown">
                                        <i class="fas fa-bell"></i>
                                        <span class="notification-badge ms-1 d-none" id="notificationCount">0</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" style="width: 300px;">
                                        <li><h6 class="dropdown-header">Notificaciones</h6></li>
                                        <div id="notificationsList">
                                            <li><span class="dropdown-item-text text-muted">No hay notificaciones</span></li>
                                        </div>
                                    </ul>
                                </div>
                                <button class="btn btn-outline-secondary d-md-none" onclick="toggleSidebar()">
                                    <i class="fas fa-bars"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Content Sections -->
                        <div id="content">
                            <!-- Dashboard Content -->
                            <div id="dashboardContent" class="fade-in">
                                <!-- Stats Cards -->
                                <div class="row mb-4">
                                    <div class="col-lg-3 col-md-6 mb-3">
                                        <div class="card stat-card h-100">
                                            <div class="card-body text-center">
                                                <i class="fas fa-file-alt fa-2x mb-3"></i>
                                                <h3 id="totalSolicitudes">0</h3>
                                                <p class="mb-0">Total Solicitudes</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 mb-3">
                                        <div class="card stat-card success h-100">
                                            <div class="card-body text-center">
                                                <i class="fas fa-check-circle fa-2x mb-3"></i>
                                                <h3 id="solicitudesAprobadas">0</h3>
                                                <p class="mb-0">Aprobadas</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 mb-3">
                                        <div class="card stat-card warning h-100">
                                            <div class="card-body text-center">
                                                <i class="fas fa-clock fa-2x mb-3"></i>
                                                <h3 id="solicitudesPendientes">0</h3>
                                                <p class="mb-0">Pendientes</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 mb-3">
                                        <div class="card stat-card danger h-100">
                                            <div class="card-body text-center">
                                                <i class="fas fa-times-circle fa-2x mb-3"></i>
                                                <h3 id="solicitudesRechazadas">0</h3>
                                                <p class="mb-0">Rechazadas</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Filtros de Búsqueda (solo para admin) -->
                                <div class="row mb-4" id="adminFilters" style="display: none;">
                                    <div class="col-12">
                                        <div class="card card-custom">
                                            <div class="card-header">
                                                <h5 class="mb-0">
                                                    <i class="fas fa-filter me-2"></i>Filtros de Búsqueda
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row g-3">
                                                    <div class="col-md-3">
                                                        <label for="filtroEstadoAdmin" class="form-label">Estado</label>
                                                        <select class="form-select" id="filtroEstadoAdmin">
                                                            <option value="">Todos los estados</option>
                                                            <option value="PENDIENTE">Pendientes</option>
                                                            <option value="APROBADO">Aprobadas</option>
                                                            <option value="RECHAZADO">Rechazadas</option>
                                                            <option value="APROBADO_SUPERVISOR">Aprobado por Supervisor</option>
                                                            <option value="ANULADO">Anuladas</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label for="filtroBusquedaAdmin" class="form-label">Buscar Empleado</label>
                                                        <input type="text" class="form-control" id="filtroBusquedaAdmin"
                                                               placeholder="Nombre o RUT del empleado...">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label for="filtroMesAdmin" class="form-label">Mes</label>
                                                        <input type="month" class="form-control" id="filtroMesAdmin">
                                                    </div>
                                                    <div class="col-md-2 d-flex align-items-end">
                                                        <button class="btn btn-primary w-100" onclick="aplicarFiltrosAdmin()">
                                                            <i class="fas fa-search me-1"></i>Buscar
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="row mt-2">
                                                    <div class="col-12">
                                                        <button class="btn btn-outline-secondary btn-sm" onclick="limpiarFiltrosAdmin()">
                                                            <i class="fas fa-eraser me-1"></i>Limpiar Filtros
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tabla de Todas las Solicitudes (solo para admin) -->
                                <div class="row mb-4" id="adminSolicitudesTable" style="display: none;">
                                    <div class="col-12">
                                        <div class="card card-custom">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0">
                                                    <i class="fas fa-list me-2"></i>Todas las Solicitudes
                                                </h5>
                                                <span class="badge bg-primary" id="totalSolicitudesTabla">0</span>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>ID</th>
                                                                <th>Empleado</th>
                                                                <th>RUT</th>
                                                                <th>Tipo</th>
                                                                <th>Fecha</th>
                                                                <th>Estado</th>
                                                                <th>Motivo</th>
                                                                <th>Acciones</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="solicitudesTableBody">
                                                            <tr>
                                                                <td colspan="8" class="text-center">
                                                                    <p class="text-muted">Cargando solicitudes...</p>
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Recent Activity -->
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card card-custom">
                                            <div class="card-header">
                                                <h5 class="mb-0">
                                                    <i class="fas fa-history me-2"></i>Actividad Reciente
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div id="recentActivity">
                                                    <p class="text-muted">Cargando actividad reciente...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Other content sections will be loaded dynamically -->
                            <div id="dynamicContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JavaScript -->
    <script>
        // Global variables
        let currentUser = null;
        let authToken = null;
        let currentSection = 'dashboard';
        let editingEmployeeId = null;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            setupEventListeners();
            // loadSystemTimezone(); // Comentado - ya no es necesario
        });

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        }

        // Authentication functions
        async function handleLogin(e) {
            e.preventDefault();
            showLoading(true);

            const formData = new FormData(e.target);
            const username = formData.get('username');
            const password = formData.get('password');

            try {
                // Primero intentar login como administrador
                let response = await fetch('/api/auth/login/admin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                let data = await response.json();

                // Si login de admin es exitoso
                if (response.ok && data.success) {
                    authToken = data.data.token;
                    currentUser = data.data.user;

                    // Store in localStorage if remember me is checked
                    if (document.getElementById('rememberMe').checked) {
                        localStorage.setItem('authToken', authToken);
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }

                    showDashboard();
                    showNotification('Bienvenido Administrador', 'success');
                } else {
                    // Si falla admin, intentar login como empleado
                    console.log('Login admin falló, intentando como empleado...');

                    response = await fetch('/api/empleados-auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            rut: username,  // El username puede ser el RUT
                            password: password
                        })
                    });

                    data = await response.json();

                    if (response.ok && data.success) {
                        // Login de empleado exitoso
                        // Guardar con las claves que espera el portal de empleados
                        localStorage.setItem('auth_token', data.token);
                        localStorage.setItem('user_data', JSON.stringify(data.empleado));

                        // También guardar con las claves del portal completo
                        localStorage.setItem('empleadoToken', data.token);
                        localStorage.setItem('empleadoData', JSON.stringify(data.empleado));

                        showNotification('Bienvenido ' + data.empleado.nombre, 'success');

                        // Redirigir al portal de empleados
                        setTimeout(() => {
                            window.location.href = '/portal_empleado_completo.html';
                        }, 1000);
                    } else {
                        showNotification(data.error || data.message || 'Usuario o contraseña incorrectos', 'error');
                    }
                }
            } catch (error) {
                console.error('Error en login:', error);
                showNotification('Error de conexión', 'error');
            } finally {
                showLoading(false);
            }
        }

        function checkAuthStatus() {
            const storedToken = localStorage.getItem('authToken');
            const storedUser = localStorage.getItem('currentUser');

            if (storedToken && storedUser) {
                authToken = storedToken;
                currentUser = JSON.parse(storedUser);

                // Verify token is still valid
                verifyToken().then(valid => {
                    if (valid) {
                        showDashboard();
                    } else {
                        clearAuth();
                        showLogin();
                    }
                });
            } else {
                showLogin();
            }
        }

        async function verifyToken() {
            try {
                const response = await fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        function logout() {
            clearAuth();
            showLogin();
            showNotification('Sesión cerrada correctamente', 'info');
        }

        function clearAuth() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
        }

        // UI Functions
        function showLogin() {
            document.getElementById('loginSection').classList.remove('d-none');
            document.getElementById('dashboardSection').classList.add('d-none');
        }

        function showDashboard() {
            document.getElementById('loginSection').classList.add('d-none');
            document.getElementById('dashboardSection').classList.remove('d-none');

            updateUserInfo();
            loadDashboardData();
            setupUserPermissions();
        }

        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('userDisplayName').textContent = currentUser.nombreCompleto || currentUser.username;
            }
        }

        function setupUserPermissions() {
            // Show/hide menu items based on user role
            const empleadosLink = document.getElementById('empleadosLink');
            const anulacionesLink = document.getElementById('anulacionesLink');
            const calendarioLink = document.getElementById('calendarioLink');
            const reportesLink = document.getElementById('reportesLink');
            const configLink = document.getElementById('configLink');

            // Primero mostrar todos los elementos (reset)
            if (empleadosLink) empleadosLink.classList.remove('d-none');
            if (anulacionesLink) anulacionesLink.classList.remove('d-none');
            if (calendarioLink) calendarioLink.classList.remove('d-none');
            if (reportesLink) reportesLink.classList.remove('d-none');
            if (configLink) configLink.classList.remove('d-none');

            if (currentUser.rol === 'empleado') {
                // Empleados solo ven solicitudes
                if (empleadosLink) empleadosLink.classList.add('d-none');
                if (calendarioLink) calendarioLink.classList.add('d-none');
                if (reportesLink) reportesLink.classList.add('d-none');
                if (configLink) configLink.classList.add('d-none');
                if (anulacionesLink) anulacionesLink.classList.add('d-none');
            } else if (currentUser.rol === 'supervisor') {
                // Supervisores pueden aprobar y ver calendario del equipo
                if (empleadosLink) empleadosLink.classList.add('d-none');
                if (reportesLink) reportesLink.classList.add('d-none');
                if (configLink) configLink.classList.add('d-none');
                if (anulacionesLink) anulacionesLink.classList.add('d-none');
                // Los supervisores pueden ver calendario
            } else if (currentUser.rol === 'admin' || currentUser.rol === 'SUPER_ADMIN' || currentUser.rol === 'administrador') {
                // Administradores pueden ver todo excepto solicitar permisos
                console.log('Usuario admin: mostrando todas las opciones del menú');

                // Ocultar opciones de solicitudes (admin no pide permisos)
                const solicitudesLink = document.querySelector('[data-section="solicitudes"]');
                const nuevaSolicitudLink = document.querySelector('[data-section="nueva-solicitud"]');
                if (solicitudesLink) solicitudesLink.classList.add('d-none');
                if (nuevaSolicitudLink) nuevaSolicitudLink.classList.add('d-none');

                // Mostrar filtros y tabla de solicitudes para admin
                const adminFilters = document.getElementById('adminFilters');
                const adminTable = document.getElementById('adminSolicitudesTable');
                if (adminFilters) adminFilters.style.display = 'block';
                if (adminTable) adminTable.style.display = 'block';

                // Cargar todas las solicitudes en la tabla
                loadAllSolicitudesAdmin();
            }
        }

        async function loadDashboardData() {
            try {
                showLoading(true);

                // Load statistics
                await loadStatistics();

                // Load recent activity
                await loadRecentActivity();

                // Load notifications
                await loadNotifications();

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showNotification('Error cargando datos del dashboard', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadStatistics() {
            try {
                let response;

                // Usar endpoint apropiado según el rol del usuario
                if (currentUser.rol === 'empleado') {
                    response = await apiRequest('/api/mis-solicitudes');
                } else if (currentUser.rol === 'admin' || currentUser.rol === 'SUPER_ADMIN' || currentUser.rol === 'administrador') {
                    // Admin ve TODOS los permisos de TODOS los empleados
                    response = await apiRequest('/api/solicitudes-empleado/admin/todas');
                } else {
                    response = await apiRequest('/api/solicitudes?limit=1000');
                }

                const solicitudes = response.solicitudes || [];

                // Normalizar estados (mayúsculas vs minúsculas)
                document.getElementById('totalSolicitudes').textContent = solicitudes.length;
                document.getElementById('solicitudesAprobadas').textContent =
                    solicitudes.filter(s => s.estado && (s.estado.toLowerCase() === 'aprobado' || s.estado.toLowerCase() === 'aprobada')).length;
                document.getElementById('solicitudesPendientes').textContent =
                    solicitudes.filter(s => s.estado && (s.estado.toLowerCase() === 'pendiente' || s.estado.toLowerCase() === 'pendiente_nivel_2' || s.estado.toLowerCase() === 'aprobado_supervisor')).length;
                document.getElementById('solicitudesRechazadas').textContent =
                    solicitudes.filter(s => s.estado && (s.estado.toLowerCase() === 'rechazado' || s.estado.toLowerCase() === 'rechazada')).length;
            } catch (error) {
                console.error('Error loading statistics:', error);
                // Si hay error, mostrar 0 en todas las estadísticas
                document.getElementById('totalSolicitudes').textContent = '0';
                document.getElementById('solicitudesAprobadas').textContent = '0';
                document.getElementById('solicitudesPendientes').textContent = '0';
                document.getElementById('solicitudesRechazadas').textContent = '0';
            }
        }

        async function loadRecentActivity() {
            try {
                let response;

                // Usar endpoint apropiado según el rol del usuario
                if (currentUser.rol === 'empleado') {
                    response = await apiRequest('/api/mis-solicitudes');
                } else if (currentUser.rol === 'admin' || currentUser.rol === 'SUPER_ADMIN' || currentUser.rol === 'administrador') {
                    // Admin ve TODOS los permisos de TODOS los empleados
                    response = await apiRequest('/api/solicitudes-empleado/admin/todas');
                } else {
                    response = await apiRequest('/api/solicitudes?limit=5');
                }

                const solicitudes = (response.solicitudes || []).slice(0, 5); // Limitar a 5 para actividad reciente

                const activityHtml = solicitudes.map(solicitud => `
                    <div class="d-flex align-items-center mb-3">
                        <div class="me-3">
                            <i class="fas fa-file-alt text-primary"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${solicitud.tipo_nombre || solicitud.tipo_permiso_nombre || 'Permiso'}</h6>
                            <p class="mb-0 text-muted small">
                                ${solicitud.empleado_nombre || 'Tu solicitud'} - ${formatDateTime(solicitud.created_at)}
                            </p>
                        </div>
                        <div>
                            <span class="badge bg-${getStatusColor(solicitud.estado)}">${getStatusText(solicitud.estado)}</span>
                        </div>
                    </div>
                `).join('');

                document.getElementById('recentActivity').innerHTML = activityHtml ||
                    '<p class="text-muted">No hay actividad reciente</p>';
            } catch (error) {
                console.error('Error loading recent activity:', error);
                document.getElementById('recentActivity').innerHTML = '<p class="text-muted">Error cargando actividad</p>';
            }
        }

        async function loadNotifications() {
            try {
                // Admin no tiene notificaciones
                if (currentUser && (currentUser.rol === 'admin' || currentUser.rol === 'SUPER_ADMIN' || currentUser.rol === 'administrador')) {
                    const notifList = document.getElementById('notificationsList');
                    if (notifList) {
                        notifList.innerHTML = '<li><span class="dropdown-item-text text-muted">No hay notificaciones</span></li>';
                    }
                    return;
                }

                const response = await apiRequest('/api/notificaciones');
                const notificaciones = response.notificaciones || [];

                const unread = notificaciones.filter(n => !n.leida);

                if (unread.length > 0) {
                    document.getElementById('notificationCount').textContent = unread.length;
                    document.getElementById('notificationCount').classList.remove('d-none');
                }

                const notificationsHtml = notificaciones.slice(0, 5).map(notif => `
                    <li>
                        <a class="dropdown-item ${!notif.leida ? 'fw-bold' : ''}" href="#"
                           onclick="markNotificationRead(${notif.id})">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-bell text-primary me-2 mt-1"></i>
                                <div>
                                    <h6 class="mb-1">${notif.titulo}</h6>
                                    <p class="mb-0 small text-muted">${notif.mensaje}</p>
                                    <small class="text-muted">${formatDate(notif.created_at)}</small>
                                </div>
                            </div>
                        </a>
                    </li>
                `).join('');

                document.getElementById('notificationsList').innerHTML = notificationsHtml ||
                    '<li><span class="dropdown-item-text text-muted">No hay notificaciones</span></li>';
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        // Section navigation
        function showSection(section) {
            currentSection = section;

            // Update active nav link
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update page title
            const titles = {
                'dashboard': { title: 'Dashboard', subtitle: 'Panel de control principal' },
                'solicitudes': { title: 'Mis Solicitudes', subtitle: 'Gestión de solicitudes de permisos' },
                'nueva-solicitud': { title: 'Nueva Solicitud', subtitle: 'Crear nueva solicitud de permiso' },
                'empleados': { title: 'Empleados', subtitle: 'Gestión de empleados y usuarios' },
                'anulaciones': { title: 'Anulaciones', subtitle: 'Historial de permisos anulados' },
                'calendario': { title: 'Calendario del Equipo', subtitle: 'Permisos y ausencias del equipo' },
                'reportes': { title: 'Reportes', subtitle: 'Informes y estadísticas' },
                'configuracion': { title: 'Configuración', subtitle: 'Configuración del sistema' }
            };

            const titleInfo = titles[section] || { title: 'Sistema', subtitle: 'Gestión de permisos' };
            document.getElementById('pageTitle').textContent = titleInfo.title;
            document.getElementById('pageSubtitle').textContent = titleInfo.subtitle;

            // Load section content
            loadSectionContent(section);
        }

        async function loadSectionContent(section) {
            const dynamicContent = document.getElementById('dynamicContent');
            const dashboardContent = document.getElementById('dashboardContent');

            if (section === 'dashboard') {
                dashboardContent.classList.remove('d-none');
                dynamicContent.innerHTML = '';
                await loadDashboardData();
            } else {
                dashboardContent.classList.add('d-none');

                showLoading(true);

                try {
                    let content = '';

                    switch (section) {
                        case 'solicitudes':
                            content = await generateSolicitudesContent();
                            break;
                        case 'nueva-solicitud':
                            content = await generateNuevaSolicitudContent();
                            break;
                        case 'empleados':
                            content = await generateEmpleadosContent();
                            break;
                        case 'anulaciones':
                            content = await generateAnulacionesContent();
                            break;
                        case 'calendario':
                            content = await generateCalendarioContent();
                            break;
                        case 'reportes':
                            content = await generateReportesContent();
                            break;
                        case 'configuracion':
                            content = await generateConfiguracionContent();
                            break;
                        default:
                            content = '<div class="alert alert-info">Sección en desarrollo</div>';
                    }

                    dynamicContent.innerHTML = content;

                    // Reinitialize any new components
                    initializeSectionComponents(section);

                } catch (error) {
                    console.error('Error loading section content:', error);
                    dynamicContent.innerHTML = '<div class="alert alert-danger">Error cargando contenido</div>';
                } finally {
                    showLoading(false);
                }
            }
        }

        // Utility functions
        async function apiRequest(url, options = {}) {
            const defaultHeaders = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            };

            // Merge headers correctly
            const mergedOptions = {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...(options.headers || {})
                }
            };

            const response = await fetch(url, mergedOptions);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return await response.json();
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('d-none');
            } else {
                overlay.classList.add('d-none');
            }
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible position-fixed`;
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.style.minWidth = '300px';

            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(notification);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Timezone utilities
        let systemTimezone = 'America/Santiago'; // Default

        // Configurar moment.js en español
        if (typeof moment !== 'undefined') {
            moment.locale('es', {
                months: 'Enero_Febrero_Marzo_Abril_Mayo_Junio_Julio_Agosto_Septiembre_Octubre_Noviembre_Diciembre'.split('_'),
                monthsShort: 'Ene_Feb_Mar_Abr_May_Jun_Jul_Ago_Sep_Oct_Nov_Dic'.split('_'),
                weekdays: 'Domingo_Lunes_Martes_Miércoles_Jueves_Viernes_Sábado'.split('_'),
                weekdaysShort: 'Dom_Lun_Mar_Mié_Jue_Vie_Sáb'.split('_'),
                weekdaysMin: 'Do_Lu_Ma_Mi_Ju_Vi_Sá'.split('_')
            });
        }

        // Cargar zona horaria del sistema
        async function loadSystemTimezone() {
            try {
                const response = await apiRequest('/api/configuracion-permisos/configuraciones');
                if (response.success && response.configuraciones.zona_horaria) {
                    systemTimezone = response.configuraciones.zona_horaria.valor;
                    console.log(`Zona horaria del sistema cargada: ${systemTimezone}`);
                }
            } catch (error) {
                console.error('Error cargando zona horaria del sistema:', error);
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '';

            try {
                // Para fechas sin hora (YYYY-MM-DD), solo fecha
                if (dateString && !dateString.includes('T')) {
                    const [year, month, day] = dateString.split('-');
                    return `${day}/${month}/${year}`;
                } else {
                    // Para fechas con hora, formato DD/MM/AAAA HH:MM
                    const [datePart, timePart] = dateString.split('T');
                    const [year, month, day] = datePart.split('-');

                    if (timePart) {
                        const [hours, minutes] = timePart.split(':');
                        return `${day}/${month}/${year} ${hours}:${minutes}`;
                    }
                    return `${day}/${month}/${year}`;
                }
            } catch (error) {
                return dateString;
            }
        }

        function formatDateOnly(dateString) {
            if (!dateString) return '';

            try {
                // Extraer solo la fecha sin hora
                const datePart = dateString.split('T')[0];
                const [year, month, day] = datePart.split('-');
                return `${day}/${month}/${year}`;
            } catch (error) {
                return dateString;
            }
        }

        function getCurrentDateInTimezone() {
            if (typeof moment !== 'undefined') {
                return moment().tz(systemTimezone).format('YYYY-MM-DD');
            } else {
                return new Date().toISOString().split('T')[0];
            }
        }

        function getStatusColor(status) {
            const colors = {
                'pendiente': 'warning',
                'aprobado': 'success',
                'rechazado': 'danger',
                'cancelado': 'secondary',
                'en_revision': 'info'
            };
            return colors[status] || 'secondary';
        }

        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const passwordToggle = document.getElementById('passwordToggle');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                passwordToggle.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                passwordToggle.className = 'fas fa-eye';
            }
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('show');
        }

        async function markNotificationRead(notificationId) {
            try {
                await apiRequest(`/api/notificaciones/${notificationId}/leer`, {
                    method: 'PUT'
                });

                // Reload notifications
                loadNotifications();
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Section content generators
        async function generateSolicitudesContent() {
            try {
                let response;
                let solicitudes = [];
                let titulo = 'Mis Solicitudes';

                // Admin ve TODAS las solicitudes de TODOS los empleados
                if (currentUser && currentUser.rol === 'admin') {
                    response = await apiRequest('/api/solicitudes-empleado/admin/todas');
                    solicitudes = response.solicitudes || [];
                    titulo = 'Todos los Permisos (Todos los Empleados)';
                } else {
                    response = await apiRequest('/api/mis-solicitudes');
                    solicitudes = response.solicitudes || [];
                }

                const isAdmin = currentUser && currentUser.rol === 'admin';

                return `
                    <div class="row">
                        <!-- Botón para nueva solicitud (solo para no-admin) -->
                        ${!isAdmin ? `
                            <div class="col-12 mb-4">
                                <button class="btn btn-primary btn-lg" onclick="showSection('nueva-solicitud')">
                                    <i class="fas fa-plus me-2"></i>Nueva Solicitud de Permiso
                                </button>
                            </div>
                        ` : ''}

                        <!-- Lista de solicitudes -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>${titulo}</h5>
                                    ${isAdmin ? `<small class="text-muted">Total: ${solicitudes.length} solicitudes</small>` : ''}
                                </div>
                                <div class="card-body">
                                    ${solicitudes.length === 0 ?
                                        '<div class="alert alert-info">No hay solicitudes registradas.</div>' :
                                        `<div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        ${isAdmin ? '<th>Empleado</th>' : ''}
                                                        ${isAdmin ? '<th>RUT</th>' : ''}
                                                        <th>Tipo</th>
                                                        <th>Fechas</th>
                                                        <th>Estado</th>
                                                        ${!isAdmin ? '<th>Supervisor</th>' : ''}
                                                        <th>Creada</th>
                                                        <th>Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${solicitudes.map(s => `
                                                        <tr>
                                                            ${isAdmin ? `<td><strong>${s.empleado_nombre || 'N/A'}</strong></td>` : ''}
                                                            ${isAdmin ? `<td>${s.empleado_rut || 'N/A'}</td>` : ''}
                                                            <td>
                                                                <span class="badge bg-info">${s.tipo_nombre || s.tipo_permiso_nombre || 'N/A'}</span>
                                                            </td>
                                                            <td>
                                                                <small>
                                                                    ${formatDate(s.fecha_desde || s.fecha_inicio)} - ${formatDate(s.fecha_hasta || s.fecha_termino)}
                                                                </small>
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-${getStatusColor(s.estado)}">${getStatusText(s.estado)}</span>
                                                            </td>
                                                            ${!isAdmin ? `<td>${s.supervisor_nombre || 'Sin asignar'}</td>` : ''}
                                                            <td>${formatDateTime(s.created_at)}</td>
                                                            <td>
                                                                <button class="btn btn-sm btn-outline-primary" onclick="viewSolicitud(${s.id})">
                                                                    <i class="fas fa-eye"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>`
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error cargando solicitudes:', error);
                return '<div class="alert alert-danger">Error cargando solicitudes</div>';
            }
        }

        async function generateNuevaSolicitudContent() {
            try {
                // Obtener tipos de permisos
                const response = await apiRequest('/api/tipos-permisos');
                const tiposPermisos = response.tipos || [];

                return `
                    <div class="row">
                        <div class="col-12 mb-3">
                            <button class="btn btn-outline-secondary" onclick="showSection('solicitudes')">
                                <i class="fas fa-arrow-left me-2"></i>Volver a Solicitudes
                            </button>
                        </div>

                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-plus me-2"></i>Nueva Solicitud de Permiso</h5>
                                </div>
                                <div class="card-body">
                                    <form id="nuevaSolicitudForm">
                                        <div class="row">
                                            <!-- Tipo de permiso -->
                                            <div class="col-md-8 mb-3">
                                                <label for="tipoPermiso" class="form-label">Tipo de Permiso <span class="text-danger">*</span></label>
                                                <select class="form-select" id="tipoPermiso" name="tipoPermisoId" required>
                                                    <option value="">Seleccionar tipo...</option>
                                                    <optgroup label="Con Goce de Sueldo">
                                                        <option value="1" data-codigo="CON_GOCE_DIA_COMPLETO" style="color: #28a745;">Día Completo</option>
                                                        <option value="2" data-codigo="CON_GOCE_MEDIO_MANANA" style="color: #2e7d32;">Medio Día Mañana</option>
                                                        <option value="3" data-codigo="CON_GOCE_MEDIO_TARDE" style="color: #388e3c;">Medio Día Tarde</option>
                                                    </optgroup>
                                                    <optgroup label="Sin Goce de Sueldo">
                                                        <option value="4" data-codigo="SIN_GOCE_DIA_COMPLETO" style="color: #d32f2f;">Día Completo</option>
                                                        <option value="5" data-codigo="SIN_GOCE_MEDIO_MANANA" style="color: #c62828;">Medio Día Mañana</option>
                                                        <option value="6" data-codigo="SIN_GOCE_MEDIO_TARDE" style="color: #b71c1c;">Medio Día Tarde</option>
                                                    </optgroup>
                                                </select>
                                            </div>

                                            <!-- Fecha del permiso -->
                                            <div class="col-md-4 mb-3">
                                                <label for="fechaPermiso" class="form-label">Fecha del Permiso <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control" id="fechaPermiso" name="fechaPermiso" required>
                                            </div>

                                            <!-- Motivo -->
                                            <div class="col-12 mb-3">
                                                <label for="motivo" class="form-label">Motivo <span class="text-danger">*</span></label>
                                                <textarea class="form-control" id="motivo" name="motivo" rows="3"
                                                          placeholder="Descripción del motivo de la solicitud" required></textarea>
                                            </div>

                                            <!-- Observaciones -->
                                            <div class="col-12 mb-3">
                                                <label for="observaciones" class="form-label">Observaciones (Opcional)</label>
                                                <textarea class="form-control" id="observaciones" name="observaciones" rows="2"
                                                          placeholder="Información adicional o comentarios"></textarea>
                                            </div>

                                            <!-- Información del permiso -->
                                            <div class="col-12 mb-3">
                                                <div class="alert alert-info" id="infoPermiso" style="display: none;">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    <span id="infoPermisoText"></span>
                                                </div>
                                            </div>

                                            <!-- Días calculados -->
                                            <div class="col-12 mb-3">
                                                <div class="alert alert-success" id="diasCalculados" style="display: none;">
                                                    <i class="fas fa-calendar me-2"></i>
                                                    <span id="diasCalculadosText"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-12 text-end">
                                                <button type="button" class="btn btn-secondary me-2" onclick="showSection('solicitudes')">
                                                    Cancelar
                                                </button>
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-save me-2"></i>Enviar Solicitud
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error cargando formulario:', error);
                return '<div class="alert alert-danger">Error cargando formulario de solicitud</div>';
            }
        }

        async function generateEmpleadosContent() {
            try {
                // Obtener lista de empleados
                const response = await apiRequest('/api/empleados');
                const empleados = response.data?.empleados || [];

                return `
                    <div class="row">
                        <!-- Botón para agregar nuevo empleado -->
                        <div class="col-12 mb-4">
                            <button class="btn btn-primary btn-lg" id="addEmployeeBtn">
                                <i class="fas fa-plus me-2"></i>Agregar Nuevo Empleado
                            </button>
                        </div>

                        <!-- Lista de empleados -->
                        <div class="col-12">
                            <div class="card card-custom">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-users me-2"></i>Lista de Empleados
                                    </h5>
                                </div>
                                <div class="card-body">
                                    ${empleados.length === 0 ?
                                        '<div class="alert alert-info">No hay empleados registrados. Comienza agregando el primer empleado.</div>' :
                                        generateEmployeeTable(empleados)
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error generating employees content:', error);
                return '<div class="alert alert-danger">Error cargando gestión de empleados</div>';
            }
        }

        function formatRut(rut) {
            if (!rut) return '';
            // Limpiar el RUT de puntos y guiones
            const cleanRut = rut.replace(/\./g, '').replace(/-/g, '');

            // Separar dígito verificador
            const dv = cleanRut.slice(-1);
            const number = cleanRut.slice(0, -1);

            // Formatear con puntos
            const formattedNumber = number.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

            return `${formattedNumber}-${dv}`;
        }

        function generateEmployeeTable(empleados) {
            return `
                <div class="table-responsive">
                    <table class="table table-modern table-hover">
                        <thead>
                            <tr>
                                <th>RUT</th>
                                <th>Nombre Completo</th>
                                <th>Cargo</th>
                                <th>Supervisor</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${empleados.map(emp => `
                                <tr>
                                    <td>${formatRut(emp.rut)}</td>
                                    <td>${emp.nombre || ''}</td>
                                    <td>${emp.cargo || ''}</td>
                                    <td>${emp.visualizacion || '<span class="text-muted">Sin supervisor</span>'}</td>
                                    <td>
                                        <span class="badge bg-${emp.activo ? 'success' : 'danger'}">
                                            ${emp.activo ? 'Activo' : 'Inactivo'}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" data-action="edit" data-emp-id="${emp.id}" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-info" data-action="view" data-emp-id="${emp.id}" title="Ver detalles">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            ${emp.id !== 1 ? (emp.activo ? `
                                                <button class="btn btn-outline-warning" data-action="deactivate" data-emp-id="${emp.id}" title="Desactivar">
                                                    <i class="fas fa-ban"></i>
                                                </button>
                                            ` : `
                                                <button class="btn btn-outline-danger" data-action="delete-permanent" data-emp-id="${emp.id}" title="Eliminar permanentemente">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            `) : ''}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function generateAnulacionesContent() {
            try {
                // Obtener todas las solicitudes para filtrar las anuladas
                const response = await apiRequest('/api/solicitudes-empleado/admin/todas');
                const todasSolicitudes = response.solicitudes || [];

                // Filtrar solo las anuladas
                const solicitudesAnuladas = todasSolicitudes.filter(s => s.estado === 'ANULADO');

                return `
                    <div class="row">
                        <!-- Header -->
                        <div class="col-12 mb-4">
                            <div class="alert alert-secondary">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Historial de Anulaciones</strong> - Aquí se muestran los permisos que han sido anulados por el administrador.
                            </div>
                        </div>

                        <!-- Filtros -->
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">
                                                <i class="fas fa-search me-1"></i>Buscar por RUT o Nombre
                                            </label>
                                            <input type="text" class="form-control" id="filtroAnulacionesBusqueda"
                                                   placeholder="Ej: 12345678-9 o Juan Pérez"
                                                   onkeyup="filtrarAnulaciones()">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">
                                                <i class="fas fa-calendar me-1"></i>Fecha de Anulación (Desde)
                                            </label>
                                            <input type="date" class="form-control" id="filtroAnulacionesFechaDesde"
                                                   onchange="filtrarAnulaciones()">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">
                                                <i class="fas fa-calendar me-1"></i>Fecha de Anulación (Hasta)
                                            </label>
                                            <input type="date" class="form-control" id="filtroAnulacionesFechaHasta"
                                                   onchange="filtrarAnulaciones()">
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <button class="btn btn-secondary btn-sm" onclick="limpiarFiltrosAnulaciones()">
                                                <i class="fas fa-times me-1"></i>Limpiar Filtros
                                            </button>
                                            <span class="ms-3 text-muted" id="contadorAnulaciones">
                                                Mostrando <strong>${solicitudesAnuladas.length}</strong> de <strong>${solicitudesAnuladas.length}</strong> anulaciones
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Solicitudes anuladas -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-ban me-2"></i>Permisos Anulados
                                        <span class="badge bg-warning ms-2" id="totalAnulaciones">${solicitudesAnuladas.length}</span>
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="contenedorAnulaciones">
                                        ${solicitudesAnuladas.length === 0 ?
                                            '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No hay permisos anulados en el sistema.</div>' :
                                            `<div class="row" id="listaAnulaciones">
                                                ${solicitudesAnuladas.map(s => generarTarjetaAnulacion(s)).join('')}
                                            </div>`
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error cargando anulaciones:', error);
                return '<div class="alert alert-danger">Error cargando historial de anulaciones</div>';
            }
        }

        function generarTarjetaAnulacion(s) {
            return `
                <div class="col-lg-6 mb-4 anulacion-card"
                     data-nombre="${(s.empleado_nombre || '').toLowerCase()}"
                     data-rut="${(s.empleado_rut || '').replace(/[.-]/g, '')}"
                     data-fecha-anulacion="${s.fecha_anulacion || ''}"
                     data-fecha-permiso="${s.fecha_desde || ''}">
                    <div class="card h-100 border-start border-4 border-warning">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">${s.empleado_nombre || 'N/A'}</h6>
                                    <small class="text-muted">${s.empleado_rut || 'N/A'} - ${s.empleado_cargo || 'N/A'}</small>
                                </div>
                                <span class="badge bg-warning">ANULADO</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-6">
                                    <small class="text-muted d-block">Tipo</small>
                                    <strong>${s.tipo_permiso_nombre || s.tipo_nombre || 'N/A'}</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">Período del Permiso</small>
                                    <strong>${formatDate(s.fecha_desde || s.fecha_inicio)}</strong>
                                </div>
                            </div>

                            <div class="alert alert-warning mb-3">
                                <strong><i class="fas fa-ban me-2"></i>Información de Anulación</strong><br>
                                <hr class="my-2">
                                <strong><i class="fas fa-user me-2"></i>Anulado por:</strong> ${s.anulado_por_admin || 'Administrador'}<br>
                                <strong><i class="fas fa-clock me-2"></i>Fecha anulación:</strong> ${s.fecha_anulacion ? formatDateTime(s.fecha_anulacion) : 'No disponible'}<br>
                                <strong><i class="fas fa-comment me-2"></i>Motivo:</strong> ${s.motivo_anulacion || 'Sin motivo especificado'}
                            </div>

                            <div class="mb-3">
                                <small class="text-muted d-block">Solicitud original creada</small>
                                <small>${formatDateTime(s.created_at)}</small>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button onclick="descargarPDFAnulado(${s.id})" class="btn btn-warning btn-sm w-100">
                                <i class="fas fa-file-pdf me-1"></i>Ver PDF con Historial Completo
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function filtrarAnulaciones() {
            const busqueda = document.getElementById('filtroAnulacionesBusqueda')?.value.toLowerCase().replace(/[.-]/g, '') || '';
            const fechaDesde = document.getElementById('filtroAnulacionesFechaDesde')?.value || '';
            const fechaHasta = document.getElementById('filtroAnulacionesFechaHasta')?.value || '';

            const tarjetas = document.querySelectorAll('.anulacion-card');
            let visibles = 0;

            tarjetas.forEach(tarjeta => {
                const nombre = tarjeta.dataset.nombre || '';
                const rut = tarjeta.dataset.rut || '';
                const fechaAnulacion = tarjeta.dataset.fechaAnulacion || '';

                let mostrar = true;

                // Filtro por búsqueda (nombre o RUT)
                if (busqueda) {
                    const coincideNombre = nombre.includes(busqueda);
                    const coincideRut = rut.includes(busqueda);
                    mostrar = mostrar && (coincideNombre || coincideRut);
                }

                // Filtro por fecha desde
                if (fechaDesde && fechaAnulacion) {
                    const fechaAnulacionSolo = fechaAnulacion.split('T')[0];
                    mostrar = mostrar && (fechaAnulacionSolo >= fechaDesde);
                }

                // Filtro por fecha hasta
                if (fechaHasta && fechaAnulacion) {
                    const fechaAnulacionSolo = fechaAnulacion.split('T')[0];
                    mostrar = mostrar && (fechaAnulacionSolo <= fechaHasta);
                }

                tarjeta.style.display = mostrar ? 'block' : 'none';
                if (mostrar) visibles++;
            });

            // Actualizar contador
            const total = tarjetas.length;
            document.getElementById('contadorAnulaciones').innerHTML =
                `Mostrando <strong>${visibles}</strong> de <strong>${total}</strong> anulaciones`;
        }

        function limpiarFiltrosAnulaciones() {
            document.getElementById('filtroAnulacionesBusqueda').value = '';
            document.getElementById('filtroAnulacionesFechaDesde').value = '';
            document.getElementById('filtroAnulacionesFechaHasta').value = '';
            filtrarAnulaciones();
        }

        async function descargarPDFAnulado(solicitudId) {
            try {
                showLoading(true);

                const response = await fetch(`/api/solicitudes-empleado/descargar-pdf/${solicitudId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    showNotification(error.error || 'Error descargando PDF', 'error');
                    showLoading(false);
                    return;
                }

                // Convertir la respuesta a blob
                const blob = await response.blob();

                // Crear URL temporal para el blob
                const url = window.URL.createObjectURL(blob);

                // Abrir en nueva pestaña
                window.open(url, '_blank');

                // Liberar memoria después de un tiempo
                setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                }, 1000);

                showLoading(false);

            } catch (error) {
                console.error('Error descargando PDF:', error);
                showNotification('Error descargando PDF', 'error');
                showLoading(false);
            }
        }

        async function generateCalendarioContent() {
            try {
                const currentDate = new Date();
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1; // JavaScript months are 0-based

                // Obtener permisos del equipo para el mes actual
                const response = await apiRequest(`/api/equipo/permisos?anio=${year}&mes=${month}`);
                const permisos = response.permisos || [];
                const rolUsuario = response.rol || 'empleado';

                // Mensaje según el rol del usuario
                let mensajeCalendario = '';
                if (rolUsuario === 'admin') {
                    mensajeCalendario = '<strong>Calendario del Equipo</strong> - Vista de TODOS los permisos aprobados de la organización.';
                } else if (currentUser.es_supervisor) {
                    mensajeCalendario = '<strong>Calendario del Equipo</strong> - Vista de permisos de tus subordinados.';
                } else {
                    mensajeCalendario = '<strong>Calendario Personal</strong> - Vista de tus permisos aprobados.';
                }

                // Obtener nombre del mes
                const monthNames = [
                    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
                ];

                // Generar calendario
                const calendar = generateCalendarGrid(year, month - 1, permisos);

                return `
                    <div class="row">
                        <!-- Header -->
                        <div class="col-12 mb-4">
                            <div class="alert alert-info">
                                <i class="fas fa-calendar-alt me-2"></i>
                                ${mensajeCalendario}
                                <span class="badge bg-primary ms-2">${permisos.length} permisos en este mes</span>
                            </div>
                        </div>

                        <!-- Calendar Navigation -->
                        <div class="col-12 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <button class="btn btn-outline-primary btn-sm" onclick="navigateCalendar(-1)">
                                            <i class="fas fa-chevron-left me-1"></i>Anterior
                                        </button>
                                        <h5 class="mb-0" id="calendar-title">
                                            <i class="fas fa-calendar me-2"></i>${monthNames[month - 1]} ${year}
                                        </h5>
                                        <button class="btn btn-outline-primary btn-sm" onclick="navigateCalendar(1)">
                                            Siguiente<i class="fas fa-chevron-right ms-1"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Calendar Grid -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <div id="calendar-container">
                                        ${calendar}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Legend -->
                        <div class="col-12 mt-3">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Leyenda</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="calendar-legend-color" style="background-color: #1e7e34;"></div>
                                                <span class="ms-2">Con Goce de Sueldo - Día Completo</span>
                                            </div>
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="calendar-legend-color" style="background-color: #007bff;"></div>
                                                <span class="ms-2">Con Goce de Sueldo - Medio Día Mañana</span>
                                            </div>
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="calendar-legend-color" style="background-color: #6f42c1;"></div>
                                                <span class="ms-2">Con Goce de Sueldo - Medio Día Tarde</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="calendar-legend-color" style="background-color: #dc3545;"></div>
                                                <span class="ms-2">Sin Goce de Sueldo - Día Completo</span>
                                            </div>
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="calendar-legend-color" style="background-color: #fd7e14;"></div>
                                                <span class="ms-2">Sin Goce de Sueldo - Medio Día Mañana</span>
                                            </div>
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="calendar-legend-color" style="background-color: #e83e8c;"></div>
                                                <span class="ms-2">Sin Goce de Sueldo - Medio Día Tarde</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <style>
                        .calendar-grid {
                            display: grid;
                            grid-template-columns: repeat(7, 1fr);
                            gap: 1px;
                            background-color: #dee2e6;
                            border: 1px solid #dee2e6;
                        }

                        .calendar-day {
                            background-color: white;
                            min-height: 100px;
                            padding: 8px;
                            border: none;
                            position: relative;
                        }

                        .calendar-day-header {
                            background-color: #f8f9fa;
                            font-weight: bold;
                            text-align: center;
                            padding: 10px;
                            border: none;
                        }

                        .calendar-day-number {
                            font-weight: bold;
                            margin-bottom: 5px;
                        }

                        .calendar-day.other-month {
                            background-color: #f8f9fa;
                            color: #6c757d;
                        }

                        .calendar-day.today {
                            background-color: #e3f2fd;
                            border: 2px solid #2196f3;
                        }

                        .calendar-permission {
                            font-size: 0.75rem;
                            padding: 2px 4px;
                            margin: 1px 0;
                            border-radius: 3px;
                            color: white;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            white-space: nowrap;
                        }

                        .calendar-legend-color {
                            width: 20px;
                            height: 20px;
                            border-radius: 3px;
                            border: 1px solid #dee2e6;
                            flex-shrink: 0;
                        }
                    </style>
                `;
            } catch (error) {
                console.error('Error cargando calendario:', error);
                return '<div class="alert alert-danger">Error cargando el calendario del equipo</div>';
            }
        }

        async function generateReportesContent() {
            try {
                if (currentUser.rol !== 'admin' && currentUser.rol !== 'SUPER_ADMIN' && currentUser.rol !== 'administrador') {
                    return '<div class="alert alert-danger">Solo administradores pueden acceder a los reportes</div>';
                }

                return `
                    <div class="container-fluid">
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card card-custom">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-file-pdf me-2"></i>Generar Reporte de Solicitudes
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted mb-4">
                                            Genera reportes detallados de las solicitudes de permisos en formato PDF.
                                            Puedes aplicar filtros para personalizar tu reporte.
                                        </p>

                                        <div class="row g-3 mb-4">
                                            <div class="col-md-3">
                                                <label for="reporteFechaInicio" class="form-label">Fecha Inicio</label>
                                                <input type="date" class="form-control" id="reporteFechaInicio">
                                            </div>
                                            <div class="col-md-3">
                                                <label for="reporteFechaFin" class="form-label">Fecha Fin</label>
                                                <input type="date" class="form-control" id="reporteFechaFin">
                                            </div>
                                            <div class="col-md-3">
                                                <label for="reporteEstado" class="form-label">Estado</label>
                                                <select class="form-select" id="reporteEstado">
                                                    <option value="">Todos los estados</option>
                                                    <option value="PENDIENTE">Pendientes</option>
                                                    <option value="APROBADO">Aprobadas</option>
                                                    <option value="RECHAZADO">Rechazadas</option>
                                                    <option value="APROBADO_SUPERVISOR">Aprobado por Supervisor</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="reporteEmpleado" class="form-label">Empleado</label>
                                                <input type="text" class="form-control" id="reporteEmpleado"
                                                       placeholder="Nombre o RUT...">
                                            </div>
                                        </div>

                                        <div class="row mb-4">
                                            <div class="col-md-6">
                                                <label for="reporteTipo" class="form-label">Tipo de Reporte</label>
                                                <select class="form-select" id="reporteTipo">
                                                    <option value="detallado">Reporte Detallado</option>
                                                    <option value="resumen">Reporte Resumen</option>
                                                    <option value="estadisticas">Reporte con Estadísticas</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="reporteOrden" class="form-label">Ordenar por</label>
                                                <select class="form-select" id="reporteOrden">
                                                    <option value="fecha_desc">Fecha (Más reciente primero)</option>
                                                    <option value="fecha_asc">Fecha (Más antigua primero)</option>
                                                    <option value="empleado">Empleado (A-Z)</option>
                                                    <option value="estado">Estado</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="d-flex gap-2">
                                            <button class="btn btn-primary" onclick="generarReportePDF()">
                                                <i class="fas fa-file-pdf me-2"></i>Generar PDF
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="limpiarFiltrosReporte()">
                                                <i class="fas fa-eraser me-2"></i>Limpiar Filtros
                                            </button>
                                            <button class="btn btn-outline-info" onclick="previsualizarReporte()">
                                                <i class="fas fa-eye me-2"></i>Previsualizar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Preview Section -->
                        <div class="row" id="reportePreview" style="display: none;">
                            <div class="col-12">
                                <div class="card card-custom">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="fas fa-eye me-2"></i>Previsualización del Reporte
                                        </h5>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('reportePreview').style.display='none'">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div id="reportePreviewContent">
                                            <p class="text-muted">Cargando previsualización...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Reportes Rápidos -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card card-custom">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-bolt me-2"></i>Reportes Rápidos
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <div class="card h-100 border">
                                                    <div class="card-body text-center">
                                                        <i class="fas fa-calendar-week fa-3x text-primary mb-3"></i>
                                                        <h6>Reporte Semanal</h6>
                                                        <p class="text-muted small">Solicitudes de esta semana</p>
                                                        <button class="btn btn-sm btn-primary" onclick="generarReporteRapido('semanal')">
                                                            <i class="fas fa-download me-1"></i>Descargar
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card h-100 border">
                                                    <div class="card-body text-center">
                                                        <i class="fas fa-calendar-alt fa-3x text-success mb-3"></i>
                                                        <h6>Reporte Mensual</h6>
                                                        <p class="text-muted small">Solicitudes del mes actual</p>
                                                        <button class="btn btn-sm btn-success" onclick="generarReporteRapido('mensual')">
                                                            <i class="fas fa-download me-1"></i>Descargar
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card h-100 border">
                                                    <div class="card-body text-center">
                                                        <i class="fas fa-clock fa-3x text-warning mb-3"></i>
                                                        <h6>Pendientes de Aprobación</h6>
                                                        <p class="text-muted small">Solo solicitudes pendientes</p>
                                                        <button class="btn btn-sm btn-warning" onclick="generarReporteRapido('pendientes')">
                                                            <i class="fas fa-download me-1"></i>Descargar
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error generando contenido de reportes:', error);
                return '<div class="alert alert-danger">Error cargando sección de reportes</div>';
            }
        }

        function generateCalendarGrid(year, month, permisos) {
            const date = new Date(year, month, 1);
            const today = new Date();
            const firstDay = date.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Days of week headers
            const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];

            let calendar = '<div class="calendar-grid">';

            // Add day headers
            dayHeaders.forEach(day => {
                calendar += `<div class="calendar-day-header">${day}</div>`;
            });

            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const prevMonthDay = new Date(year, month, -firstDay + i + 1).getDate();
                calendar += `<div class="calendar-day other-month">
                    <div class="calendar-day-number">${prevMonthDay}</div>
                </div>`;
            }

            // Add days of current month
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const isToday = currentDate.toDateString() === today.toDateString();
                const dayPermissions = permisos.filter(p => {
                    // Obtener fechas del permiso
                    const fechaDesde = p.fecha_desde ? p.fecha_desde.split('T')[0] : null;
                    const fechaHasta = p.fecha_hasta ? p.fecha_hasta.split('T')[0] : fechaDesde;
                    const targetDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                    // Verificar si la fecha actual está en el rango del permiso
                    if (!fechaDesde) return false;

                    // Convertir a objetos Date para comparación
                    const desde = new Date(fechaDesde + 'T00:00:00');
                    const hasta = new Date(fechaHasta + 'T23:59:59');
                    const target = new Date(targetDate + 'T12:00:00');

                    return target >= desde && target <= hasta;
                });

                calendar += `<div class="calendar-day ${isToday ? 'today' : ''}">
                    <div class="calendar-day-number">${day}</div>`;

                // Add permissions for this day
                dayPermissions.forEach(permission => {
                    // Procesar nombre del empleado
                    const nombreCompleto = permission.empleado_nombre || 'N/A';
                    const partesNombre = nombreCompleto.split(' ');
                    const primerNombre = partesNombre[0];
                    const apellidoInicial = partesNombre.length > 2 ? partesNombre[partesNombre.length - 2].charAt(0) : '';
                    const shortName = `${primerNombre} ${apellidoInicial}.`;

                    // Determinar color según tipo de permiso
                    let bgColor = '#6c757d';
                    let duracionTexto = 'Día completo';
                    const tipoCodigo = permission.tipo_codigo || '';
                    const tipoPermiso = permission.tipo_nombre || tipoCodigo;
                    const conGoce = permission.con_goce_sueldo === 1;

                    // Lógica basada en el código del tipo de permiso
                    if (tipoCodigo === 'T') {
                        // Jornada completa
                        duracionTexto = 'Día completo';
                        bgColor = conGoce ? '#1e7e34' : '#dc3545';
                    } else if (tipoCodigo === 'AM') {
                        // Media jornada mañana
                        duracionTexto = 'Medio día (Mañana)';
                        bgColor = conGoce ? '#007bff' : '#fd7e14';
                    } else if (tipoCodigo === 'PM') {
                        // Media jornada tarde
                        duracionTexto = 'Medio día (Tarde)';
                        bgColor = conGoce ? '#6f42c1' : '#e83e8c';
                    } else if (tipoCodigo === 'S') {
                        // Sin goce de sueldo (siempre es día completo)
                        duracionTexto = 'Día completo';
                        bgColor = '#dc3545';
                    } else {
                        // Otros tipos (licencias, etc.)
                        duracionTexto = 'Día completo';
                        bgColor = conGoce ? '#1e7e34' : '#dc3545';
                    }

                    // Construir tooltip con información detallada
                    const tooltipInfo = [
                        nombreCompleto,
                        tipoPermiso,
                        duracionTexto,
                        conGoce ? 'Con goce de sueldo' : 'Sin goce de sueldo'
                    ].join(' - ');

                    calendar += `<div class="calendar-permission"
                                     style="background-color: ${bgColor};"
                                     title="${tooltipInfo}">
                        ${shortName}
                    </div>`;
                });

                calendar += '</div>';
            }

            // Calculate remaining cells needed to complete the grid
            const totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;
            const remainingCells = totalCells - (firstDay + daysInMonth);

            // Add empty cells for days after month ends
            for (let i = 1; i <= remainingCells; i++) {
                calendar += `<div class="calendar-day other-month">
                    <div class="calendar-day-number">${i}</div>
                </div>`;
            }

            calendar += '</div>';
            return calendar;
        }

        let currentCalendarDate = new Date();

        async function navigateCalendar(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);

            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth() + 1;

            try {
                // Obtener permisos para el nuevo mes
                const response = await apiRequest(`/api/equipo/permisos?anio=${year}&mes=${month}`);
                const permisos = response.permisos || [];

                // Actualizar título
                const monthNames = [
                    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
                ];
                document.getElementById('calendar-title').innerHTML =
                    `<i class="fas fa-calendar me-2"></i>${monthNames[month - 1]} ${year}`;

                // Actualizar calendario
                const calendarContainer = document.getElementById('calendar-container');
                if (calendarContainer) {
                    calendarContainer.innerHTML = generateCalendarGrid(year, month - 1, permisos);
                }
            } catch (error) {
                console.error('Error navegando calendario:', error);
                showNotification('Error cargando el calendario', 'error');
            }
        }

        function initializeSectionComponents(section) {
            if (section === 'empleados') {
                setupEmployeeFormHandlers();
                loadSupervisorsForSelect();
            } else if (section === 'nueva-solicitud') {
                initializeSolicitudForm();
            } else if (section === 'configuracion') {
                // loadTimezoneSettings(); // Ya no es necesario - la configuración ahora muestra tabla de empleados
            }
            console.log(`Initializing components for section: ${section}`);
        }

        // Employee management functions
        function setupEmployeeFormHandlers() {
            // Setup create user checkbox handler
            const createUserCheckbox = document.getElementById('createUser');
            const userFields = document.getElementById('userFields');

            if (createUserCheckbox && !createUserCheckbox.hasAttribute('data-handler-set')) {
                createUserCheckbox.setAttribute('data-handler-set', 'true');
                createUserCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        userFields.style.display = 'block';
                    } else {
                        userFields.style.display = 'none';
                    }
                });
            }

            // Setup RUT formatting (only once)
            const rutInput = document.getElementById('employeeRut');
            if (rutInput && !rutInput.hasAttribute('data-handler-set')) {
                rutInput.setAttribute('data-handler-set', 'true');
                rutInput.addEventListener('input', function() {
                    let value = this.value.replace(/[^0-9kK]/g, '');
                    if (value.length > 8) {
                        value = value.slice(0, 8) + '-' + value.slice(8);
                    }
                    this.value = value;
                });
            }

            // Set default date to today for fecha ingreso
            const fechaIngresoInput = document.getElementById('employeeFechaIngreso');
            if (fechaIngresoInput && !fechaIngresoInput.value) {
                fechaIngresoInput.value = new Date().toISOString().split('T')[0];
            }
        }

        async function loadSupervisorsForSelect() {
            try {
                const response = await apiRequest('/api/empleados');
                const empleados = response.empleados || [];

                const supervisorSelect = document.getElementById('employeeSupervisor');
                if (supervisorSelect) {
                    // Clear existing options except first
                    supervisorSelect.innerHTML = '<option value="">Sin supervisor asignado</option>';

                    // Add employees as potential supervisors
                    empleados.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.id;
                        option.textContent = `${emp.nombre} ${emp.apellido_paterno} - ${emp.cargo}`;
                        supervisorSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading supervisors:', error);
            }
        }

        async function showAddEmployeeModal() {
            console.log('showAddEmployeeModal called');

            editingEmployeeId = null;
            document.getElementById('employeeModalTitle').textContent = 'Agregar Nuevo Empleado';
            const form = document.getElementById('employeeForm');
            form.reset();

            // Establecer valores por defecto para todos los campos numéricos
            document.getElementById('employeeUsoPrimerSemestre').value = 0;
            document.getElementById('employeeUsoSegundoSemestre').value = 0;
            document.getElementById('employeeSinGoce').value = 0;
            document.getElementById('employeeBeneficioLicencia').value = 0;
            document.getElementById('employeeLicenciasTotal').value = 0;
            document.getElementById('employeeAtrasos').value = 0;
            document.getElementById('employeeAtrasosJustificados').value = 0;
            document.getElementById('employeeNoMarcaciones').value = 0;
            document.getElementById('employeeActivo').value = 1;
            document.getElementById('employeeNegociacionColectiva').checked = false;

            // Cargar lista de empleados para los selectores de supervisor y autorizador
            await loadEmployeesForSelectors();

            console.log('Form reset with default values, ready to create new employee');
        }

        async function loadEmployeesForSelectors() {
            try {
                const response = await apiRequest('/api/empleados');
                const empleados = response.data?.empleados || [];

                const supervisorSelect = document.getElementById('employeeVisualizacion');
                const autorizadorSelect = document.getElementById('employeeAutorizacion');

                // Limpiar opciones existentes excepto la primera
                supervisorSelect.innerHTML = '<option value="">Seleccionar supervisor</option>';
                autorizadorSelect.innerHTML = '<option value="">Seleccionar autorizador</option>';

                // Agregar empleados como opciones
                empleados.forEach(emp => {
                    const optionSup = document.createElement('option');
                    optionSup.value = emp.nombre;
                    optionSup.textContent = `${emp.nombre} - ${emp.cargo}`;
                    supervisorSelect.appendChild(optionSup);

                    const optionAut = document.createElement('option');
                    optionAut.value = emp.nombre;
                    optionAut.textContent = `${emp.nombre} - ${emp.cargo}`;
                    autorizadorSelect.appendChild(optionAut);
                });

                console.log(`Loaded ${empleados.length} employees for selectors`);
            } catch (error) {
                console.error('Error loading employees for selectors:', error);
            }
        }

        async function saveEmployee() {
            try {
                console.log('saveEmployee called');
                console.log('editingEmployeeId:', editingEmployeeId);
                const form = document.getElementById('employeeForm');

                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                showLoading(true);

                // Recopilar datos del formulario con campos correctos del schema
                // Determine if we are editing or creating
                const isEditing = editingEmployeeId !== null;

                const numeroValue = parseInt(document.getElementById('employeeNumero').value);
                const formData = {
                    rut: document.getElementById('employeeRut').value.trim(),
                    nombre: document.getElementById('employeeNombre').value.trim(),
                    cargo: document.getElementById('employeeCargo').value.trim(),
                    fecha_nacimiento: document.getElementById('employeeFechaNacimiento').value || null,
                    visualizacion: document.getElementById('employeeVisualizacion').value.trim() || null,
                    autorizacion: document.getElementById('employeeAutorizacion').value.trim() || null,
                    uso_primer_semestre: parseFloat(document.getElementById('employeeUsoPrimerSemestre').value) || 0,
                    uso_segundo_semestre: parseFloat(document.getElementById('employeeUsoSegundoSemestre').value) || 0,
                    sin_goce: parseInt(document.getElementById('employeeSinGoce').value) || 0,
                    beneficio_licencia: parseInt(document.getElementById('employeeBeneficioLicencia').value) || 0,
                    licencias_total: parseInt(document.getElementById('employeeLicenciasTotal').value) || 0,
                    atrasos: parseInt(document.getElementById('employeeAtrasos').value) || 0,
                    atrasos_justificados: parseInt(document.getElementById('employeeAtrasosJustificados').value) || 0,
                    no_marcaciones: parseInt(document.getElementById('employeeNoMarcaciones').value) || 0,
                    negociacion_colectiva: document.getElementById('employeeNegociacionColectiva').checked,
                    activo: document.getElementById('employeeActivo').value == 1
                };

                // Solo agregar número si es edición y tiene valor válido
                if (isEditing && numeroValue) {
                    formData.numero = numeroValue;
                }

                console.log('formData:', formData);
                const url = isEditing ? `/api/empleados/${editingEmployeeId}` : '/api/empleados';
                const method = isEditing ? 'PUT' : 'POST';

                console.log('isEditing:', isEditing);
                console.log('url:', url);
                console.log('method:', method);

                const response = await apiRequest(url, {
                    method: method,
                    body: JSON.stringify(formData)
                });

                console.log('Save response:', response);

                if (response.success) {
                    // Mensaje especial para nuevo empleado con la contraseña
                    if (!isEditing) {
                        const employeeData = response.data;
                        showNotification(
                            `Empleado creado exitosamente.\n` +
                            `Número: ${employeeData.numero}\n` +
                            `Contraseña por defecto: ${employeeData.defaultPassword}\n` +
                            `El empleado puede iniciar sesión con su RUT y esta contraseña.`,
                            'success',
                            8000  // Mostrar por más tiempo
                        );
                    } else {
                        showNotification(response.message || 'Empleado actualizado exitosamente', 'success');
                    }

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('employeeModal'));
                    modal.hide();

                    // Reload employees section
                    await loadSectionContent('empleados');
                } else {
                    showNotification(response.message || response.error || 'Error guardando empleado', 'error');
                }

            } catch (error) {
                console.error('Error saving employee:', error);
                showNotification('Error guardando empleado: ' + (error.message || error), 'error');
            } finally {
                showLoading(false);
            }
        }

        async function editEmployee(employeeId) {
            try {
                console.log('editEmployee called with ID:', employeeId);
                showLoading(true);
                editingEmployeeId = employeeId; // Save the ID for updating
                console.log('editingEmployeeId set to:', editingEmployeeId);

                const response = await apiRequest(`/api/empleados/${employeeId}`);
                console.log('API response:', response);
                const empleado = response.data;
                console.log('Empleado data:', empleado);

                if (!empleado) {
                    showNotification('Empleado no encontrado', 'error');
                    showLoading(false);
                    return;
                }

                // Fill form with employee data usando los campos correctos del schema
                document.getElementById('employeeModalTitle').textContent = 'Editar Empleado';

                // Llenar campos básicos
                document.getElementById('employeeNumero').value = empleado.numero || '';
                document.getElementById('employeeRut').value = empleado.rut || '';
                document.getElementById('employeeNombre').value = empleado.nombre || '';
                document.getElementById('employeeCargo').value = empleado.cargo || '';
                document.getElementById('employeeFechaNacimiento').value = empleado.fecha_nacimiento || '';

                // Cargar empleados para los selectores PRIMERO
                await loadEmployeesForSelectors();

                // Luego seleccionar los valores correctos
                document.getElementById('employeeVisualizacion').value = empleado.visualizacion || '';
                document.getElementById('employeeAutorizacion').value = empleado.autorizacion || '';

                // Llenar estadísticas de permisos
                document.getElementById('employeeUsoPrimerSemestre').value = empleado.uso_primer_semestre || 0;
                document.getElementById('employeeUsoSegundoSemestre').value = empleado.uso_segundo_semestre || 0;
                document.getElementById('employeeSinGoce').value = empleado.sin_goce || 0;
                document.getElementById('employeeBeneficioLicencia').value = empleado.beneficio_licencia || 0;
                document.getElementById('employeeLicenciasTotal').value = empleado.licencias_total || 0;

                // Llenar estadísticas de asistencia
                document.getElementById('employeeAtrasos').value = empleado.atrasos || 0;
                document.getElementById('employeeAtrasosJustificados').value = empleado.atrasos_justificados || 0;
                document.getElementById('employeeNoMarcaciones').value = empleado.no_marcaciones || 0;

                // Llenar checkboxes
                document.getElementById('employeeNegociacionColectiva').checked = empleado.negociacion_colectiva === 1 || empleado.negociacion_colectiva === true;
                document.getElementById('employeeActivo').value = (empleado.activo === 1 || empleado.activo === true) ? 1 : 0;

                // Ocultar el loading ANTES de mostrar el modal
                showLoading(false);

                console.log('Form filled, showing modal');
                const modalElement = document.getElementById('employeeModal');

                // Mostrar el modal (ahora está fijo en el body)
                const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
                modal.show();
                console.log('Modal opened for EDIT, employee ID:', employeeId);

            } catch (error) {
                console.error('Error loading employee for edit:', error);
                showNotification('Error cargando datos del empleado: ' + (error.message || error), 'error');
                showLoading(false);
            }
        }

        async function viewEmployee(employeeId) {
            try {
                showLoading(true);

                const response = await apiRequest(`/api/empleados/${employeeId}`);
                const empleado = response.empleado;

                if (!empleado) {
                    showNotification('Empleado no encontrado', 'error');
                    return;
                }

                // Create and show employee details modal
                const detailsHtml = `
                    <div class="modal fade" id="employeeDetailsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Detalles del Empleado</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-primary">Información Personal</h6>
                                            <p><strong>RUT:</strong> ${empleado.rut}</p>
                                            <p><strong>Nombre:</strong> ${empleado.nombre} ${empleado.apellido_paterno} ${empleado.apellido_materno || ''}</p>
                                            <p><strong>Email:</strong> ${empleado.email}</p>
                                            <p><strong>Teléfono:</strong> ${empleado.telefono || 'No especificado'}</p>
                                            <p><strong>Fecha Nacimiento:</strong> ${empleado.fecha_nacimiento ? formatDate(empleado.fecha_nacimiento) : 'No especificado'}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-primary">Información Laboral</h6>
                                            <p><strong>Cargo:</strong> ${empleado.cargo}</p>
                                            <p><strong>Departamento:</strong> ${empleado.departamento}</p>
                                            <p><strong>Área:</strong> ${empleado.area || 'No especificado'}</p>
                                            <p><strong>Fecha Ingreso:</strong> ${formatDate(empleado.fecha_ingreso)}</p>
                                            <p><strong>Supervisor:</strong> ${empleado.supervisor_nombre || 'Sin supervisor'}</p>
                                            <p><strong>Salario:</strong> ${empleado.salario ? '$' + empleado.salario.toLocaleString() : 'No especificado'}</p>
                                            <p><strong>Días Vacaciones:</strong> ${empleado.dias_vacaciones_anuales} días/año</p>
                                        </div>
                                        <div class="col-12 mt-3">
                                            <h6 class="text-primary">Usuario del Sistema</h6>
                                            ${empleado.username ?
                                                `<p><strong>Usuario:</strong> ${empleado.username}</p>
                                                 <p><strong>Rol:</strong> ${empleado.rol}</p>
                                                 <p><strong>Estado:</strong> <span class="badge bg-${empleado.usuario_activo ? 'success' : 'danger'}">${empleado.usuario_activo ? 'Activo' : 'Inactivo'}</span></p>` :
                                                '<p class="text-muted">No tiene usuario de acceso al sistema</p>'
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                    <button type="button" class="btn btn-primary" onclick="editEmployee(${empleado.id})" data-bs-dismiss="modal">Editar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Remove existing modal if any
                const existingModal = document.getElementById('employeeDetailsModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Add new modal to body
                document.body.insertAdjacentHTML('beforeend', detailsHtml);

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('employeeDetailsModal'));
                modal.show();

            } catch (error) {
                console.error('Error loading employee details:', error);
                showNotification('Error cargando detalles del empleado', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deactivateEmployee(employeeId) {
            if (!confirm('¿Está seguro de que desea desactivar este empleado? Esta acción se puede revertir más tarde.')) {
                return;
            }

            try {
                showLoading(true);

                const response = await apiRequest(`/api/empleados/${employeeId}`, {
                    method: 'DELETE'
                });

                if (response.success) {
                    showNotification('Empleado desactivado exitosamente', 'success');
                    await loadSectionContent('empleados');
                } else {
                    showNotification(response.error || 'Error desactivando empleado', 'error');
                }

            } catch (error) {
                console.error('Error deactivating employee:', error);
                showNotification('Error desactivando empleado', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deletePermanentEmployee(employeeId) {
            if (!confirm('⚠️ ¿Está COMPLETAMENTE SEGURO de que desea ELIMINAR PERMANENTEMENTE este empleado?\n\n❌ Esta acción NO se puede deshacer.\n❌ Se perderán todos los datos del empleado.\n\n¿Desea continuar?')) {
                return;
            }

            try {
                showLoading(true);

                const response = await apiRequest(`/api/empleados/${employeeId}/permanent`, {
                    method: 'DELETE'
                });

                if (response.success) {
                    showNotification('Empleado eliminado permanentemente', 'success');
                    await loadSectionContent('empleados');
                } else {
                    showNotification(response.error || 'Error eliminando empleado permanentemente', 'error');
                }

            } catch (error) {
                console.error('Error deleting employee permanently:', error);
                showNotification('Error eliminando empleado permanentemente', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Show new employee modal (simple version)
        function showNewEmployeeModal() {
            const modalHTML = `
                <div class="modal fade" id="newEmployeeModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Crear Nuevo Empleado</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="newEmployeeForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">RUT *</label>
                                            <input type="text" class="form-control" id="newRut" placeholder="12345678-9" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Email *</label>
                                            <input type="email" class="form-control" id="newEmail" required>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Nombre *</label>
                                            <input type="text" class="form-control" id="newNombre" required>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Apellido Paterno *</label>
                                            <input type="text" class="form-control" id="newApellidoPaterno" required>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Apellido Materno</label>
                                            <input type="text" class="form-control" id="newApellidoMaterno">
                                        </div>
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">Teléfono</label>
                                            <input type="tel" class="form-control" id="newTelefono" placeholder="+56 9 1234 5678">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Fecha de Ingreso *</label>
                                            <input type="date" class="form-control" id="newFechaIngreso" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Cargo *</label>
                                            <input type="text" class="form-control" id="newCargo" required>
                                        </div>
                                        <div class="col-12 mb-3">
                                            <label class="form-label">Supervisor Directo</label>
                                            <select class="form-select" id="newSupervisor">
                                                <option value="">Sin supervisor asignado</option>
                                            </select>
                                        </div>
                                        <div class="col-12 mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="newNegociacionColectiva">
                                                <label class="form-check-label" for="newNegociacionColectiva">
                                                    Pertenece a Negociación Colectiva
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-12 mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="newCreateUser">
                                                <label class="form-check-label" for="newCreateUser">
                                                    Crear cuenta de usuario (Username: RUT, Password: usuario123)
                                                </label>
                                            </div>
                                        </div>
                                        <div id="newUserFields" style="display: none;">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Rol</label>
                                                <select class="form-select" id="newRol">
                                                    <option value="empleado">Empleado</option>
                                                    <option value="supervisor">Supervisor</option>
                                                    <option value="admin">Administrador</option>
                                                </select>
                                            </div>
                                            <div class="col-12 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="newPuedeAprobar">
                                                    <label class="form-check-label" for="newPuedeAprobar">
                                                        Puede aprobar permisos
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" id="saveNewEmployeeBtn">Guardar Empleado</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if present
            const existingModal = document.getElementById('newEmployeeModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to DOM
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Set default date
            document.getElementById('newFechaIngreso').value = new Date().toISOString().split('T')[0];

            // Setup event handlers
            setupNewEmployeeModalHandlers();

            // Load supervisors
            loadSupervisorsForNewEmployee();

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('newEmployeeModal'));
            modal.show();

            // Focus on RUT field
            setTimeout(() => {
                document.getElementById('newRut').focus();
            }, 300);
        }

        function setupNewEmployeeModalHandlers() {
            // RUT formatting
            document.getElementById('newRut').addEventListener('input', function() {
                let value = this.value.replace(/[^0-9kK]/g, '');
                if (value.length > 8) {
                    value = value.slice(0, 8) + '-' + value.slice(8);
                }
                this.value = value;
            });

            // Show/hide user fields
            document.getElementById('newCreateUser').addEventListener('change', function() {
                const userFields = document.getElementById('newUserFields');
                if (this.checked) {
                    userFields.style.display = 'block';
                } else {
                    userFields.style.display = 'none';
                }
            });

            // Save button
            document.getElementById('saveNewEmployeeBtn').addEventListener('click', saveNewEmployee);
        }

        async function loadSupervisorsForNewEmployee() {
            try {
                const response = await apiRequest('/api/empleados');
                const empleados = response.empleados || [];
                const supervisorSelect = document.getElementById('newSupervisor');

                empleados.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = `${emp.nombre} ${emp.apellido_paterno} - ${emp.cargo}`;
                    supervisorSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading supervisors:', error);
            }
        }

        async function saveNewEmployee() {
            try {
                const form = document.getElementById('newEmployeeForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const data = {
                    rut: document.getElementById('newRut').value.trim(),
                    nombre: document.getElementById('newNombre').value.trim(),
                    apellidoPaterno: document.getElementById('newApellidoPaterno').value.trim(),
                    apellidoMaterno: document.getElementById('newApellidoMaterno').value.trim() || null,
                    email: document.getElementById('newEmail').value.trim(),
                    telefono: document.getElementById('newTelefono').value.trim() || null,
                    fechaIngreso: document.getElementById('newFechaIngreso').value,
                    cargo: document.getElementById('newCargo').value.trim(),
                    supervisor: document.getElementById('newSupervisor').value || null,
                    negociacionColectiva: document.getElementById('newNegociacionColectiva').checked,
                    createUser: document.getElementById('newCreateUser').checked,
                    rol: document.getElementById('newRol').value,
                    puedeAprobar: document.getElementById('newPuedeAprobar').checked,
                    password: 'usuario123',
                    username: document.getElementById('newRut').value.trim(),
                    mustChangePassword: true
                };

                showLoading(true);

                const response = await apiRequest('/api/empleados', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                if (response.success) {
                    showNotification('Empleado creado exitosamente', 'success');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('newEmployeeModal'));
                    modal.hide();
                    await loadSectionContent('empleados');
                } else {
                    showNotification(response.error || 'Error creando empleado', 'error');
                }

            } catch (error) {
                console.error('Error saving employee:', error);
                showNotification('Error creando empleado', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Funciones para manejo de solicitudes y aprobaciones
        async function procesarSolicitud(solicitudId, decision) {
            const comentarios = document.getElementById(`comentarios_${solicitudId}`).value.trim();

            if (!confirm(`¿Está seguro de que desea ${decision} esta solicitud?`)) {
                return;
            }

            try {
                showLoading(true);

                const response = await apiRequest(`/api/solicitudes/${solicitudId}/decision`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        decision: decision,
                        comentarios: comentarios
                    })
                });

                if (response.success) {
                    showNotification(response.message, 'success');
                    await loadSectionContent('aprobaciones');
                    await loadNotifications(); // Actualizar notificaciones
                } else {
                    showNotification(response.error || `Error ${decision === 'aprobar' ? 'aprobando' : 'rechazando'} solicitud`, 'error');
                }

            } catch (error) {
                console.error('Error procesando solicitud:', error);
                showNotification('Error procesando solicitud', 'error');
            } finally {
                showLoading(false);
            }
        }

        function initializeSolicitudForm() {
            const form = document.getElementById('nuevaSolicitudForm');
            if (!form) return;

            // Configurar fecha mínima (hoy)
            const fechaPermiso = document.getElementById('fechaPermiso');
            const hoy = new Date().toISOString().split('T')[0];

            fechaPermiso.min = hoy;

            // Calcular días automáticamente
            function calcularDias() {
                const tipoPermisoSelect = document.getElementById('tipoPermiso');
                const option = tipoPermisoSelect.options[tipoPermisoSelect.selectedIndex];

                if (fechaPermiso.value && option.value) {
                    // Determinar días basado en el código del tipo de permiso
                    const codigo = option.getAttribute('data-codigo');
                    let dias = 1; // Por defecto día completo

                    if (codigo && (codigo.includes('MEDIO_MANANA') || codigo.includes('MEDIO_TARDE'))) {
                        dias = 0.5; // Medio día
                    }

                    const diasCalc = document.getElementById('diasCalculados');
                    const diasText = document.getElementById('diasCalculadosText');
                    diasText.textContent = `Días solicitados: ${dias} ${dias === 1 ? 'día' : (dias === 0.5 ? 'medio día' : 'días')}`;
                    diasCalc.style.display = 'block';
                } else {
                    document.getElementById('diasCalculados').style.display = 'none';
                }
            }

            // Mostrar información del tipo de permiso
            function mostrarInfoPermiso() {
                const select = document.getElementById('tipoPermiso');
                const option = select.options[select.selectedIndex];
                const infoDiv = document.getElementById('infoPermiso');
                const infoText = document.getElementById('infoPermisoText');

                if (option.value) {
                    const conGoce = option.getAttribute('data-con-goce') === '1';
                    const maxDias = option.getAttribute('data-max-dias');
                    const codigo = option.getAttribute('data-codigo');

                    let texto = `${conGoce ? 'Con goce de sueldo' : 'Sin goce de sueldo'}. `;

                    // Determinar tipo de duración basado en el código
                    if (codigo && codigo.includes('MEDIO_MANANA')) {
                        texto += 'Duración: Medio día mañana. ';
                    } else if (codigo && codigo.includes('MEDIO_TARDE')) {
                        texto += 'Duración: Medio día tarde. ';
                    } else {
                        texto += 'Duración: Día completo. ';
                    }

                    if (maxDias) {
                        texto += `Máximo ${maxDias} días consecutivos.`;
                    }

                    infoText.textContent = texto;
                    infoDiv.style.display = 'block';
                } else {
                    infoDiv.style.display = 'none';
                }
                calcularDias();
            }

            // Event listeners
            fechaPermiso.addEventListener('change', calcularDias);
            document.getElementById('tipoPermiso').addEventListener('change', mostrarInfoPermiso);

            // Submit handler
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                await enviarSolicitud();
            });
        }

        async function enviarSolicitud() {
            try {
                const form = document.getElementById('nuevaSolicitudForm');
                const formData = new FormData(form);

                // Obtener información del tipo de permiso seleccionado
                const tipoPermisoSelect = document.getElementById('tipoPermiso');
                const option = tipoPermisoSelect.options[tipoPermisoSelect.selectedIndex];
                const codigo = option.getAttribute('data-codigo');

                // Determinar tipoDuracion basado en el código del tipo de permiso
                let tipoDuracion = 'dia_completo';
                if (codigo && codigo.includes('MEDIO_MANANA')) {
                    tipoDuracion = 'medio_dia_am';
                } else if (codigo && codigo.includes('MEDIO_TARDE')) {
                    tipoDuracion = 'medio_dia_pm';
                }

                const data = {
                    tipoPermisoId: formData.get('tipoPermisoId'),
                    fechaInicio: formData.get('fechaPermiso'),
                    fechaTermino: formData.get('fechaPermiso'), // Misma fecha para inicio y término
                    tipoDuracion: tipoDuracion,
                    motivo: formData.get('motivo'),
                    observaciones: formData.get('observaciones')
                };

                showLoading(true);

                const response = await apiRequest('/api/solicitudes', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                if (response.success) {
                    showNotification('Solicitud enviada correctamente', 'success');
                    // Usar loadSectionContent en lugar de showSection para evitar el error
                    currentSection = 'solicitudes';
                    await loadSectionContent('solicitudes');
                } else {
                    showNotification(response.error || 'Error enviando solicitud', 'error');
                }

            } catch (error) {
                console.error('Error enviando solicitud:', error);
                showNotification('Error enviando solicitud', 'error');
            } finally {
                showLoading(false);
            }
        }

        function viewSolicitud(solicitudId) {
            // Implementar vista detallada de solicitud
            showNotification('Vista detallada en desarrollo', 'info');
        }

        // Funciones de utilidad para fechas y estados
        function formatDate(dateString) {
            if (!dateString) return '';

            try {
                // Convertir a string
                const fechaStr = String(dateString).trim();

                // Si ya está en formato DD/MM/YYYY, devolverla
                if (fechaStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                    return fechaStr;
                }

                // Extraer solo la fecha si tiene hora
                let datePart = fechaStr;
                if (fechaStr.includes('T')) {
                    datePart = fechaStr.split('T')[0];
                } else if (fechaStr.includes(' ')) {
                    datePart = fechaStr.split(' ')[0];
                }

                // Parsear YYYY-MM-DD
                const parts = datePart.split('-');
                if (parts.length === 3) {
                    const [year, month, day] = parts;
                    if (year && month && day) {
                        return `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
                    }
                }

                return '';
            } catch (error) {
                console.error('Error formateando fecha:', error);
                return '';
            }
        }

        function formatDateTime(dateString) {
            if (!dateString) return '';

            try {
                const [datePart, timePart] = dateString.split('T');
                const [year, month, day] = datePart.split('-');

                if (timePart) {
                    const [hours, minutes] = timePart.split(':');
                    return `${day}/${month}/${year} ${hours}:${minutes}`;
                }
                return `${day}/${month}/${year}`;
            } catch (error) {
                return dateString;
            }
        }

        function getStatusColor(estado) {
            switch (estado) {
                case 'pendiente': return 'warning';
                case 'aprobada': return 'success';
                case 'rechazada': return 'danger';
                case 'pendiente_nivel_2': return 'info';
                case 'cancelada': return 'secondary';
                default: return 'secondary';
            }
        }

        // Funciones para Admin - Filtros y Tabla de Solicitudes
        async function loadAllSolicitudesAdmin(filtros = {}) {
            try {
                console.log('🔍 Cargando todas las solicitudes con filtros:', filtros);

                // Construir query params
                const params = new URLSearchParams();
                if (filtros.estado) params.append('estado', filtros.estado);
                if (filtros.busqueda) params.append('busqueda', filtros.busqueda);
                if (filtros.mes) params.append('mes', filtros.mes);

                const url = `/api/solicitudes-empleado/admin/todas${params.toString() ? '?' + params.toString() : ''}`;

                const response = await apiRequest(url);
                const solicitudes = response.solicitudes || [];

                console.log(`✅ Recibidas ${solicitudes.length} solicitudes`);

                // Actualizar contador
                document.getElementById('totalSolicitudesTabla').textContent = solicitudes.length;

                // Renderizar tabla
                const tbody = document.getElementById('solicitudesTableBody');

                if (solicitudes.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-muted">
                                No se encontraron solicitudes con los filtros aplicados
                            </td>
                        </tr>
                    `;
                    return;
                }

                const rows = solicitudes.map(sol => {
                    const estadoBadge = getEstadoBadge(sol.estado);
                    const fechaFormateada = formatDate(sol.fecha_desde || sol.created_at);
                    const puedeAnular = sol.estado === 'APROBADO' || sol.estado === 'APROBADO_SUPERVISOR';

                    return `
                        <tr>
                            <td>${sol.id}</td>
                            <td>${sol.empleado_nombre || 'N/A'}</td>
                            <td>${sol.empleado_rut || 'N/A'}</td>
                            <td>
                                <span class="badge" style="background-color: ${sol.tipo_color || '#6c757d'};">
                                    ${sol.tipo_codigo || sol.tipo_nombre || 'N/A'}
                                </span>
                            </td>
                            <td>${fechaFormateada}</td>
                            <td>${estadoBadge}</td>
                            <td class="text-truncate" style="max-width: 200px;" title="${sol.motivo || 'Sin motivo'}">
                                ${sol.motivo || 'Sin motivo'}
                            </td>
                            <td>
                                <div class="d-flex gap-1">
                                    ${puedeAnular ? `
                                        <button class="btn btn-warning btn-sm"
                                                onclick="mostrarModalAnulacion(${sol.id}, '${(sol.empleado_nombre || 'N/A').replace(/'/g, "\\'")}', '${fechaFormateada}')">
                                            <i class="fas fa-ban me-1"></i>Anular
                                        </button>
                                    ` : ''}
                                    ${(sol.estado === 'APROBADO' || sol.estado === 'RECHAZADO' || sol.estado === 'ANULADO') ? `
                                        <button class="btn btn-outline-${sol.estado === 'APROBADO' ? 'primary' : sol.estado === 'ANULADO' ? 'secondary' : 'danger'} btn-sm"
                                                onclick="verPDFAdmin(${sol.id})"
                                                title="Ver PDF del permiso">
                                            <i class="fas fa-file-pdf"></i>
                                        </button>
                                    ` : ''}
                                    ${!puedeAnular && sol.estado !== 'APROBADO' && sol.estado !== 'RECHAZADO' && sol.estado !== 'ANULADO' ? '-' : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

                tbody.innerHTML = rows;

            } catch (error) {
                console.error('❌ Error cargando solicitudes admin:', error);
                const tbody = document.getElementById('solicitudesTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-danger">
                            Error al cargar solicitudes: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function aplicarFiltrosAdmin() {
            const filtros = {
                estado: document.getElementById('filtroEstadoAdmin').value,
                busqueda: document.getElementById('filtroBusquedaAdmin').value,
                mes: document.getElementById('filtroMesAdmin').value
            };

            console.log('🔍 Aplicando filtros:', filtros);
            loadAllSolicitudesAdmin(filtros);

            // También actualizar estadísticas con filtros
            loadStatisticsWithFilters(filtros);
        }

        function limpiarFiltrosAdmin() {
            document.getElementById('filtroEstadoAdmin').value = '';
            document.getElementById('filtroBusquedaAdmin').value = '';
            document.getElementById('filtroMesAdmin').value = '';

            // Recargar sin filtros
            loadAllSolicitudesAdmin();
            loadStatisticsWithFilters({});
        }

        async function loadStatisticsWithFilters(filtros = {}) {
            try {
                // Construir query params
                const params = new URLSearchParams();
                if (filtros.estado) params.append('estado', filtros.estado);
                if (filtros.busqueda) params.append('busqueda', filtros.busqueda);
                if (filtros.mes) params.append('mes', filtros.mes);

                const url = `/api/solicitudes-empleado/admin/todas${params.toString() ? '?' + params.toString() : ''}`;
                const response = await apiRequest(url);
                const solicitudes = response.solicitudes || [];

                // Actualizar estadísticas
                document.getElementById('totalSolicitudes').textContent = solicitudes.length;
                document.getElementById('solicitudesAprobadas').textContent =
                    solicitudes.filter(s => s.estado && s.estado.toUpperCase() === 'APROBADO').length;
                document.getElementById('solicitudesPendientes').textContent =
                    solicitudes.filter(s => s.estado && (s.estado.toUpperCase() === 'PENDIENTE' || s.estado.toUpperCase() === 'APROBADO_SUPERVISOR')).length;
                document.getElementById('solicitudesRechazadas').textContent =
                    solicitudes.filter(s => s.estado && s.estado.toUpperCase() === 'RECHAZADO').length;
            } catch (error) {
                console.error('Error actualizando estadísticas con filtros:', error);
            }
        }

        function getEstadoBadge(estado) {
            if (!estado) return '<span class="badge bg-secondary">N/A</span>';

            const estadoUpper = estado.toUpperCase();
            const badges = {
                'PENDIENTE': '<span class="badge bg-warning text-dark">PENDIENTE</span>',
                'APROBADO': '<span class="badge bg-success">APROBADO</span>',
                'RECHAZADO': '<span class="badge bg-danger">RECHAZADO</span>',
                'APROBADO_SUPERVISOR': '<span class="badge bg-info">APROBADO SUPERVISOR</span>',
                'CANCELADO': '<span class="badge bg-secondary">CANCELADO</span>'
            };

            return badges[estadoUpper] || `<span class="badge bg-secondary">${estado}</span>`;
        }

        // Funciones para Reportes en PDF
        async function generarReportePDF() {
            try {
                showLoading(true);

                const filtros = {
                    fechaInicio: document.getElementById('reporteFechaInicio').value,
                    fechaFin: document.getElementById('reporteFechaFin').value,
                    estado: document.getElementById('reporteEstado').value,
                    empleado: document.getElementById('reporteEmpleado').value,
                    tipo: document.getElementById('reporteTipo').value,
                    orden: document.getElementById('reporteOrden').value
                };

                console.log('📊 Generando reporte PDF con filtros:', filtros);

                // Construir query params
                const params = new URLSearchParams();
                if (filtros.fechaInicio) params.append('fechaInicio', filtros.fechaInicio);
                if (filtros.fechaFin) params.append('fechaFin', filtros.fechaFin);
                if (filtros.estado) params.append('estado', filtros.estado);
                if (filtros.empleado) params.append('busqueda', filtros.empleado);
                if (filtros.tipo) params.append('tipo', filtros.tipo);
                if (filtros.orden) params.append('orden', filtros.orden);

                // Descargar PDF
                const response = await fetch(`/api/reportes/solicitudes/pdf?${params.toString()}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error generando PDF: ${response.statusText}`);
                }

                // Crear blob y descargar
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reporte_solicitudes_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showNotification('Reporte PDF generado exitosamente', 'success');

            } catch (error) {
                console.error('❌ Error generando reporte PDF:', error);
                showNotification('Error generando reporte PDF: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function generarReporteRapido(tipo) {
            try {
                showLoading(true);

                console.log(`📊 Generando reporte rápido: ${tipo}`);

                const params = new URLSearchParams();
                params.append('tipo', 'detallado');
                params.append('reporteRapido', tipo);

                const response = await fetch(`/api/reportes/solicitudes/pdf?${params.toString()}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error generando PDF: ${response.statusText}`);
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reporte_${tipo}_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showNotification(`Reporte ${tipo} generado exitosamente`, 'success');

            } catch (error) {
                console.error('❌ Error generando reporte rápido:', error);
                showNotification('Error generando reporte: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function previsualizarReporte() {
            try {
                showLoading(true);

                const filtros = {
                    fechaInicio: document.getElementById('reporteFechaInicio').value,
                    fechaFin: document.getElementById('reporteFechaFin').value,
                    estado: document.getElementById('reporteEstado').value,
                    empleado: document.getElementById('reporteEmpleado').value
                };

                console.log('👁️ Previsualizando reporte con filtros:', filtros);

                // Construir query params
                const params = new URLSearchParams();
                if (filtros.estado) params.append('estado', filtros.estado);
                if (filtros.empleado) params.append('busqueda', filtros.empleado);

                // Obtener datos de las solicitudes
                const url = `/api/solicitudes-empleado/admin/todas?${params.toString()}`;
                const response = await apiRequest(url);
                const solicitudes = response.solicitudes || [];

                // Filtrar por fechas si están definidas
                let solicitudesFiltradas = solicitudes;
                if (filtros.fechaInicio) {
                    solicitudesFiltradas = solicitudesFiltradas.filter(s =>
                        s.fecha_desde >= filtros.fechaInicio
                    );
                }
                if (filtros.fechaFin) {
                    solicitudesFiltradas = solicitudesFiltradas.filter(s =>
                        s.fecha_desde <= filtros.fechaFin
                    );
                }

                // Mostrar previsualización
                const previewDiv = document.getElementById('reportePreview');
                const contentDiv = document.getElementById('reportePreviewContent');

                if (solicitudesFiltradas.length === 0) {
                    contentDiv.innerHTML = '<p class="text-muted">No se encontraron solicitudes con los filtros aplicados</p>';
                } else {
                    contentDiv.innerHTML = `
                        <div class="mb-3">
                            <h6>Total de solicitudes: ${solicitudesFiltradas.length}</h6>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Empleado</th>
                                        <th>Tipo</th>
                                        <th>Fecha</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${solicitudesFiltradas.slice(0, 10).map(sol => `
                                        <tr>
                                            <td>${sol.id}</td>
                                            <td>${sol.empleado_nombre || 'N/A'}</td>
                                            <td>${sol.tipo_nombre || sol.tipo_codigo || 'N/A'}</td>
                                            <td>${formatDate(sol.fecha_desde || sol.created_at)}</td>
                                            <td>${getEstadoBadge(sol.estado)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ${solicitudesFiltradas.length > 10 ? `<p class="text-muted small">Mostrando 10 de ${solicitudesFiltradas.length} solicitudes</p>` : ''}
                    `;
                }

                previewDiv.style.display = 'block';
                previewDiv.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('❌ Error en previsualización:', error);
                showNotification('Error en previsualización: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function limpiarFiltrosReporte() {
            document.getElementById('reporteFechaInicio').value = '';
            document.getElementById('reporteFechaFin').value = '';
            document.getElementById('reporteEstado').value = '';
            document.getElementById('reporteEmpleado').value = '';
            document.getElementById('reporteTipo').value = 'detallado';
            document.getElementById('reporteOrden').value = 'fecha_desc';

            // Ocultar previsualización
            document.getElementById('reportePreview').style.display = 'none';

            showNotification('Filtros limpiados', 'info');
        }

        function getStatusText(estado) {
            switch (estado) {
                case 'pendiente': return 'Pendiente';
                case 'aprobada': return 'Aprobada';
                case 'rechazada': return 'Rechazada';
                case 'pendiente_nivel_2': return 'Pendiente Nivel 2';
                case 'cancelada': return 'Cancelada';
                default: return estado;
            }
        }

        // ============================================
        // CONFIGURACIÓN DE PERMISOS - FUNCIONES GLOBALES
        // ============================================

        // Generate configuration content for admin
        async function generateConfiguracionContent() {
            try {
                if (currentUser.rol !== 'admin' && currentUser.rol !== 'SUPER_ADMIN' && currentUser.rol !== 'administrador') {
                    return '<div class="alert alert-danger">Solo administradores pueden acceder a las configuraciones</div>';
                }

                // Obtener todos los empleados
                console.log('Solicitando empleados desde /api/empleados...');
                const empleadosResponse = await apiRequest('/api/empleados');
                console.log('Respuesta completa de empleados:', empleadosResponse);

                // La respuesta puede tener diferentes estructuras: empleadosResponse.empleados o empleadosResponse.data
                let empleados = [];
                if (empleadosResponse.empleados) {
                    empleados = empleadosResponse.empleados;
                } else if (empleadosResponse.data) {
                    // Si data es un array, úsalo directamente; si es un objeto, busca la propiedad empleados
                    if (Array.isArray(empleadosResponse.data)) {
                        empleados = empleadosResponse.data;
                    } else if (empleadosResponse.data.empleados) {
                        empleados = empleadosResponse.data.empleados;
                    }
                }

                console.log('Empleados procesados:', empleados.length, empleados);

                if (empleados.length === 0) {
                    console.warn('No hay empleados disponibles. Respuesta:', empleadosResponse);
                    return `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>No se encontraron empleados en el sistema</strong>
                            <p class="mb-0 mt-2">Verifica que existan empleados registrados en la sección "Gestión de Empleados".</p>
                        </div>
                    `;
                }

                    let content = `
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="alert alert-info border-start border-4 border-primary">
                                    <i class="fas fa-users-cog me-2"></i>
                                    <strong>Configuración de Permisos por Empleado</strong>
                                    <p class="mb-0 mt-2">Configure la cantidad de permisos administrativos disponibles para cada empleado por semestre.</p>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="d-flex gap-2 flex-wrap align-items-center">
                                    <button class="btn btn-primary" onclick="aplicarConfiguracionPorDefecto()">
                                        <i class="fas fa-magic me-2"></i>Aplicar Configuración por Defecto (3 por semestre)
                                    </button>
                                    <button class="btn btn-success" onclick="guardarTodosLosPermisos()">
                                        <i class="fas fa-save me-2"></i>Guardar Todos los Cambios
                                    </button>
                                    <div class="input-group" style="max-width: 350px;">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control" id="buscarEmpleado" placeholder="Escribe para buscar..." oninput="filtrarEmpleadosConfig()">
                                        <button class="btn btn-outline-secondary" type="button" onclick="limpiarBusquedaConfig()" title="Limpiar búsqueda">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover table-striped">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>Nombre Completo</th>
                                                        <th>RUT</th>
                                                        <th style="width: 180px;">
                                                            Permisos Disponibles<br>
                                                            <small class="text-muted">(modificables)</small>
                                                        </th>
                                                        <th>Permisos Usados</th>
                                                        <th style="width: 120px;">Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tablaEmpleadosConfig">
                    `;

                    // Generar filas de la tabla con todos los empleados
                    let filasGeneradas = 0;
                    empleados.forEach(emp => {
                        const esNegociacion = (emp.cargo && emp.cargo.toLowerCase().includes('negociacion')) ||
                                             (emp.cargo && emp.cargo.toLowerCase().includes('negociación'));

                        // Determinar el nombre a mostrar
                        const nombreMostrar = emp.nombre_completo || emp.nombre || `${emp.nombres || ''} ${emp.apellidos || ''}`.trim() || 'Sin nombre';

                        // Calcular valores actuales de la base de datos
                        const permisosAsignados1 = emp.permisos_primer_semestre !== undefined && emp.permisos_primer_semestre !== null ? emp.permisos_primer_semestre : 3;
                        const permisosAsignados2 = emp.permisos_segundo_semestre !== undefined && emp.permisos_segundo_semestre !== null ? emp.permisos_segundo_semestre : 3;
                        const totalUsados = (emp.uso_primer_semestre || 0) + (emp.uso_segundo_semestre || 0);

                        // Calcular lo que queda disponible (esto es lo que se mostrará en los inputs)
                        const restante1 = permisosAsignados1 - (emp.uso_primer_semestre || 0);
                        const restante2 = permisosAsignados2 - (emp.uso_segundo_semestre || 0);
                        const totalRestante = restante1 + restante2;

                        if (esNegociacion) {
                            // Para negociación colectiva: UN solo campo con total anual
                            content += `
                                <tr data-empleado-row="${emp.id}" data-negociacion="true">
                                    <td>
                                        <strong>${nombreMostrar}</strong>
                                        <br><span class="badge bg-warning text-dark"><i class="fas fa-star me-1"></i>Negociación Colectiva</span>
                                    </td>
                                    <td><small class="text-muted">${emp.rut || 'N/A'}</small></td>
                                    <td>
                                        <div class="input-group input-group-sm">
                                            <input type="number"
                                                   class="form-control"
                                                   id="permisos_total_${emp.id}"
                                                   value="${totalRestante}"
                                                   min="0"
                                                   max="365">
                                            <span class="input-group-text">disponibles</span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">Usados: ${totalUsados}</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-success" onclick="guardarPermisosEmpleado(${emp.id}, true)" title="Guardar cambios">
                                            <i class="fas fa-save"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        } else {
                            // Para empleados normales: DOS campos (1er y 2do semestre)
                            content += `
                                <tr data-empleado-row="${emp.id}" data-negociacion="false">
                                    <td><strong>${nombreMostrar}</strong></td>
                                    <td><small class="text-muted">${emp.rut || 'N/A'}</small></td>
                                    <td>
                                        <div class="d-flex gap-2 align-items-center">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text">1°</span>
                                                <input type="number"
                                                       class="form-control"
                                                       id="permisos_1_${emp.id}"
                                                       value="${restante1}"
                                                       min="0"
                                                       max="365"
                                                       style="max-width: 70px;">
                                            </div>
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text">2°</span>
                                                <input type="number"
                                                       class="form-control"
                                                       id="permisos_2_${emp.id}"
                                                       value="${restante2}"
                                                       min="0"
                                                       max="365"
                                                       style="max-width: 70px;">
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-info me-1">1°: ${emp.uso_primer_semestre || 0} usados</span>
                                        <span class="badge bg-info">2°: ${emp.uso_segundo_semestre || 0} usados</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-success" onclick="guardarPermisosEmpleado(${emp.id}, false)" title="Guardar cambios">
                                            <i class="fas fa-save"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }
                        filasGeneradas++;
                    });

                    console.log(`HTML generado: ${filasGeneradas} filas de empleados`);

                    content += `
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="alert alert-info border-start border-4 border-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Información sobre Permisos Administrativos:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Empleados regulares:</strong> 3 permisos por semestre por defecto (se muestran 2 campos separados: 1° y 2° semestre)</li>
                                        <li><strong>Negociación Colectiva:</strong> 12 permisos anuales por defecto (se muestra un solo campo) - Se identifican con una estrella dorada ⭐</li>
                                        <li>Los campos muestran los permisos <strong>DISPONIBLES</strong> (restantes) del empleado</li>
                                        <li>Los badges azules muestran los permisos <strong>USADOS</strong> (no modificables directamente)</li>
                                        <li>Al modificar los disponibles y guardar, el sistema calcula automáticamente el total (disponibles + usados)</li>
                                        <li>El botón "Aplicar Configuración por Defecto" restablecerá los valores iniciales</li>
                                        <li>La búsqueda filtra en tiempo real por nombre o RUT</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                `;

                return content;

            } catch (error) {
                console.error('Error loading configuration:', error);
                return '<div class="alert alert-danger">Error cargando la configuración del sistema</div>';
            }
        }

        // Guardar permisos de un empleado individual
        async function guardarPermisosEmpleado(empleadoId, esNegociacion) {
            try {
                showLoading(true);

                // Primero obtener los datos actuales del empleado para saber cuántos tiene usados
                const empleadosResponse = await apiRequest('/api/empleados');
                let empleados = [];
                if (empleadosResponse.empleados) {
                    empleados = empleadosResponse.empleados;
                } else if (empleadosResponse.data) {
                    if (Array.isArray(empleadosResponse.data)) {
                        empleados = empleadosResponse.data;
                    } else if (empleadosResponse.data.empleados) {
                        empleados = empleadosResponse.data.empleados;
                    }
                }

                const empleado = empleados.find(e => e.id === empleadoId);
                if (!empleado) {
                    throw new Error('Empleado no encontrado');
                }

                let permisos1, permisos2;

                if (esNegociacion) {
                    // Para negociación colectiva: el input tiene los disponibles, sumar los usados
                    const disponiblesIngresados = parseInt(document.getElementById(`permisos_total_${empleadoId}`).value) || 0;
                    const totalUsados = (empleado.uso_primer_semestre || 0) + (empleado.uso_segundo_semestre || 0);
                    const totalPermisos = disponiblesIngresados + totalUsados;

                    // Dividir el total en dos semestres
                    permisos1 = Math.floor(totalPermisos / 2);
                    permisos2 = Math.ceil(totalPermisos / 2);
                } else {
                    // Para empleados normales: los inputs tienen los disponibles, sumar los usados
                    const disponibles1 = parseInt(document.getElementById(`permisos_1_${empleadoId}`).value) || 0;
                    const disponibles2 = parseInt(document.getElementById(`permisos_2_${empleadoId}`).value) || 0;

                    permisos1 = disponibles1 + (empleado.uso_primer_semestre || 0);
                    permisos2 = disponibles2 + (empleado.uso_segundo_semestre || 0);
                }

                const response = await apiRequest(`/api/empleados/${empleadoId}/permisos`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        permisos_primer_semestre: permisos1,
                        permisos_segundo_semestre: permisos2
                    })
                });

                if (response.success) {
                    showNotification('Permisos actualizados correctamente', 'success');
                    // Recargar la sección para mostrar los nuevos valores
                    await loadSectionContent('configuracion');
                } else {
                    throw new Error(response.message || 'Error al actualizar permisos');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message || 'Error al guardar los permisos', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Guardar permisos de todos los empleados
        async function guardarTodosLosPermisos() {
                try {
                    if (!confirm('¿Está seguro de guardar los cambios para TODOS los empleados?')) {
                        return;
                    }

                    showLoading(true);

                    // Obtener los datos actuales de todos los empleados
                    const empleadosResponse = await apiRequest('/api/empleados');
                    let empleados = [];
                    if (empleadosResponse.empleados) {
                        empleados = empleadosResponse.empleados;
                    } else if (empleadosResponse.data) {
                        if (Array.isArray(empleadosResponse.data)) {
                            empleados = empleadosResponse.data;
                        } else if (empleadosResponse.data.empleados) {
                            empleados = empleadosResponse.data.empleados;
                        }
                    }

                    // Obtener todas las filas visibles
                    const filas = document.querySelectorAll('tr[data-empleado-row]');
                    let exitosos = 0;
                    let errores = 0;

                    for (const fila of filas) {
                        const empleadoId = parseInt(fila.getAttribute('data-empleado-row'));
                        const esNegociacion = fila.getAttribute('data-negociacion') === 'true';
                        const empleado = empleados.find(e => e.id === empleadoId);

                        if (!empleado) continue;

                        try {
                            let permisos1, permisos2;

                            if (esNegociacion) {
                                // Para negociación colectiva: sumar disponibles + usados
                                const disponiblesIngresados = parseInt(document.getElementById(`permisos_total_${empleadoId}`).value) || 0;
                                const totalUsados = (empleado.uso_primer_semestre || 0) + (empleado.uso_segundo_semestre || 0);
                                const totalPermisos = disponiblesIngresados + totalUsados;
                                permisos1 = Math.floor(totalPermisos / 2);
                                permisos2 = Math.ceil(totalPermisos / 2);
                            } else {
                                // Para empleados normales: sumar disponibles + usados por semestre
                                const disponibles1 = parseInt(document.getElementById(`permisos_1_${empleadoId}`).value) || 0;
                                const disponibles2 = parseInt(document.getElementById(`permisos_2_${empleadoId}`).value) || 0;
                                permisos1 = disponibles1 + (empleado.uso_primer_semestre || 0);
                                permisos2 = disponibles2 + (empleado.uso_segundo_semestre || 0);
                            }

                            await apiRequest(`/api/empleados/${empleadoId}/permisos`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    permisos_primer_semestre: permisos1,
                                    permisos_segundo_semestre: permisos2
                                })
                            });
                            exitosos++;
                        } catch (error) {
                            console.error(`Error actualizando empleado ${empleadoId}:`, error);
                            errores++;
                        }
                    }

                    if (errores === 0) {
                        showNotification(`Todos los permisos fueron actualizados correctamente (${exitosos} empleados)`, 'success');
                        // Recargar la sección para mostrar los nuevos valores
                        await loadSectionContent('configuracion');
                    } else {
                        showNotification(`Actualizados: ${exitosos}, Errores: ${errores}`, 'warning');
                    }

                } catch (error) {
                    console.error('Error:', error);
                    showNotification('Error al guardar los permisos', 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Aplicar configuración por defecto: 3 por semestre (6 para negociación)
        async function aplicarConfiguracionPorDefecto() {
                try {
                    if (!confirm('¿Aplicar configuración por defecto?\n\n- Empleados regulares: 3 permisos por semestre\n- Negociación Colectiva: 6 permisos por semestre (12 total al año)')) {
                        return;
                    }

                    showLoading(true);

                    // Obtener todas las filas para detectar negociación por el badge
                    const filas = document.querySelectorAll('tr[data-empleado-row]');
                    let exitosos = 0;

                    for (const fila of filas) {
                        const empleadoId = fila.getAttribute('data-empleado-row');
                        const esNegociacion = fila.getAttribute('data-negociacion') === 'true';

                        if (esNegociacion) {
                            // Negociación colectiva: 12 permisos anuales (6 por semestre)
                            await apiRequest(`/api/empleados/${empleadoId}/permisos`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    permisos_primer_semestre: 6,
                                    permisos_segundo_semestre: 6
                                })
                            });

                            // Actualizar el input de total anual
                            const inputTotal = document.getElementById(`permisos_total_${empleadoId}`);
                            if (inputTotal) inputTotal.value = 12;
                        } else {
                            // Empleados normales: 3 permisos por semestre
                            await apiRequest(`/api/empleados/${empleadoId}/permisos`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    permisos_primer_semestre: 3,
                                    permisos_segundo_semestre: 3
                                })
                            });

                            // Actualizar los inputs individuales
                            const input1 = document.getElementById(`permisos_1_${empleadoId}`);
                            const input2 = document.getElementById(`permisos_2_${empleadoId}`);
                            if (input1) input1.value = 3;
                            if (input2) input2.value = 3;
                        }

                        exitosos++;
                    }

                    showNotification(`Configuración por defecto aplicada a ${exitosos} empleados`, 'success');

                } catch (error) {
                    console.error('Error:', error);
                    showNotification('Error al aplicar configuración por defecto', 'error');
                } finally {
                    showLoading(false);
                }
            }

        // Filtrar empleados en la tabla de configuración
        function filtrarEmpleadosConfig() {
                try {
                    const inputBusqueda = document.getElementById('buscarEmpleado');
                    if (!inputBusqueda) {
                        console.warn('Input de búsqueda no encontrado en el DOM');
                        return;
                    }

                    const busqueda = inputBusqueda.value.toLowerCase();
                    console.log(`Filtrando empleados con término: "${busqueda}"`);

                    // Intentar primero con el selector específico
                    let filas = document.querySelectorAll('#tablaEmpleadosConfig tr[data-empleado-row]');
                    console.log(`Filas encontradas con selector #tablaEmpleadosConfig: ${filas.length}`);

                    // Si no encuentra con el selector específico, intentar con un selector más amplio
                    if (filas.length === 0) {
                        filas = document.querySelectorAll('tr[data-empleado-row]');
                        console.log(`Filas encontradas con selector amplio: ${filas.length}`);
                    }

                    // Si aún no hay filas, salir
                    if (filas.length === 0) {
                        console.warn('No se encontraron filas de empleados en el DOM');
                        return;
                    }

                    let visibles = 0;
                    filas.forEach(fila => {
                        const texto = fila.textContent.toLowerCase();
                        if (texto.includes(busqueda)) {
                            fila.style.display = '';
                            visibles++;
                        } else {
                            fila.style.display = 'none';
                        }
                    });

                    console.log(`✓ Búsqueda completada: "${busqueda}" - ${visibles} de ${filas.length} empleados visibles`);
                } catch (error) {
                    console.error('Error en filtrarEmpleadosConfig:', error);
                }
            }

        // Limpiar búsqueda en configuración
        function limpiarBusquedaConfig() {
            const inputBusqueda = document.getElementById('buscarEmpleado');
            if (inputBusqueda) {
                inputBusqueda.value = '';
                filtrarEmpleadosConfig();
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        // Event listeners for navigation
        document.addEventListener('DOMContentLoaded', function() {
            // Navigation links
            document.querySelectorAll('a[data-section]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });

            // Logout link
            document.getElementById('logoutLink')?.addEventListener('click', function(e) {
                e.preventDefault();
                logout();
            });

            // Use event delegation for all dynamically generated buttons
            document.addEventListener('click', function(e) {
                // Add Employee button - show modal in same window
                if (e.target.closest('#addEmployeeBtn')) {
                    e.preventDefault();
                    showLoading(false); // Asegurar que no hay loading
                    showAddEmployeeModal(); // Preparar el modal

                    // Mostrar el modal (ahora está fijo en el body)
                    const modalElement = document.getElementById('employeeModal');
                    const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
                    modal.show();

                    console.log('Modal opened for CREATE');
                    return;
                }

                // Save Employee button
                if (e.target.closest('#saveEmployeeBtn')) {
                    e.preventDefault();
                    saveEmployee();
                    return;
                }

                // Employee action buttons (edit, view, delete)
                if (e.target.closest('[data-action]')) {
                    e.preventDefault();
                    const button = e.target.closest('[data-action]');
                    const action = button.getAttribute('data-action');
                    const empId = button.getAttribute('data-emp-id');

                    switch(action) {
                        case 'edit':
                            editEmployee(parseInt(empId));
                            break;
                        case 'view':
                            viewEmployee(parseInt(empId));
                            break;
                        case 'deactivate':
                            deactivateEmployee(parseInt(empId));
                            break;
                        case 'delete-permanent':
                            deletePermanentEmployee(parseInt(empId));
                            break;
                    }
                }
            });

        // FUNCIONES ANTIGUAS (por compatibilidad)
        async function updateConfig(categoria, clave, valor) {
                try {
                    showLoading(true);

                    const response = await apiRequest(`/api/configuraciones/${categoria}/${clave}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ valor: valor.toString() })
                    });

                    if (response.success) {
                        showNotification(response.message, 'success');

                        // Update switch label if it's a boolean
                        const switchElement = document.getElementById(`config_${categoria}_${clave}`);
                        if (switchElement && switchElement.type === 'checkbox') {
                            const label = switchElement.nextElementSibling;
                            if (label) {
                                label.textContent = valor ? 'Habilitado' : 'Deshabilitado';
                            }
                        }
                    } else {
                        showNotification(response.error || 'Error actualizando configuración', 'error');
                    }

                } catch (error) {
                    console.error('Error updating config:', error);
                    showNotification('Error actualizando configuración', 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Timezone configuration functions
            async function loadTimezoneSettings() {
                try {
                    console.log('Cargando configuración de zona horaria...');

                    // Cargar zonas horarias disponibles
                    const zonasResponse = await apiRequest('/api/configuracion-permisos/zonas-horarias');

                    if (zonasResponse.success && zonasResponse.zonas) {
                        const select = document.getElementById('timezoneSelect');
                        if (!select) return;

                        // Limpiar opciones
                        select.innerHTML = '';

                        // Cargar configuración actual
                        const configResponse = await apiRequest('/api/configuracion-permisos/configuraciones');
                        const zonaActual = configResponse.success ? configResponse.configuraciones.zona_horaria?.valor : 'America/Santiago';

                        // Agregar opciones
                        zonasResponse.zonas.forEach(zona => {
                            const option = document.createElement('option');
                            option.value = zona.value;
                            option.textContent = zona.label;
                            option.setAttribute('data-offset', zona.offset);
                            if (zona.value === zonaActual) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        });

                        console.log(`Zona horaria actual: ${zonaActual}`);
                    }
                } catch (error) {
                    console.error('Error cargando zona horaria:', error);
                    showNotification('Error cargando zona horaria', 'error');
                }
            }

            async function updateTimezone() {
                try {
                    showLoading(true);

                    const select = document.getElementById('timezoneSelect');
                    const selectedOption = select.options[select.selectedIndex];
                    const zona_horaria = selectedOption.value;
                    const utc_offset = parseInt(selectedOption.getAttribute('data-offset'));

                    console.log(`Actualizando zona horaria a: ${zona_horaria} (UTC${utc_offset})`);

                    const response = await apiRequest('/api/configuracion-permisos/zona-horaria', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ zona_horaria, utc_offset })
                    });

                    if (response.success) {
                        showNotification('Zona horaria actualizada correctamente', 'success');
                    } else {
                        showNotification(response.error || 'Error actualizando zona horaria', 'error');
                    }

                } catch (error) {
                    console.error('Error actualizando zona horaria:', error);
                    showNotification('Error actualizando zona horaria', 'error');
                } finally {
                    showLoading(false);
                }
            }
        });

        // Función para ver PDF de un permiso
        async function verPDFAdmin(solicitudId) {
            try {
                const url = `/api/solicitudes-empleado/descargar-pdf/${solicitudId}`;

                // Abrir PDF en nueva pestaña con el token de autenticación
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Error al descargar el PDF');
                }

                // Convertir la respuesta a blob
                const blob = await response.blob();

                // Crear URL temporal para el blob
                const blobUrl = window.URL.createObjectURL(blob);

                // Abrir en nueva pestaña
                window.open(blobUrl, '_blank');

                // Liberar el URL después de un tiempo
                setTimeout(() => window.URL.revokeObjectURL(blobUrl), 100);

            } catch (error) {
                console.error('Error al ver PDF:', error);
                showNotification('Error al abrir el PDF del permiso', 'error');
            }
        }

        // Funciones para anulación de permisos
        function mostrarModalAnulacion(permisoId, empleadoNombre, fecha) {
            // Establecer los valores en el modal
            document.getElementById('anulacionPermisoId').value = permisoId;
            document.getElementById('anulacionEmpleadoNombre').textContent = empleadoNombre;
            document.getElementById('anulacionFecha').textContent = fecha;
            document.getElementById('motivoAnulacion').value = '';

            // Mostrar el modal
            new bootstrap.Modal(document.getElementById('anulacionModal')).show();
        }

        async function anularPermiso(event) {
            event.preventDefault();

            const permisoId = document.getElementById('anulacionPermisoId').value;
            const motivo = document.getElementById('motivoAnulacion').value;

            if (!motivo || motivo.trim() === '') {
                showNotification('Debe ingresar un motivo para la anulación', 'error');
                return;
            }

            try {
                showLoading(true);

                const response = await fetch(`/api/admin/anular/${permisoId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ motivo: motivo })
                });

                const data = await response.json();

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('anulacionModal')).hide();

                    showNotification('Permiso anulado exitosamente. Los días han sido devueltos al empleado.', 'success');

                    // Recargar la tabla de solicitudes admin inmediatamente
                    if (typeof loadAllSolicitudesAdmin === 'function') {
                        await loadAllSolicitudesAdmin();
                    }

                    // Recargar los datos del dashboard
                    await loadDashboardData();

                    // Recargar la sección actual para reflejar los cambios
                    if (currentSection === 'anulaciones') {
                        await loadSectionContent('anulaciones');
                    } else if (currentSection === 'permisos' || currentSection === 'solicitudes') {
                        await loadSectionContent(currentSection);
                    } else if (currentSection === 'dashboard') {
                        // Ya se recargó con loadDashboardData()
                        await loadSectionContent('dashboard');
                    }
                } else {
                    showNotification(data.error || 'Error al anular el permiso', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al anular el permiso', 'error');
            } finally {
                showLoading(false);
            }
        }
    </script>
</body>
</html>
