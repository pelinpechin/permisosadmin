<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Empleado - Sistema de Permisos Completo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
        }
        
        .container-main {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin: 20px auto;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            max-width: 1200px;
        }
        
        .header-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .header-logo {
            max-width: 60px;
            height: auto;
            margin-right: 15px;
        }

        .header-institution {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .data-card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.15);
        }
        
        .permiso-card {
            border-radius: 12px;
            margin-bottom: 15px;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .permiso-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .status-pendiente { border-left: 5px solid #ffc107; }
        .status-aprobado { border-left: 5px solid #28a745; }
        .status-rechazado { border-left: 5px solid #dc3545; }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .login-section {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            margin: 50px auto;
            max-width: 400px;
        }
        
        .edit-field {
            position: relative;
            margin-bottom: 15px;
        }
        
        .edit-field input {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px;
            transition: all 0.3s ease;
        }
        
        .edit-field input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        /* Estilos para pesta√±as */
        .nav-tabs .nav-link {
            color: #667eea;
            border: none;
            border-bottom: 3px solid transparent;
            background: none;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link:hover {
            border-color: transparent transparent #667eea transparent;
            color: #5a6fd8;
        }
        
        .nav-tabs .nav-link.active {
            color: #667eea;
            background: none;
            border-color: transparent transparent #667eea transparent;
            font-weight: 600;
        }
        
        .card-header-tabs {
            border-bottom: 1px solid #dee2e6;
            margin-bottom: -1px;
        }
        
        .balance-card {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        
        .hidden { display: none !important; }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .stats-card {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        /* Estilos para notificaciones */
        .notification-bell {
            position: relative;
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: bold;
            min-width: 18px;
            text-align: center;
        }

        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            width: 400px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 10px;
            display: none;
        }

        .notification-dropdown.show {
            display: block;
        }

        .notification-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px 10px 0 0;
        }

        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .notification-item:hover {
            background: #f8f9fa;
        }

        .notification-item.unread {
            background: #e7f3ff;
        }

        .notification-item.unread:hover {
            background: #d1e7fd;
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-right: 15px;
        }

        .notification-icon.info {
            background: #cfe2ff;
            color: #084298;
        }

        .notification-icon.success {
            background: #d1e7dd;
            color: #0f5132;
        }

        .notification-icon.warning {
            background: #fff3cd;
            color: #664d03;
        }

        .notification-icon.danger {
            background: #f8d7da;
            color: #842029;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #212529;
        }

        .notification-message {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .notification-time {
            font-size: 11px;
            color: #adb5bd;
        }

        .notification-empty {
            padding: 40px 20px;
            text-align: center;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Secci√≥n de Login -->
    <div id="loginSection" class="hidden">
        <div class="container">
            <div class="login-section">
                <div class="text-center mb-4">
                    <h2><i class="fas fa-user-circle text-primary mb-3" style="font-size: 3rem;"></i></h2>
                    <h3>Portal Empleado</h3>
                    <p class="text-muted">Sistema de Permisos Administrativos</p>
                </div>
                
                <!-- Botones de administraci√≥n -->
                <div class="text-center mb-4">
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="mostrarImportarCSV()">
                        <i class="fas fa-upload"></i> Importar CSV
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="mostrarCrearUsuario()">
                        <i class="fas fa-user-plus"></i> Crear Usuario
                    </button>
                </div>
                
                <form id="loginForm">
                    <div class="edit-field">
                        <label for="loginRut" class="form-label">RUT</label>
                        <input type="text" class="form-control" id="loginRut" placeholder="12.345.678-9" required>
                    </div>
                    
                    <div class="edit-field">
                        <label for="loginPassword" class="form-label">Contrase√±a</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100 mb-3">
                        <i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesi√≥n
                    </button>
                    
                    <div class="text-center">
                        <a href="#" onclick="mostrarCrearPassword()" class="text-decoration-none d-block mb-2">
                            ¬øNo tienes contrase√±a? Crear una aqu√≠
                        </a>
                        <a href="#" onclick="mostrarRecuperarPassword()" class="text-decoration-none">
                            ¬øOlvidaste tu contrase√±a?
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Secci√≥n para crear contrase√±a -->
    <div id="crearPasswordSection" class="hidden">
        <div class="container">
            <div class="login-section">
                <div class="text-center mb-4">
                    <h3>Crear Contrase√±a</h3>
                    <p class="text-muted">Ingresa tu RUT para crear tu contrase√±a</p>
                </div>
                
                <form id="verificarRutForm">
                    <div class="edit-field">
                        <label for="verificarRut" class="form-label">RUT</label>
                        <input type="text" class="form-control" id="verificarRut" placeholder="12.345.678-9" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100 mb-3">
                        <i class="fas fa-search me-2"></i>Verificar RUT
                    </button>
                    
                    <div class="text-center">
                        <a href="#" onclick="mostrarLogin()" class="text-decoration-none">
                            ‚Üê Volver al login
                        </a>
                    </div>
                </form>
                
                <!-- Formulario para crear contrase√±a (oculto inicialmente) -->
                <form id="crearPasswordForm" class="hidden">
                    <div class="alert alert-info">
                        <i class="fas fa-user me-2"></i>
                        Empleado encontrado: <strong id="empleadoEncontrado"></strong>
                    </div>
                    
                    <div class="edit-field">
                        <label for="nuevaPassword" class="form-label">Nueva Contrase√±a</label>
                        <input type="password" class="form-control" id="nuevaPassword" minlength="6" required>
                    </div>
                    
                    <div class="edit-field">
                        <label for="confirmarPassword" class="form-label">Confirmar Contrase√±a</label>
                        <input type="password" class="form-control" id="confirmarPassword" minlength="6" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100 mb-3">
                        <i class="fas fa-key me-2"></i>Crear Contrase√±a
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Secci√≥n Recuperar Contrase√±a -->
    <div id="recuperarPasswordSection" class="hidden">
        <div class="container">
            <div class="login-section">
                <div class="text-center mb-4">
                    <h3><i class="fas fa-key text-primary me-2"></i>Recuperar Contrase√±a</h3>
                    <p class="text-muted">Te enviaremos un enlace de recuperaci√≥n a tu email</p>
                </div>
                
                <!-- Formulario para solicitar recuperaci√≥n -->
                <form id="formSolicitarRecuperacion">
                    <div class="edit-field">
                        <label for="rutRecuperacion" class="form-label">RUT</label>
                        <input type="text" class="form-control" id="rutRecuperacion" placeholder="12.345.678-9" required>
                    </div>
                    
                    <div class="edit-field">
                        <label for="emailRecuperacion" class="form-label">Email</label>
                        <input type="email" class="form-control" id="emailRecuperacion" placeholder="tu@email.com" required>
                        <div class="form-text">Debe coincidir con el email registrado en tu cuenta</div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100 mb-3">
                        <i class="fas fa-envelope me-2"></i>Enviar Enlace de Recuperaci√≥n
                    </button>
                    
                    <div class="text-center">
                        <a href="#" onclick="mostrarLogin()" class="text-decoration-none">
                            ‚Üê Volver al login
                        </a>
                    </div>
                </form>
                
                <!-- Mensaje de √©xito (oculto inicialmente) -->
                <div id="mensajeRecuperacionExito" class="hidden text-center">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>¬°Enlace enviado!</strong><br>
                        Revisa tu email y sigue las instrucciones para restablecer tu contrase√±a.
                    </div>
                    <button class="btn btn-outline-primary" onclick="mostrarLogin()">
                        <i class="fas fa-arrow-left me-2"></i>Volver al Login
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Secci√≥n Restablecer Contrase√±a -->
    <div id="restablecerPasswordSection" class="hidden">
        <div class="container">
            <div class="login-section">
                <div class="text-center mb-4">
                    <h3><i class="fas fa-lock text-primary me-2"></i>Nueva Contrase√±a</h3>
                    <p class="text-muted">Ingresa tu nueva contrase√±a</p>
                </div>
                
                <form id="formRestablecerPassword">
                    <input type="hidden" id="tokenReset">
                    
                    <div class="edit-field">
                        <label for="nuevaPasswordReset" class="form-label">Nueva Contrase√±a</label>
                        <input type="password" class="form-control" id="nuevaPasswordReset" minlength="6" required>
                    </div>
                    
                    <div class="edit-field">
                        <label for="confirmarPasswordReset" class="form-label">Confirmar Nueva Contrase√±a</label>
                        <input type="password" class="form-control" id="confirmarPasswordReset" minlength="6" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100 mb-3">
                        <i class="fas fa-save me-2"></i>Guardar Nueva Contrase√±a
                    </button>
                    
                    <div class="text-center">
                        <a href="#" onclick="mostrarLogin()" class="text-decoration-none">
                            ‚Üê Ir al login
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Secci√≥n Importar CSV -->
    <div id="importarCSVSection" class="hidden">
        <div class="container">
            <div class="login-section" style="max-width: 600px;">
                <div class="text-center mb-4">
                    <h3><i class="fas fa-upload text-primary me-2"></i>Importar Empleados desde CSV</h3>
                    <p class="text-muted">Carga el archivo CSV con los datos de empleados</p>
                </div>
                
                <div class="mb-4">
                    <label for="archivoCSV" class="form-label">Seleccionar archivo CSV</label>
                    <input type="file" class="form-control" id="archivoCSV" accept=".csv" required>
                    <div class="form-text">
                        Formato esperado: Nombre, RUT, Email, Fecha Nacimiento, Fecha Ingreso, Fecha T√©rmino, Horas, Supervisor, Cargo
                    </div>
                </div>
                
                <div id="previewCSV" class="mb-4 d-none">
                    <h5>Vista previa (primeros 5 registros):</h5>
                    <div class="table-responsive">
                        <table class="table table-sm" id="tablaPreview">
                            <thead class="table-light"></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Se detectaron <strong id="totalRegistros">0</strong> empleados en el archivo
                    </div>
                </div>
                
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-secondary" onclick="mostrarLogin()">
                        <i class="fas fa-arrow-left me-2"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary flex-grow-1" id="btnProcesarCSV" onclick="procesarCSV()" disabled>
                        <i class="fas fa-database me-2"></i>Importar a la Base de Datos
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Secci√≥n Crear Usuario -->
    <div id="crearUsuarioSection" class="hidden">
        <div class="container">
            <div class="login-section">
                <div class="text-center mb-4">
                    <h3><i class="fas fa-user-plus text-primary me-2"></i>Crear Nuevo Usuario</h3>
                    <p class="text-muted">Agregar empleado manualmente</p>
                </div>
                
                <form id="formCrearUsuario">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="edit-field">
                                <label for="nuevoNombre" class="form-label">Nombre Completo</label>
                                <input type="text" class="form-control" id="nuevoNombre" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="edit-field">
                                <label for="nuevoRut" class="form-label">RUT</label>
                                <input type="text" class="form-control" id="nuevoRut" placeholder="12.345.678-9" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="edit-field">
                                <label for="nuevoEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="nuevoEmail" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="edit-field">
                                <label for="nuevoCargo" class="form-label">Cargo</label>
                                <input type="text" class="form-control" id="nuevoCargo" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="edit-field">
                                <label for="fechaNacimiento" class="form-label">Fecha de Nacimiento</label>
                                <input type="date" class="form-control" id="fechaNacimiento">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="edit-field">
                                <label for="fechaIngreso" class="form-label">Fecha de Ingreso</label>
                                <input type="date" class="form-control" id="fechaIngreso">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="edit-field">
                                <label for="horasSemanales" class="form-label">Horas Semanales</label>
                                <input type="number" class="form-control" id="horasSemanales" min="1" max="48" value="44">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="edit-field">
                                <label for="supervisor" class="form-label">Supervisor</label>
                                <input type="text" class="form-control" id="supervisor">
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary" onclick="mostrarLogin()">
                            <i class="fas fa-arrow-left me-2"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary flex-grow-1">
                            <i class="fas fa-user-plus me-2"></i>Crear Empleado
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Portal Principal del Empleado -->
    <div id="dashboardSection" class="hidden">
        <div class="container-fluid">
            <div class="container-main">
                <!-- Header -->
                <div class="header-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <img src="logo.jpg" alt="Logo Liceo Experimental" class="header-logo">
                            <div>
                                <div class="header-institution">LICEO EXPERIMENTAL</div>
                                <h2 class="mb-0"><i class="fas fa-user me-2"></i><span id="nombreEmpleado">Cargando...</span></h2>
                                <p class="mb-0">Portal de Empleado - Sistema de Permisos</p>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <button id="btnAdmin" class="btn btn-warning me-2" onclick="window.open('admin_dashboard.html', '_blank')" style="display: none;">
                                <i class="fas fa-user-cog"></i> Admin
                            </button>

                            <!-- Campana de Notificaciones -->
                            <div class="position-relative me-2">
                                <button class="btn btn-outline-light notification-bell" onclick="toggleNotifications()" id="notificationBtn">
                                    <i class="fas fa-bell"></i>
                                    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                                </button>

                                <!-- Dropdown de Notificaciones -->
                                <div class="notification-dropdown" id="notificationDropdown">
                                    <div class="notification-header">
                                        <h6 class="mb-0">Notificaciones</h6>
                                        <button class="btn btn-sm btn-light" onclick="marcarTodasLeidas()">
                                            <i class="fas fa-check-double"></i> Marcar todas le√≠das
                                        </button>
                                    </div>
                                    <div id="notificationList"></div>
                                </div>
                            </div>

                            <button class="btn btn-outline-light me-2" onclick="mostrarModalCambiarPassword()">
                                <i class="fas fa-key"></i> Cambiar Contrase√±a
                            </button>
                            <button class="btn btn-outline-light" onclick="cerrarSesion()">
                                <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Columna Principal -->
                    <div class="col-lg-8">
                        <!-- Sistema de Pesta√±as -->
                        <div class="section">
                            <div class="data-card card">
                                <!-- Pesta√±as de Navegaci√≥n -->
                                <div class="card-header">
                                    <ul class="nav nav-tabs card-header-tabs" id="solicitudesTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="mis-solicitudes-tab" data-bs-toggle="tab" data-bs-target="#mis-solicitudes" type="button" role="tab">
                                                <i class="fas fa-list me-2"></i>Mis Solicitudes
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation" id="tab-supervision" style="display: none;">
                                            <button class="nav-link" id="supervision-tab" data-bs-toggle="tab" data-bs-target="#supervision" type="button" role="tab">
                                                <i class="fas fa-clipboard-check me-2"></i>Por Autorizar
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                                
                                <!-- Contenido de las Pesta√±as -->
                                <div class="card-body">
                                    <div class="tab-content" id="solicitudesTabContent">
                                        <!-- Pesta√±a Mis Solicitudes -->
                                        <div class="tab-pane fade show active" id="mis-solicitudes" role="tabpanel">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h5 class="mb-0">Mis Solicitudes de Permisos</h5>
                                                <button class="btn btn-primary" onclick="mostrarModalNuevoPermiso()">
                                                    <i class="fas fa-plus"></i> Nueva Solicitud
                                                </button>
                                            </div>
                                            <div id="listaSolicitudes">
                                                <div class="loading-spinner">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Cargando...</span>
                                                    </div>
                                                    <span class="ms-2">Cargando solicitudes...</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Pesta√±a Supervisi√≥n -->
                                        <div class="tab-pane fade" id="supervision" role="tabpanel">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h5 class="mb-0">Permisos por Autorizar</h5>
                                                <button class="btn btn-outline-primary" onclick="cargarSolicitudesSubordinados()">
                                                    <i class="fas fa-refresh"></i> Actualizar
                                                </button>
                                            </div>
                                            <div id="listaSolicitudesSubordinados">
                                                <div class="loading-spinner">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Cargando...</span>
                                                    </div>
                                                    <span class="ms-2">Cargando permisos por autorizar...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Columna Lateral -->
                    <div class="col-lg-4">
                        <!-- Mis Datos Personales -->
                        <div class="section">
                            <div class="data-card card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-user-edit me-2"></i>Mis Datos</h5>
                                    <button class="btn btn-sm btn-outline-primary" onclick="mostrarModalEditarDatos()">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                                <div class="card-body" id="datosPersonales">
                                    <div class="mb-2">
                                        <strong><i class="fas fa-id-card me-1"></i> RUT:</strong> 
                                        <span id="datosRut" class="text-muted">-</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong><i class="fas fa-envelope me-1"></i> Email:</strong> 
                                        <span id="datosEmail" class="text-muted">-</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong><i class="fas fa-briefcase me-1"></i> Cargo:</strong> 
                                        <span id="datosCargo" class="text-muted">-</span>
                                    </div>
                                    <div class="mb-0">
                                        <strong><i class="fas fa-user-tie me-1"></i> Supervisor:</strong> 
                                        <span id="datosSupervisor" class="text-muted">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Resumen Estad√≠stico -->
                        <div class="section">
                            <div class="data-card card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-pie me-2"></i>Resumen</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="stats-card">
                                                <i class="fas fa-clock text-warning" style="font-size: 1.5rem;"></i>
                                                <h4 class="mt-2" id="totalPendientes">0</h4>
                                                <small>Pendientes</small>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="stats-card">
                                                <i class="fas fa-check-circle text-success" style="font-size: 1.5rem;"></i>
                                                <h4 class="mt-2" id="totalAprobados">0</h4>
                                                <small>Aprobados</small>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="stats-card">
                                                <i class="fas fa-times-circle text-danger" style="font-size: 1.5rem;"></i>
                                                <h4 class="mt-2" id="totalRechazados">0</h4>
                                                <small>Rechazados</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Balance de Permisos -->
                        <div class="section">
                            <div class="data-card card">
                                <div class="card-header">
                                    <h5><i class="fas fa-balance-scale me-2"></i>Balance de Permisos</h5>
                                </div>
                                <div class="card-body" id="balancePermisos">
                                    <div class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                        <span class="ms-2">Cargando balance...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Nuevo Permiso -->
    <div class="modal fade" id="modalNuevoPermiso" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Nueva Solicitud de Permiso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="formNuevoPermiso">
                    <div class="modal-body">
                        <div id="alertaLimitesPermiso" class="alert d-none" role="alert"></div>
                        
                        <div class="edit-field">
                            <label for="tipoPermiso" class="form-label">Tipo de Permiso</label>
                            <select class="form-select" id="tipoPermiso" required>
                                <option value="">Selecciona un tipo...</option>
                            </select>
                        </div>
                        
                        <div class="edit-field">
                            <label for="fechaInicio" class="form-label">Fecha de Inicio</label>
                            <input type="date" class="form-control" id="fechaInicio" required>
                        </div>
                        
                        <div class="edit-field">
                            <label for="fechaFin" class="form-label">Fecha de Fin</label>
                            <input type="date" class="form-control" id="fechaFin" required>
                        </div>
                        
                        <div class="edit-field">
                            <label for="motivo" class="form-label">Motivo</label>
                            <textarea class="form-control" id="motivo" rows="3" required placeholder="Describe el motivo de tu solicitud..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-2"></i>Enviar Solicitud
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal Editar Datos -->
    <div class="modal fade" id="modalEditarDatos" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-edit me-2"></i>Editar Mis Datos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="formEditarDatos">
                    <div class="modal-body">
                        <div class="edit-field">
                            <label for="editRut" class="form-label">RUT</label>
                            <input type="text" class="form-control" id="editRut" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                            <div class="form-text">El RUT no puede ser modificado</div>
                        </div>
                        
                        <div class="edit-field">
                            <label for="editEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="editEmail" required placeholder="usuario@ejemplo.com">
                        </div>
                        
                        <div class="edit-field">
                            <label for="editCargo" class="form-label">Cargo</label>
                            <input type="text" class="form-control" id="editCargo" required placeholder="Tu cargo actual">
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Nota:</strong> El RUT y supervisor solo pueden ser modificados por un administrador.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Cambiar Contrase√±a -->
    <div class="modal fade" id="modalCambiarPassword" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-key me-2"></i>Cambiar Contrase√±a</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="formCambiarPassword" onsubmit="cambiarPassword(event)">
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            La contrase√±a debe tener al menos 6 caracteres.
                        </div>

                        <div class="edit-field">
                            <label for="passwordActual" class="form-label">Contrase√±a Actual</label>
                            <input type="password" class="form-control" id="passwordActual" required minlength="6">
                        </div>

                        <div class="edit-field">
                            <label for="passwordNuevo" class="form-label">Nueva Contrase√±a</label>
                            <input type="password" class="form-control" id="passwordNuevo" required minlength="6">
                        </div>

                        <div class="edit-field">
                            <label for="passwordConfirmar" class="form-label">Confirmar Nueva Contrase√±a</label>
                            <input type="password" class="form-control" id="passwordConfirmar" required minlength="6">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Cambiar Contrase√±a
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // VERSION MARKER para verificar que el c√≥digo actualizado est√° cargado
        console.log('üîÑ PORTAL EMPLEADO - Versi√≥n actualizada cargada: ' + new Date().toISOString());
        console.log('‚úÖ Funciones de formateo DD/MM/AAAA activas');

        // Variables globales
        let empleadoInfo = null;
        let tiposPermisosData = [];
        let token = localStorage.getItem('auth_token');
        let userData = JSON.parse(localStorage.getItem('user_data') || '{}');
        let empleadoTemporal = null;

        // === FUNCIONES DE FORMATEO DE FECHAS ===

        /**
         * Formatea una fecha al formato DD/MM/YYYY (sin conversi√≥n de zona horaria)
         * @param {Date|string} fecha - Fecha a formatear
         * @returns {string} - Fecha formateada
         */
        function formatearFecha(fecha) {
            console.log('[DEBUG formatearFecha] Input:', fecha, 'Type:', typeof fecha);

            if (!fecha) {
                console.log('[DEBUG formatearFecha] Empty input, returning empty string');
                return '';
            }

            try {
                // Convertir a string
                const fechaStr = String(fecha).trim();
                console.log('[DEBUG formatearFecha] fechaStr:', fechaStr);

                // Si ya est√° formateada DD/MM/AAAA, devolverla
                if (fechaStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                    console.log('[DEBUG formatearFecha] Already formatted, returning:', fechaStr);
                    return fechaStr;
                }

                // Extraer solo la parte de fecha si tiene hora
                let dateOnly = fechaStr;
                if (fechaStr.includes('T')) {
                    dateOnly = fechaStr.split('T')[0];
                    console.log('[DEBUG formatearFecha] Extracted from ISO format:', dateOnly);
                } else if (fechaStr.includes(' ')) {
                    dateOnly = fechaStr.split(' ')[0];
                    console.log('[DEBUG formatearFecha] Extracted from SQL format:', dateOnly);
                }

                // Parsear YYYY-MM-DD
                const parts = dateOnly.split('-');
                console.log('[DEBUG formatearFecha] Parts after split:', parts);

                if (parts.length === 3) {
                    const [anio, mes, dia] = parts;
                    console.log('[DEBUG formatearFecha] Parsed parts - Year:', anio, 'Month:', mes, 'Day:', dia);

                    if (anio && mes && dia) {
                        const result = `${dia.padStart(2, '0')}/${mes.padStart(2, '0')}/${anio}`;
                        console.log('[DEBUG formatearFecha] Formatted result:', result);
                        return result;
                    }
                }

                console.log('[DEBUG formatearFecha] Failed to parse, returning empty string');
                return '';
            } catch (error) {
                console.error('Error formateando fecha:', error, fecha);
                return '';
            }
        }

        /**
         * Formatea una fecha y hora al formato DD/MM/YYYY HH:MM (sin conversi√≥n de zona horaria)
         * @param {Date|string} fecha - Fecha a formatear
         * @returns {string} - Fecha y hora formateada
         */
        function formatearFechaHora(fecha) {
            if (!fecha) return '';

            try {
                // Si la fecha ya est√° formateada, devolverla
                if (fecha.includes('/')) {
                    return fecha;
                }

                // Extraer fecha y hora del formato ISO (YYYY-MM-DDTHH:MM:SS.sssZ)
                let datePart, timePart;

                if (fecha.includes('T')) {
                    [datePart, timePart] = fecha.split('T');
                } else if (fecha.includes(' ')) {
                    [datePart, timePart] = fecha.split(' ');
                } else {
                    datePart = fecha;
                    timePart = null;
                }

                const [anio, mes, dia] = datePart.split('-');

                if (!timePart || timePart === 'undefined') {
                    // Si no hay hora, solo devolver la fecha
                    return `${dia}/${mes}/${anio}`;
                }

                // Extraer hora y minuto (ignorar segundos y milisegundos)
                const timeOnly = timePart.split('.')[0]; // Remover milisegundos si existen
                const [hora, minutos] = timeOnly.split(':');
                return `${dia}/${mes}/${anio} ${hora}:${minutos}`;
            } catch (error) {
                console.error('Error formateando fecha y hora:', error, fecha);
                return fecha;
            }
        }

        // Inicializaci√≥n de la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si hay un token de reset en la URL
            const urlParams = new URLSearchParams(window.location.search);
            const resetToken = urlParams.get('reset');
            
            if (resetToken) {
                // Validar token de reset
                validarTokenReset(resetToken);
                return;
            }
            
            if (token && userData.nombre) {
                mostrarDashboard();
                cargarDashboardCompleto();
            } else {
                mostrarLogin();
            }
        });
        
        // === FUNCIONES DE NAVEGACI√ìN ===
        function mostrarLogin() {
            ocultarTodasLasSecciones();
            document.getElementById('loginSection').classList.remove('hidden');
        }
        
        function mostrarImportarCSV() {
            ocultarTodasLasSecciones();
            document.getElementById('importarCSVSection').classList.remove('hidden');
        }
        
        function mostrarCrearUsuario() {
            ocultarTodasLasSecciones();
            document.getElementById('crearUsuarioSection').classList.remove('hidden');
        }
        
        function mostrarRecuperarPassword() {
            ocultarTodasLasSecciones();
            document.getElementById('recuperarPasswordSection').classList.remove('hidden');
            // Resetear formularios
            document.getElementById('formSolicitarRecuperacion').classList.remove('hidden');
            document.getElementById('mensajeRecuperacionExito').classList.add('hidden');
        }
        
        function mostrarRestablecerPassword(token) {
            ocultarTodasLasSecciones();
            document.getElementById('restablecerPasswordSection').classList.remove('hidden');
            document.getElementById('tokenReset').value = token || '';
        }
        
        function mostrarCrearPassword() {
            ocultarTodasLasSecciones();
            document.getElementById('crearPasswordSection').classList.remove('hidden');
            document.getElementById('crearPasswordForm').classList.add('hidden');
        }
        
        function mostrarDashboard() {
            ocultarTodasLasSecciones();
            document.getElementById('dashboardSection').classList.remove('hidden');
            if (userData.nombre) {
                document.getElementById('nombreEmpleado').textContent = userData.nombre;
            }
        }
        
        function ocultarTodasLasSecciones() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('crearPasswordSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('importarCSVSection').classList.add('hidden');
            document.getElementById('crearUsuarioSection').classList.add('hidden');
            document.getElementById('recuperarPasswordSection').classList.add('hidden');
            document.getElementById('restablecerPasswordSection').classList.add('hidden');
        }
        
        // === FUNCIONES DE AUTENTICACI√ìN ===
        
        // Login de empleado
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const rut = document.getElementById('loginRut').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!rut || !password) {
                mostrarToast('error', 'RUT y contrase√±a son requeridos');
                return;
            }
            
            try {
                const response = await fetch('/api/empleados-auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ rut, password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Guardar datos de sesi√≥n
                    localStorage.setItem('auth_token', data.token);
                    localStorage.setItem('user_data', JSON.stringify(data.empleado));
                    
                    token = data.token;
                    userData = data.empleado;
                    
                    mostrarToast('success', `¬°Bienvenido ${data.empleado.nombre}!`);
                    
                    setTimeout(() => {
                        mostrarDashboard();
                        cargarDashboardCompleto();
                    }, 1000);
                    
                } else {
                    throw new Error(data.error || 'Error en el login');
                }
                
            } catch (error) {
                mostrarToast('error', error.message);
            }
        });
        
        // Verificar RUT para crear contrase√±a
        document.getElementById('verificarRutForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const rut = document.getElementById('verificarRut').value.trim();
            
            if (!rut) {
                mostrarToast('error', 'RUT es requerido');
                return;
            }
            
            try {
                const response = await fetch('/api/empleados-auth/verificar-rut', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ rut })
                });
                
                const data = await response.json();
                
                if (response.ok && data.empleado) {
                    if (data.tienePassword) {
                        mostrarToast('warning', 'Este empleado ya tiene una contrase√±a configurada. Usa el formulario de login.');
                        setTimeout(mostrarLogin, 2000);
                        return;
                    }
                    
                    empleadoTemporal = data.empleado;
                    document.getElementById('empleadoEncontrado').textContent = data.empleado.nombre;
                    document.getElementById('verificarRutForm').classList.add('hidden');
                    document.getElementById('crearPasswordForm').classList.remove('hidden');
                    
                } else {
                    throw new Error(data.error || 'Empleado no encontrado');
                }
                
            } catch (error) {
                mostrarToast('error', error.message);
            }
        });
        
        // Crear contrase√±a
        document.getElementById('crearPasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const password = document.getElementById('nuevaPassword').value;
            const confirmPassword = document.getElementById('confirmarPassword').value;
            
            if (!password || !confirmPassword) {
                mostrarToast('error', 'Todos los campos son requeridos');
                return;
            }
            
            if (password !== confirmPassword) {
                mostrarToast('error', 'Las contrase√±as no coinciden');
                return;
            }
            
            if (password.length < 6) {
                mostrarToast('error', 'La contrase√±a debe tener al menos 6 caracteres');
                return;
            }
            
            if (!empleadoTemporal) {
                mostrarToast('error', 'Error: datos del empleado no encontrados');
                return;
            }
            
            try {
                const response = await fetch('/api/empleados-auth/crear-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        empleadoId: empleadoTemporal.id,
                        password: password,
                        confirmPassword: confirmPassword
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    mostrarToast('success', 'Contrase√±a creada exitosamente. Ya puedes iniciar sesi√≥n.');
                    
                    // Limpiar formularios
                    document.getElementById('verificarRutForm').reset();
                    document.getElementById('crearPasswordForm').reset();
                    empleadoTemporal = null;
                    
                    setTimeout(mostrarLogin, 2000);
                    
                } else {
                    throw new Error(data.error || 'Error al crear la contrase√±a');
                }
                
            } catch (error) {
                mostrarToast('error', error.message);
            }
        });
        
        // === FUNCIONES DEL DASHBOARD ===
        
        async function cargarDashboardCompleto() {
            try {
                // Cargar datos del dashboard
                await cargarDashboard();

                // Cargar solicitudes de permisos
                await cargarSolicitudes();

                // Cargar tipos de permisos
                await cargarTiposPermisos();

                // Cargar notificaciones
                await cargarNotificaciones();

            } catch (error) {
                console.error('Error cargando dashboard:', error);
                mostrarToast('error', 'Error al cargar el dashboard');
            }
        }
        
        async function cargarDashboard() {
            try {
                const response = await fetch('/api/solicitudes-empleado/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    empleadoInfo = data.data.empleado;
                    actualizarBalancePermisos(data.data.empleado, data.data.permisos_utilizados);
                    mostrarDatosPersonales(data.data.empleado);

                    // Verificar si es supervisor y mostrar secci√≥n de supervisi√≥n
                    console.log('üö®üö®üö® PUNTO CR√çTICO: A PUNTO DE LLAMAR verificarSiEsSupervisor');
                    console.log('üö® Empleado:', data.data.empleado);
                    console.log('üö® Token disponible:', !!token);
                    try {
                        await verificarSiEsSupervisor(data.data.empleado);
                        console.log('‚úÖ verificarSiEsSupervisor completado sin errores');
                    } catch (err) {
                        console.error('üí• ERROR en verificarSiEsSupervisor:', err);
                    }

                    // Manejar permisos del usuario y bot√≥n de administrador
                    manejarPermisosUsuario(data.data.permisos_usuario);

                    return data;
                } else {
                    throw new Error(data.error || 'Error al cargar dashboard');
                }
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('balancePermisos').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error al cargar balance: ${error.message}
                    </div>
                `;
                return null;
            }
        }
        
        async function cargarSolicitudes() {
            try {
                const response = await fetch('/api/solicitudes-empleado/historial', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                console.log('üìã Datos de historial recibidos:', data);

                if (response.ok) {
                    // Limpiar localStorage obsoleto (ya tenemos base de datos)
                    const empleadoId = JSON.parse(atob(token.split('.')[1])).id;
                    const keyUsuario = `solicitudes_${empleadoId}`;
                    localStorage.removeItem(keyUsuario);

                    // Usar solo datos del servidor (fuente de verdad)
                    const todasLasSolicitudes = data.data || [];

                    console.log('üìä Total solicitudes desde servidor:', todasLasSolicitudes.length);
                    mostrarSolicitudes(todasLasSolicitudes);
                    actualizarResumen(todasLasSolicitudes);
                } else {
                    throw new Error(data.message || 'Error al cargar solicitudes');
                }
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('listaSolicitudes').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error al cargar solicitudes: ${error.message}
                    </div>
                `;
            }
        }
        
        async function cargarTiposPermisos() {
            try {
                const response = await fetch('/api/solicitudes-empleado/tipos-permisos', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    tiposPermisosData = data.data || [];
                    const select = document.getElementById('tipoPermiso');
                    select.innerHTML = '<option value="">Selecciona un tipo...</option>';
                    
                    tiposPermisosData.forEach(tipo => {
                        select.innerHTML += `<option value="${tipo.id}">${tipo.nombre} (${tipo.codigo})</option>`;
                    });
                    
                    // Inicializar la l√≥gica de fecha fin despu√©s de cargar tipos
                    setTimeout(() => {
                        manejarFechaFinSegunTipo();
                    }, 100);
                }
                
            } catch (error) {
                console.error('Error cargando tipos de permisos:', error);
            }
        }
        
        // === FUNCIONES DE VISUALIZACI√ìN ===
        
        function mostrarDatosPersonales(empleado) {
            if (!empleado) return;
            
            document.getElementById('datosRut').textContent = empleado.rut || '-';
            document.getElementById('datosEmail').textContent = empleado.email || '-';
            document.getElementById('datosCargo').textContent = empleado.cargo || '-';
            document.getElementById('datosSupervisor').textContent = empleado.visualizacion || 'Sin asignar';
        }
        
        function mostrarSolicitudes(solicitudes) {
            const container = document.getElementById('listaSolicitudes');
            
            if (solicitudes.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-5">
                        <i class="fas fa-inbox" style="font-size: 4rem; opacity: 0.3; color: #dee2e6;"></i>
                        <h4 class="mt-3 text-muted">No tienes solicitudes a√∫n</h4>
                        <p class="text-muted">Crea tu primera solicitud de permiso</p>
                        <button class="btn btn-primary" onclick="mostrarModalNuevoPermiso()">
                            <i class="fas fa-plus me-2"></i>Crear primera solicitud
                        </button>
                    </div>
                `;
                return;
            }
            
            const html = solicitudes.map(solicitud => {
                const estado = solicitud.estado || 'PENDIENTE';
                const statusClass = `status-${estado.toLowerCase()}`;
                const statusIcon = {
                    'PENDIENTE': 'clock text-warning',
                    'APROBADO': 'check-circle text-success',
                    'RECHAZADO': 'times-circle text-danger',
                    'ANULADO': 'ban text-secondary'
                };
                
                // Extraer informaci√≥n de fechas (compatibilidad con ambos formatos)
                let fechaInicio = solicitud.fecha_desde || solicitud.fecha_inicio;
                let fechaFin = solicitud.fecha_hasta || solicitud.fecha_fin;
                let periodoTexto = '';
                
                if (solicitud.observaciones && solicitud.observaciones.includes('Permiso hist√≥rico importado desde CSV')) {
                    // Extraer mes de las observaciones
                    const mesMatch = solicitud.observaciones.match(/Mes: ([A-Z]+)/);
                    if (mesMatch) {
                        const mesNombre = mesMatch[1];
                        const meses = {
                            'ENERO': '01', 'FEBRERO': '02', 'MARZO': '03', 'ABRIL': '04',
                            'MAYO': '05', 'JUNIO': '06', 'JULIO': '07', 'AGOSTO': '08',
                            'SEPTIEMBRE': '09', 'OCTUBRE': '10', 'NOVIEMBRE': '11', 'DICIEMBRE': '12'
                        };
                        
                        if (meses[mesNombre]) {
                            const a√±o = '2025'; // A√±o por defecto para permisos hist√≥ricos
                            periodoTexto = `${mesNombre} ${a√±o}`;
                        } else {
                            periodoTexto = mesNombre;
                        }
                    } else {
                        periodoTexto = 'Per√≠odo hist√≥rico';
                    }
                } else if (fechaInicio && fechaFin && fechaInicio !== 'undefined' && fechaFin !== 'undefined') {
                    // Si las fechas son iguales, mostrar solo una vez
                    if (fechaInicio === fechaFin) {
                        periodoTexto = formatearFecha(fechaInicio);
                        console.log('Periodo formateado (fecha √∫nica):', fechaInicio, '->', periodoTexto);
                    } else {
                        periodoTexto = `${formatearFecha(fechaInicio)} al ${formatearFecha(fechaFin)}`;
                        console.log('Periodo formateado (rango):', fechaInicio, fechaFin, '->', periodoTexto);
                    }
                } else if (fechaInicio && fechaInicio !== 'undefined') {
                    periodoTexto = `Desde ${formatearFecha(fechaInicio)}`;
                    console.log('Periodo formateado (desde):', fechaInicio, '->', periodoTexto);
                } else {
                    periodoTexto = 'Fechas no especificadas';
                    console.log('Periodo: fechas no especificadas');
                }
                
                // Determinar si mostrar observaciones completas o resumidas
                let observacionesHTML = '';
                if (solicitud.observaciones) {
                    if (solicitud.observaciones.includes('Permiso hist√≥rico importado desde CSV')) {
                        // Para permisos hist√≥ricos, mostrar solo informaci√≥n relevante
                        const mesMatch = solicitud.observaciones.match(/Mes: ([A-Z]+)/);
                        if (mesMatch) {
                            observacionesHTML = `
                                <p class="card-text mb-0">
                                    <small class="text-muted">
                                        <i class="fas fa-history me-1"></i>
                                        <strong>Permiso hist√≥rico:</strong> ${mesMatch[1]} 2025
                                    </small>
                                </p>
                            `;
                        } else {
                            observacionesHTML = `
                                <p class="card-text mb-0">
                                    <small class="text-muted">
                                        <i class="fas fa-history me-1"></i>
                                        <strong>Permiso hist√≥rico importado</strong>
                                    </small>
                                </p>
                            `;
                        }
                    } else {
                        // Para permisos normales, mostrar observaciones completas
                        observacionesHTML = `
                            <p class="card-text mb-0">
                                <small class="text-muted">
                                    <strong><i class="fas fa-sticky-note me-1"></i> Observaciones:</strong> 
                                    ${solicitud.observaciones}
                                </small>
                            </p>
                        `;
                    }
                }
                
                return `
                    <div class="permiso-card card ${statusClass}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-2">
                                        <i class="fas fa-calendar-alt me-2"></i>
                                        ${solicitud.tipo_nombre || solicitud.tipo_permiso_nombre || 'Tipo no definido'}
                                    </h6>
                                    <p class="card-text text-muted mb-2">
                                        <strong><i class="fas fa-calendar me-1"></i> Per√≠odo:</strong> 
                                        ${periodoTexto}
                                    </p>
                                    <p class="card-text mb-2">
                                        <strong><i class="fas fa-comment me-1"></i> Motivo:</strong> 
                                        ${solicitud.motivo || 'No especificado'}
                                    </p>
                                    ${observacionesHTML}
                                </div>
                                <div class="text-end ms-3">
                                    <span class="badge bg-${estado === 'APROBADO' ? 'success' : estado === 'RECHAZADO' ? 'danger' : estado === 'ANULADO' ? 'secondary' : 'warning'} mb-2">
                                        <i class="fas fa-${statusIcon[estado]} me-1"></i> ${estado}
                                    </span>
                                    <br>
                                    <small class="text-muted">
                                        ${solicitud.fecha_aprobacion ? formatearFechaHora(solicitud.fecha_aprobacion) :
                                          solicitud.fecha_anulacion ? formatearFechaHora(solicitud.fecha_anulacion) :
                                          formatearFechaHora(solicitud.created_at)}
                                    </small>
                                    ${(estado === 'APROBADO' || estado === 'RECHAZADO' || estado === 'ANULADO') ? `
                                        <br><br>
                                        <button class="btn btn-sm btn-outline-${estado === 'APROBADO' ? 'primary' : estado === 'ANULADO' ? 'secondary' : 'danger'}" onclick="verPDF(${solicitud.id})">
                                            <i class="fas fa-file-pdf me-1"></i> Ver PDF
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        function actualizarResumen(solicitudes) {
            const pendientes = solicitudes.filter(s => s.estado === 'PENDIENTE').length;
            const aprobados = solicitudes.filter(s => s.estado === 'APROBADO').length;
            const rechazados = solicitudes.filter(s => s.estado === 'RECHAZADO').length;
            
            document.getElementById('totalPendientes').textContent = pendientes;
            document.getElementById('totalAprobados').textContent = aprobados;
            document.getElementById('totalRechazados').textContent = rechazados;
        }
        
        function actualizarBalancePermisos(empleado, permisosUtilizados) {
            if (!empleado) return;
            
            const tieneNegociacionColectiva = empleado.negociacion_colectiva === 1;
            const uso1Semestre = (permisosUtilizados && permisosUtilizados.primer_semestre) || empleado.uso_primer_semestre || 0;
            const uso2Semestre = (permisosUtilizados && permisosUtilizados.segundo_semestre) || empleado.uso_segundo_semestre || 0;
            const usoTotal = uso1Semestre + uso2Semestre;
            
            let html = `
                <div class="mb-3">
                    <h6><i class="fas fa-info-circle me-2"></i>Tu situaci√≥n:</h6>
                    <p class="mb-2">
                        <strong>Negociaci√≥n Colectiva:</strong> 
                        <span class="badge ${tieneNegociacionColectiva ? 'bg-success' : 'bg-secondary'}">${tieneNegociacionColectiva ? 'S√ç' : 'NO'}</span>
                    </p>
                </div>
            `;
            
            if (tieneNegociacionColectiva) {
                // Mostrar balance anual total
                const limiteTotal = 6.0;
                const disponible = Math.max(0, limiteTotal - usoTotal);
                
                html += `
                    <div class="balance-card">
                        <i class="fas fa-balance-scale text-info" style="font-size: 3rem;"></i>
                        <h3 class="mt-3 ${disponible === 0 ? 'text-danger' : disponible <= 1 ? 'text-warning' : 'text-success'}">${disponible}</h3>
                        <p class="mb-1"><strong>Permisos disponibles</strong></p>
                        <p class="text-muted mb-0">de ${limiteTotal} anuales totales</p>
                        <hr>
                        <p class="mb-0"><strong>Uso actual:</strong> ${usoTotal} permisos</p>
                        <small class="text-info">
                            <i class="fas fa-info-circle me-1"></i>
                            T = 1 permiso, AM/PM = 0.5 permisos c/u
                        </small>
                    </div>
                `;
            } else {
                // Mostrar balance semestral
                const limiteSemestral = 3.0;
                const disponible1 = Math.max(0, limiteSemestral - uso1Semestre);
                const disponible2 = Math.max(0, limiteSemestral - uso2Semestre);
                
                html += `
                    <div class="mb-3">
                        <h6><i class="fas fa-calendar-alt me-2"></i>1¬∞ Semestre (Ene - Jun)</h6>
                        <div class="balance-card">
                            <h4 class="${disponible1 === 0 ? 'text-danger' : disponible1 <= 0.5 ? 'text-warning' : 'text-success'}">${disponible1}</h4>
                            <small>Disponibles | Usados: ${uso1Semestre}</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6><i class="fas fa-calendar-alt me-2"></i>2¬∞ Semestre (Jul - Dic)</h6>
                        <div class="balance-card">
                            <h4 class="${disponible2 === 0 ? 'text-danger' : disponible2 <= 0.5 ? 'text-warning' : 'text-success'}">${disponible2}</h4>
                            <small>Disponibles | Usados: ${uso2Semestre}</small>
                        </div>
                    </div>
                    <div class="text-center">
                        <small class="text-muted">L√≠mite: ${limiteSemestral} permisos/semestre</small>
                        <br><small class="text-info">T = 1 permiso, AM/PM = 0.5 c/u</small>
                    </div>
                `;
            }
            
            document.getElementById('balancePermisos').innerHTML = html;
        }
        
        // === FUNCIONES DE MODALES ===
        
        function mostrarModalNuevoPermiso() {
            const modal = new bootstrap.Modal(document.getElementById('modalNuevoPermiso'));
            modal.show();
            
            // Limpiar alerta de l√≠mites
            document.getElementById('alertaLimitesPermiso').className = 'alert d-none';
        }
        
        function mostrarModalCambiarPassword() {
            const modal = new bootstrap.Modal(document.getElementById('modalCambiarPassword'));
            modal.show();

            // Limpiar el formulario
            document.getElementById('formCambiarPassword').reset();
        }

        async function cambiarPassword(event) {
            event.preventDefault();

            const passwordActual = document.getElementById('passwordActual').value;
            const passwordNuevo = document.getElementById('passwordNuevo').value;
            const confirmPassword = document.getElementById('passwordConfirmar').value;

            // Validar que las contrase√±as coincidan
            if (passwordNuevo !== confirmPassword) {
                mostrarToast('error', 'Las contrase√±as nuevas no coinciden');
                return;
            }

            if (passwordNuevo.length < 6) {
                mostrarToast('error', 'La contrase√±a debe tener al menos 6 caracteres');
                return;
            }

            try {
                const response = await fetch('/api/empleados-auth/cambiar-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        passwordActual,
                        passwordNuevo,
                        confirmPassword
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Cerrar modal
                    bootstrap.Modal.getInstance(document.getElementById('modalCambiarPassword')).hide();

                    // Limpiar formulario
                    document.getElementById('formCambiarPassword').reset();

                    // Mostrar mensaje de √©xito
                    mostrarToast('success', 'Contrase√±a cambiada exitosamente');
                } else {
                    throw new Error(data.error || data.message || 'Error al cambiar la contrase√±a');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarToast('error', error.message);
            }
        }

        function mostrarModalEditarDatos() {
            if (empleadoInfo) {
                // Solo mostrar el RUT como informaci√≥n, no editable
                document.getElementById('editRut').value = empleadoInfo.rut || '';
                document.getElementById('editEmail').value = empleadoInfo.email || '';
                document.getElementById('editCargo').value = empleadoInfo.cargo || '';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('modalEditarDatos'));
            modal.show();
        }
        
        // === FORMULARIOS ===
        
        // Nuevo permiso
        document.getElementById('formNuevoPermiso').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                tipo_permiso_id: document.getElementById('tipoPermiso').value,
                fecha_inicio: document.getElementById('fechaInicio').value,
                fecha_fin: document.getElementById('fechaFin').value,
                motivo: document.getElementById('motivo').value
            };
            
            // Validaciones b√°sicas
            if (!formData.tipo_permiso_id || !formData.fecha_inicio || !formData.motivo) {
                mostrarToast('error', 'Tipo de permiso, fecha de inicio y motivo son requeridos');
                return;
            }
            
            // Validaci√≥n especial para permisos sin goce (requieren fecha fin)
            const tipoSeleccionado = tiposPermisosData.find(tipo => tipo.id == formData.tipo_permiso_id);
            if (tipoSeleccionado && tipoSeleccionado.codigo === 'S' && !formData.fecha_fin) {
                mostrarToast('error', 'Los permisos sin goce requieren fecha de inicio y fin');
                return;
            }
            
            // Para T, AM, PM: no enviar fecha_fin
            if (tipoSeleccionado && ['T', 'AM', 'PM'].includes(tipoSeleccionado.codigo)) {
                delete formData.fecha_fin;
            }
            
            try {
                console.log('üì§ Enviando datos al servidor:', formData);
                console.log('üîë Token:', token ? 'Presente' : 'Ausente');
                
                const response = await fetch('/api/solicitudes-empleado/crear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                console.log('üìù Respuesta del servidor:', data);
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalNuevoPermiso')).hide();
                    document.getElementById('formNuevoPermiso').reset();
                    
                    // AGREGAR SOLICITUD DIRECTAMENTE AL DOM SIN ESPERAR DB
                    const nuevaSolicitud = {
                        id: Date.now(),
                        tipo_permiso: {
                            codigo: tipoSeleccionado.codigo,
                            nombre: tipoSeleccionado.nombre,
                            color: '#ffc107'
                        },
                        fecha_desde: formData.fecha_inicio,
                        fecha_hasta: formData.fecha_fin || formData.fecha_inicio,
                        motivo: formData.motivo,
                        observaciones: formData.observaciones || null,
                        estado: 'PENDIENTE',
                        fecha_solicitud: new Date().toISOString()
                    };
                    
                    // Obtener solicitudes actuales DEL USUARIO ESPEC√çFICO y agregar la nueva al inicio
                    const container = document.getElementById('listaSolicitudes');
                    const empleadoId = JSON.parse(atob(token.split('.')[1])).id;
                    const keyUsuario = `solicitudes_${empleadoId}`;
                    const solicitudesActuales = JSON.parse(localStorage.getItem(keyUsuario) || '[]');
                    solicitudesActuales.unshift(nuevaSolicitud);
                    localStorage.setItem(keyUsuario, JSON.stringify(solicitudesActuales));
                    
                    mostrarSolicitudes(solicitudesActuales);
                    mostrarToast('success', 'Solicitud de permiso creada exitosamente - Estado: PENDIENTE');
                    
                } else {
                    throw new Error(data.message || 'Error al crear la solicitud');
                }
                
            } catch (error) {
                mostrarToast('error', error.message);
            }
        });
        
        // Editar datos
        document.getElementById('formEditarDatos').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                email: document.getElementById('editEmail').value.trim(),
                cargo: document.getElementById('editCargo').value.trim()
            };
            
            if (!formData.email || !formData.cargo) {
                mostrarToast('error', 'Email y cargo son requeridos');
                return;
            }
            
            // Validar formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(formData.email)) {
                mostrarToast('error', 'Formato de email inv√°lido');
                return;
            }
            
            try {
                const response = await fetch('/api/empleados-auth/actualizar-datos', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('modalEditarDatos')).hide();
                    
                    // Actualizar datos locales (manteniendo el RUT original)
                    empleadoInfo = { ...empleadoInfo, ...formData };
                    mostrarDatosPersonales(empleadoInfo);
                    
                    // Actualizar localStorage (manteniendo el RUT original)
                    const currentUserData = JSON.parse(localStorage.getItem('user_data') || '{}');
                    localStorage.setItem('user_data', JSON.stringify({
                        ...currentUserData,
                        email: formData.email,
                        cargo: formData.cargo
                    }));
                    
                    mostrarToast('success', 'Datos actualizados correctamente');
                    
                } else {
                    throw new Error(data.error || 'Error al actualizar los datos');
                }
                
            } catch (error) {
                mostrarToast('error', error.message);
            }
        });
        
        // === FUNCIONES DE VALIDACI√ìN ===
        
        // Validar l√≠mites de permisos
        async function validarLimites() {
            const tipoPermisoSelect = document.getElementById('tipoPermiso');
            const fechaInicio = document.getElementById('fechaInicio').value;
            const alertDiv = document.getElementById('alertaLimitesPermiso');
            
            if (!tipoPermisoSelect.value || !fechaInicio || !empleadoInfo || !tiposPermisosData.length) {
                alertDiv.className = 'alert d-none';
                return true;
            }
            
            // Encontrar el c√≥digo del tipo de permiso seleccionado
            const tipoSeleccionado = tiposPermisosData.find(t => t.id == tipoPermisoSelect.value);
            if (!tipoSeleccionado) return true;
            
            const codigoPermiso = tipoSeleccionado.codigo;
            
            // Los permisos C y S no tienen l√≠mites
            if (['C', 'S'].includes(codigoPermiso)) {
                alertDiv.className = 'alert alert-info d-block';
                alertDiv.innerHTML = `
                    <i class="fas fa-info-circle me-2"></i>
                    Los permisos de ${tipoSeleccionado.nombre} no cuentan para l√≠mites administrativos.
                `;
                return true;
            }
            
            // Solo validar T, AM, PM
            if (!['T', 'AM', 'PM'].includes(codigoPermiso)) {
                alertDiv.className = 'alert d-none';
                return true;
            }
            
            // Validar l√≠mites
            const tieneNegociacionColectiva = empleadoInfo.negociacion_colectiva === 1;
            const uso1Semestre = empleadoInfo.uso_primer_semestre || 0;
            const uso2Semestre = empleadoInfo.uso_segundo_semestre || 0;
            const fechaPermisoObj = new Date(fechaInicio);
            const mes = fechaPermisoObj.getMonth() + 1;
            const esPrimerSemestre = mes <= 6;
            
            let disponible, periodo;
            const valorPermiso = codigoPermiso === 'T' ? 1.0 : 0.5;
            
            if (tieneNegociacionColectiva) {
                const usoTotal = uso1Semestre + uso2Semestre;
                disponible = 6.0 - usoTotal;
                periodo = 'a√±o';
            } else {
                const usoSemestre = esPrimerSemestre ? uso1Semestre : uso2Semestre;
                disponible = 3.0 - usoSemestre;
                periodo = esPrimerSemestre ? 'primer semestre' : 'segundo semestre';
            }
            
            if (valorPermiso > disponible) {
                alertDiv.className = 'alert alert-danger d-block';
                alertDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>¬°L√≠mite excedido!</strong> Este permiso ${codigoPermiso} (valor ${valorPermiso}) exceder√≠a tu l√≠mite. 
                    Solo tienes ${disponible} permisos disponibles para el ${periodo}.
                `;
                return false;
            } else if (disponible - valorPermiso <= 0.5) {
                alertDiv.className = 'alert alert-warning d-block';
                alertDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>¬°Atenci√≥n!</strong> Despu√©s de este permiso ${codigoPermiso} te quedar√°n ${disponible - valorPermiso} permisos disponibles para el ${periodo}.
                `;
                return true;
            } else {
                alertDiv.className = 'alert alert-success d-block';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    Permiso ${codigoPermiso} v√°lido. Despu√©s de este permiso te quedar√°n ${disponible - valorPermiso} permisos disponibles para el ${periodo}.
                `;
                return true;
            }
        }
        
        // Event listeners para validaci√≥n de l√≠mites y control de fechas
        document.getElementById('tipoPermiso').addEventListener('change', function() {
            validarLimites();
            manejarFechaFinSegunTipo();
        });
        document.getElementById('fechaInicio').addEventListener('change', validarLimites);
        
        // Funci√≥n para mostrar/ocultar fecha fin seg√∫n tipo de permiso
        function manejarFechaFinSegunTipo() {
            const tipoPermisoSelect = document.getElementById('tipoPermiso');
            const fechaFinInput = document.getElementById('fechaFin');
            
            // Buscar el contenedor con la clase correcta
            const fechaFinGroup = fechaFinInput ? fechaFinInput.closest('.edit-field') : null;
            
            if (!tipoPermisoSelect || !fechaFinInput || !fechaFinGroup) {
                console.log('‚ö†Ô∏è No se encontraron elementos del formulario');
                return;
            }
            
            if (!tipoPermisoSelect.value) {
                fechaFinGroup.style.display = 'block';
                return;
            }
            
            // Buscar el tipo seleccionado
            const tipoSeleccionado = tiposPermisosData.find(tipo => 
                tipo.id == tipoPermisoSelect.value
            );
            
            if (tipoSeleccionado) {
                const codigo = tipoSeleccionado.codigo;
                console.log('üìÖ Tipo de permiso seleccionado:', codigo);
                
                if (codigo === 'S') {
                    // Permisos sin goce: mostrar fecha fin (obligatoria)
                    fechaFinGroup.style.display = 'block';
                    fechaFinInput.required = true;
                    const label = fechaFinGroup.querySelector('label');
                    if (label) {
                        label.innerHTML = 'Fecha hasta <span class="text-danger">*</span>';
                    }
                    console.log('‚úÖ Mostrando fecha fin para permiso sin goce');
                } else {
                    // T, AM, PM: ocultar fecha fin
                    fechaFinGroup.style.display = 'none';
                    fechaFinInput.required = false;
                    fechaFinInput.value = ''; // Limpiar valor
                    console.log('‚úÖ Ocultando fecha fin para permiso:', codigo);
                }
            }
        }
        
        // === FUNCIONES AUXILIARES ===
        
        function mostrarToast(tipo, mensaje) {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const toastHtml = `
                <div id="${toastId}" class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <i class="fas fa-${tipo === 'success' ? 'check-circle text-success' : tipo === 'warning' ? 'exclamation-triangle text-warning' : 'exclamation-circle text-danger'} me-2"></i>
                        <strong class="me-auto">${tipo === 'success' ? '√âxito' : tipo === 'warning' ? 'Aviso' : 'Error'}</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        ${mensaje}
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const toastElement = document.getElementById(toastId);
                if (toastElement) {
                    toastElement.remove();
                }
            }, 5000);
        }
        
        function actualizarDashboard() {
            mostrarToast('info', 'Actualizando dashboard...');
            cargarDashboardCompleto();
        }

        async function verPDF(solicitudId) {
            try {
                const url = `/api/solicitudes-empleado/descargar-pdf/${solicitudId}`;

                // Abrir PDF en nueva pesta√±a con el token de autenticaci√≥n
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Error al cargar el PDF');
                }

                // Obtener el PDF como blob y abrirlo en nueva pesta√±a
                const blob = await response.blob();
                const pdfUrl = URL.createObjectURL(blob);
                window.open(pdfUrl, '_blank');

            } catch (error) {
                console.error('Error al abrir PDF:', error);
                mostrarToast('error', 'Error al abrir el PDF: ' + error.message);
            }
        }

        function manejarPermisosUsuario(permisos) {
            const btnAdmin = document.getElementById('btnAdmin');
            
            if (permisos && permisos.puede_aprobar) {
                // Solo Ronny y Patricio Bravo pueden ver el bot√≥n de administrador
                btnAdmin.style.display = 'inline-block';
                console.log('Usuario autorizado para administraci√≥n:', permisos);
            } else {
                // Ocultar bot√≥n para todos los dem√°s (empleados regulares y supervisores)
                btnAdmin.style.display = 'none';
            }
            
            // Guardar permisos para usar en otras funciones si es necesario
            window.permisosUsuario = permisos;
        }
        
        function cerrarSesion() {
            localStorage.clear();
            sessionStorage.clear();
            token = null;
            userData = {};
            empleadoInfo = null;
            tiposPermisosData = [];
            empleadoTemporal = null;

            mostrarToast('success', 'Sesi√≥n cerrada correctamente');
            setTimeout(() => {
                window.location.href = '/';
            }, 1000);
        }

        // === FUNCIONES PARA NOTIFICACIONES ===

        async function cargarNotificaciones() {
            try {
                const response = await fetch('/api/notificaciones/empleado', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    const notificaciones = data.notificaciones || [];
                    mostrarNotificaciones(notificaciones);
                    actualizarBadgeNotificaciones(notificaciones);
                }
            } catch (error) {
                console.error('Error cargando notificaciones:', error);
            }
        }

        function mostrarNotificaciones(notificaciones) {
            const container = document.getElementById('notificationList');

            if (!notificaciones || notificaciones.length === 0) {
                container.innerHTML = `
                    <div class="notification-empty">
                        <i class="fas fa-bell-slash fa-2x mb-2"></i>
                        <p>No tienes notificaciones</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = notificaciones.map(n => {
                const iconType = getNotificationIconType(n.tipo);
                const timeAgo = formatTimeAgo(n.created_at);
                const unreadClass = n.leida ? '' : 'unread';

                return `
                    <div class="notification-item ${unreadClass}" onclick="marcarNotificacionLeida(${n.id})">
                        <div class="d-flex">
                            <div class="notification-icon ${iconType}">
                                <i class="fas ${getNotificationIcon(n.tipo)}"></i>
                            </div>
                            <div class="notification-content">
                                <div class="notification-title">${n.titulo}</div>
                                <div class="notification-message">${n.mensaje}</div>
                                <div class="notification-time">
                                    <i class="far fa-clock"></i> ${timeAgo}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getNotificationIconType(tipo) {
            const typeMap = {
                'NUEVA_SOLICITUD': 'info',
                'SOLICITUD_APROBADA': 'success',
                'SOLICITUD_RECHAZADA': 'danger',
                'RECORDATORIO': 'warning'
            };
            return typeMap[tipo] || 'info';
        }

        function getNotificationIcon(tipo) {
            const iconMap = {
                'NUEVA_SOLICITUD': 'fa-file-alt',
                'SOLICITUD_APROBADA': 'fa-check-circle',
                'SOLICITUD_RECHAZADA': 'fa-times-circle',
                'RECORDATORIO': 'fa-exclamation-triangle'
            };
            return iconMap[tipo] || 'fa-bell';
        }

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diff = now - time;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (minutes < 1) return 'Ahora';
            if (minutes < 60) return `Hace ${minutes} minuto${minutes > 1 ? 's' : ''}`;
            if (hours < 24) return `Hace ${hours} hora${hours > 1 ? 's' : ''}`;
            return `Hace ${days} d√≠a${days > 1 ? 's' : ''}`;
        }

        function actualizarBadgeNotificaciones(notificaciones) {
            const badge = document.getElementById('notificationBadge');
            const noLeidas = notificaciones.filter(n => !n.leida).length;

            if (noLeidas > 0) {
                badge.textContent = noLeidas > 99 ? '99+' : noLeidas;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        function toggleNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            dropdown.classList.toggle('show');

            if (dropdown.classList.contains('show')) {
                cargarNotificaciones();
            }
        }

        async function marcarNotificacionLeida(id) {
            try {
                const response = await fetch(`/api/notificaciones/${id}/leer`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    cargarNotificaciones();
                }
            } catch (error) {
                console.error('Error marcando notificaci√≥n como le√≠da:', error);
            }
        }

        async function marcarTodasLeidas() {
            try {
                const response = await fetch('/api/notificaciones/empleado/leer-todas', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    cargarNotificaciones();
                    mostrarToast('success', 'Todas las notificaciones marcadas como le√≠das');
                } else {
                    mostrarToast('error', 'Error al marcar notificaciones como le√≠das');
                }
            } catch (error) {
                console.error('Error marcando todas como le√≠das:', error);
                mostrarToast('error', 'Error al marcar notificaciones como le√≠das');
            }
        }

        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('notificationDropdown');
            const button = document.getElementById('notificationBtn');

            if (dropdown && button && !dropdown.contains(e.target) && !button.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Cargar notificaciones cada 30 segundos
        setInterval(() => {
            if (token) {
                cargarNotificaciones();
            }
        }, 30000);

        // === FUNCIONES PARA CSV ===
        
        let datosCSV = [];
        
        // Event listener para archivo CSV
        document.getElementById('archivoCSV').addEventListener('change', function(e) {
            const archivo = e.target.files[0];
            if (archivo && archivo.type === 'text/csv') {
                leerArchivoCSV(archivo);
            } else {
                mostrarToast('error', 'Por favor selecciona un archivo CSV v√°lido');
            }
        });
        
        function leerArchivoCSV(archivo) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const contenido = e.target.result;
                procesarContenidoCSV(contenido);
            };
            reader.readAsText(archivo);
        }
        
        function procesarContenidoCSV(contenido) {
            const lineas = contenido.split('\n');
            const empleados = [];
            
            // Buscar la l√≠nea de encabezados (l√≠nea 6 seg√∫n el formato)
            let indiceEncabezados = -1;
            for (let i = 0; i < lineas.length; i++) {
                if (lineas[i].includes('Colaborador - Nombre Completo')) {
                    indiceEncabezados = i;
                    break;
                }
            }
            
            if (indiceEncabezados === -1) {
                mostrarToast('error', 'No se encontraron los encabezados esperados en el CSV');
                return;
            }
            
            // Procesar datos desde la l√≠nea siguiente a los encabezados
            for (let i = indiceEncabezados + 1; i < lineas.length; i++) {
                const linea = lineas[i].trim();
                if (linea === '') continue;
                
                const campos = linea.split(';');
                if (campos.length >= 9) {
                    const empleado = {
                        nombre: campos[0].trim(),
                        rut: campos[1].trim(),
                        email: campos[2].trim(),
                        fechaNacimiento: formatearFechaParaDB(campos[3].trim()),
                        fechaIngreso: formatearFechaParaDB(campos[4].trim()),
                        fechaTermino: formatearFechaParaDB(campos[5].trim()) || null,
                        horasSemanales: parseInt(campos[6].trim()) || 44,
                        supervisor: campos[7].trim(),
                        cargo: campos[8].trim()
                    };
                    
                    if (empleado.nombre && empleado.rut) {
                        empleados.push(empleado);
                    }
                }
            }
            
            if (empleados.length > 0) {
                datosCSV = empleados;
                mostrarPreviewCSV(empleados);
                document.getElementById('btnProcesarCSV').disabled = false;
            } else {
                mostrarToast('error', 'No se encontraron datos v√°lidos en el CSV');
            }
        }
        
        function formatearFechaParaDB(fechaStr) {
            if (!fechaStr || fechaStr.trim() === '') return null;

            // Convertir formato DD/MM/YYYY a YYYY-MM-DD para la base de datos
            const partes = fechaStr.split('/');
            if (partes.length === 3) {
                const [dia, mes, a√±o] = partes;
                return `${a√±o}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
            }

            return fechaStr;
        }
        
        function mostrarPreviewCSV(empleados) {
            const preview = document.getElementById('previewCSV');
            const tabla = document.getElementById('tablaPreview');
            const tbody = tabla.querySelector('tbody');
            const thead = tabla.querySelector('thead');
            
            // Crear encabezados
            thead.innerHTML = `
                <tr>
                    <th>Nombre</th>
                    <th>RUT</th>
                    <th>Email</th>
                    <th>Cargo</th>
                    <th>Supervisor</th>
                </tr>
            `;
            
            // Mostrar primeros 5 empleados
            tbody.innerHTML = empleados.slice(0, 5).map(emp => `
                <tr>
                    <td>${emp.nombre}</td>
                    <td>${emp.rut}</td>
                    <td>${emp.email}</td>
                    <td>${emp.cargo}</td>
                    <td>${emp.supervisor}</td>
                </tr>
            `).join('');
            
            document.getElementById('totalRegistros').textContent = empleados.length;
            preview.classList.remove('d-none');
        }
        
        async function procesarCSV() {
            if (datosCSV.length === 0) {
                mostrarToast('error', 'No hay datos para procesar');
                return;
            }
            
            mostrarToast('info', `Procesando ${datosCSV.length} empleados...`);
            
            const btnProcesar = document.getElementById('btnProcesarCSV');
            btnProcesar.disabled = true;
            btnProcesar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';
            
            let procesados = 0;
            let errores = 0;
            
            for (const empleado of datosCSV) {
                try {
                    const response = await fetch('/api/admin/empleado', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(empleado)
                    });
                    
                    if (response.ok) {
                        procesados++;
                    } else {
                        errores++;
                        console.error(`Error procesando ${empleado.nombre}:`, await response.text());
                    }
                } catch (error) {
                    errores++;
                    console.error(`Error procesando ${empleado.nombre}:`, error);
                }
            }
            
            btnProcesar.disabled = false;
            btnProcesar.innerHTML = '<i class="fas fa-database me-2"></i>Importar a la Base de Datos';
            
            if (errores === 0) {
                mostrarToast('success', `${procesados} empleados importados exitosamente`);
                setTimeout(mostrarLogin, 2000);
            } else {
                mostrarToast('warning', `${procesados} procesados exitosamente, ${errores} con errores`);
            }
        }
        
        // === FUNCIONES PARA RECUPERAR CONTRASE√ëA ===
        
        // Validar token de reset
        async function validarTokenReset(token) {
            try {
                const response = await fetch(`/api/empleados-auth/validar-token-reset/${token}`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    mostrarRestablecerPassword(token);
                    mostrarToast('info', `Restableciendo contrase√±a para ${data.empleado.nombre}`);
                } else {
                    mostrarLogin();
                    mostrarToast('error', data.error || 'Token de recuperaci√≥n inv√°lido o expirado');
                }
            } catch (error) {
                mostrarLogin();
                mostrarToast('error', 'Error validando el token de recuperaci√≥n');
            }
        }
        
        // Solicitar recuperaci√≥n de contrase√±a
        document.getElementById('formSolicitarRecuperacion').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const rut = document.getElementById('rutRecuperacion').value.trim();
            const email = document.getElementById('emailRecuperacion').value.trim();
            
            if (!rut || !email) {
                mostrarToast('error', 'RUT y email son requeridos');
                return;
            }
            
            // Validar formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                mostrarToast('error', 'Formato de email inv√°lido');
                return;
            }
            
            try {
                const response = await fetch('/api/empleados-auth/solicitar-reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ rut, email })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Mostrar mensaje de √©xito
                    document.getElementById('formSolicitarRecuperacion').classList.add('hidden');
                    document.getElementById('mensajeRecuperacionExito').classList.remove('hidden');
                    
                    mostrarToast('success', 'Enlace de recuperaci√≥n enviado a tu email');
                    
                } else {
                    throw new Error(data.error || 'Error al solicitar recuperaci√≥n');
                }
                
            } catch (error) {
                mostrarToast('error', error.message);
            }
        });
        
        // Restablecer contrase√±a
        document.getElementById('formRestablecerPassword').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const token = document.getElementById('tokenReset').value;
            const password = document.getElementById('nuevaPasswordReset').value;
            const confirmPassword = document.getElementById('confirmarPasswordReset').value;
            
            if (!token || !password || !confirmPassword) {
                mostrarToast('error', 'Todos los campos son requeridos');
                return;
            }
            
            if (password !== confirmPassword) {
                mostrarToast('error', 'Las contrase√±as no coinciden');
                return;
            }
            
            if (password.length < 6) {
                mostrarToast('error', 'La contrase√±a debe tener al menos 6 caracteres');
                return;
            }
            
            try {
                const response = await fetch('/api/empleados-auth/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token, password, confirmPassword })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    mostrarToast('success', 'Contrase√±a restablecida exitosamente. Ya puedes iniciar sesi√≥n.');
                    
                    // Limpiar formulario y redirigir al login
                    document.getElementById('formRestablecerPassword').reset();
                    
                    // Limpiar URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    setTimeout(mostrarLogin, 2000);
                    
                } else {
                    throw new Error(data.error || 'Error al restablecer la contrase√±a');
                }
                
            } catch (error) {
                mostrarToast('error', error.message);
            }
        });
        
        // === FUNCIONES PARA CREAR USUARIO ===
        
        document.getElementById('formCrearUsuario').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const empleadoData = {
                nombre: document.getElementById('nuevoNombre').value.trim(),
                rut: document.getElementById('nuevoRut').value.trim(),
                email: document.getElementById('nuevoEmail').value.trim(),
                cargo: document.getElementById('nuevoCargo').value.trim(),
                fechaNacimiento: document.getElementById('fechaNacimiento').value || null,
                fechaIngreso: document.getElementById('fechaIngreso').value || null,
                horasSemanales: parseInt(document.getElementById('horasSemanales').value) || 44,
                supervisor: document.getElementById('supervisor').value.trim() || null
            };
            
            // Validaciones b√°sicas
            if (!empleadoData.nombre || !empleadoData.rut || !empleadoData.email || !empleadoData.cargo) {
                mostrarToast('error', 'Nombre, RUT, email y cargo son campos obligatorios');
                return;
            }
            
            // Validar formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(empleadoData.email)) {
                mostrarToast('error', 'Formato de email inv√°lido');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/empleado', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(empleadoData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    mostrarToast('success', `Empleado ${empleadoData.nombre} creado exitosamente`);
                    document.getElementById('formCrearUsuario').reset();
                    document.getElementById('horasSemanales').value = '44'; // Resetear valor por defecto
                    setTimeout(mostrarLogin, 2000);
                } else {
                    throw new Error(data.error || 'Error al crear el empleado');
                }
                
            } catch (error) {
                mostrarToast('error', error.message);
            }
        });
        
        // =================== FUNCIONALIDAD DE SUPERVISI√ìN ===================
        
        // TEMPORAL: Funci√≥n para verificar supervisores
        window.verificarSupervisores = async function() {
            try {
                console.log('üîç Verificando supervisores en el sistema...');
                
                // Llamar al endpoint que nos d√© info de subordinados
                const response = await fetch('/api/solicitudes-empleado/subordinados', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                console.log('üìä Informaci√≥n de supervisi√≥n:', data);
                console.log('üë• Subordinados:', data.subordinados);
                
            } catch (error) {
                console.log('Error:', error);
            }
        };
        
        // TEMPORAL: Funci√≥n para arreglar permisos de Andrea
        window.arreglarAndrea = async function() {
            try {
                console.log('üîß Arreglando permisos de Andrea...');
                
                // Buscar Andrea por nombre
                const response = await fetch('/api/empleados-auth/verificar-rut', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ rut: '17.123.456-7' }) // RUT de Andrea
                });
                
                const data = await response.json();
                console.log('Andrea encontrada:', data);
                
                // Si es Andrea, mostrar pesta√±a forzadamente
                if (data.empleado && data.empleado.nombre.toLowerCase().includes('andrea')) {
                    console.log('‚úÖ FORZANDO supervisi√≥n para Andrea');
                    document.getElementById('tab-supervision').style.display = 'block';
                    cargarSolicitudesSubordinados();
                }
                
            } catch (error) {
                console.log('Error:', error);
            }
        };
        
        // Verificar si el usuario es supervisor y mostrar secci√≥n
        async function verificarSiEsSupervisor(empleadoInfo) {
            console.log('üîç Verificando si es supervisor:', empleadoInfo);
            console.log('- Nombre:', empleadoInfo?.nombre);

            try {
                // Consultar al servidor si el empleado tiene subordinados
                console.log('üîç Consultando subordinados al servidor...');
                const response = await fetch('/api/solicitudes-empleado/subordinados', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('üìä Respuesta del servidor:', data);

                    const tieneSubordinados = data.subordinados && data.subordinados.length > 0;
                    console.log('üë• Tiene subordinados:', tieneSubordinados, '- Cantidad:', data.subordinados?.length || 0);

                    if (tieneSubordinados) {
                        console.log('‚úÖ Mostrando pesta√±a de supervisi√≥n');
                        document.getElementById('tab-supervision').style.display = 'block';
                        cargarSolicitudesSubordinados();
                    } else {
                        console.log('‚ùå No tiene subordinados - ocultando pesta√±a');
                        document.getElementById('tab-supervision').style.display = 'none';
                    }
                } else {
                    console.log('‚ö†Ô∏è Error consultando subordinados, ocultando pesta√±a');
                    document.getElementById('tab-supervision').style.display = 'none';
                }
            } catch (error) {
                console.error('‚ùå Error verificando subordinados:', error);
                document.getElementById('tab-supervision').style.display = 'none';
            }
        }
        
        // Cargar solicitudes de subordinados
        async function cargarSolicitudesSubordinados() {
            try {
                console.log('üîç === DEBUGGING SOLICITUDES SUBORDINADOS ===');
                console.log('üîç Token presente:', !!token);
                console.log('üîç Llamando a /api/solicitudes-empleado/subordinados');
                
                const response = await fetch('/api/solicitudes-empleado/subordinados', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('üîç Response status:', response.status);
                console.log('üîç Response ok:', response.ok);
                
                const data = await response.json();
                console.log('üë• RESPUESTA COMPLETA del servidor:', data);
                console.log('üë• Subordinados encontrados:', data.subordinados);
                console.log('üë• Solicitudes encontradas:', data.data);
                console.log('üë• ROL del usuario:', data.rol);

                if (response.ok) {
                    mostrarSolicitudesSubordinados(data.data || [], data.rol);
                } else {
                    throw new Error(data.message || 'Error al cargar solicitudes de subordinados');
                }
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('listaSolicitudesSubordinados').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error al cargar permisos por autorizar: ${error.message}
                    </div>
                `;
            }
        }
        
        // Mostrar solicitudes de subordinados
        function mostrarSolicitudesSubordinados(solicitudes, rolUsuario) {
            const container = document.getElementById('listaSolicitudesSubordinados');
            
            if (solicitudes.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-5">
                        <i class="fas fa-clipboard-check" style="font-size: 4rem; opacity: 0.3; color: #dee2e6;"></i>
                        <h5 class="mt-3 text-muted">No hay solicitudes pendientes</h5>
                        <p class="text-muted">No tienes permisos pendientes por autorizar</p>
                    </div>
                `;
                return;
            }
            
            const html = solicitudes.map(solicitud => {
                const estadoBadge = {
                    'PENDIENTE': '<span class="badge bg-warning text-dark">PENDIENTE</span>',
                    'APROBADO': '<span class="badge bg-success">APROBADO</span>',
                    'RECHAZADO': '<span class="badge bg-danger">RECHAZADO</span>',
                    'APROBADO_SUPERVISOR': '<span class="badge bg-info">APROBADO POR SUPERVISOR</span>'
                };
                
                return `
                    <div class="permiso-card card status-${solicitud.estado.toLowerCase()}">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="card-title mb-0">
                                            <span class="badge" style="background-color: ${solicitud.tipo_permiso.color}">
                                                ${solicitud.tipo_permiso.codigo}
                                            </span>
                                            ${solicitud.tipo_permiso.nombre}
                                        </h6>
                                        ${estadoBadge[solicitud.estado] || estadoBadge['PENDIENTE']}
                                    </div>
                                    <p class="mb-1"><strong>Empleado:</strong> ${solicitud.empleado.nombre}</p>
                                    <p class="mb-1"><strong>RUT:</strong> ${solicitud.empleado.rut}</p>
                                    <p class="mb-1"><strong>Cargo:</strong> ${solicitud.empleado.cargo}</p>
                                    <p class="mb-1"><strong>Fecha:</strong> ${solicitud.fecha_desde === solicitud.fecha_hasta ? formatearFecha(solicitud.fecha_desde) : formatearFecha(solicitud.fecha_desde) + ' al ' + formatearFecha(solicitud.fecha_hasta)}</p>
                                    <p class="mb-1"><strong>Motivo:</strong> ${solicitud.motivo}</p>
                                    <p class="text-muted small">Solicitado: ${formatearFecha(solicitud.fecha_solicitud)}</p>
                                </div>
                                <div class="col-md-4 text-end">
                                    ${
                                        // Mostrar botones seg√∫n el rol del usuario y el estado de la solicitud
                                        (rolUsuario === 'supervisor_visualizacion' && solicitud.estado === 'PENDIENTE') ||
                                        (rolUsuario === 'autorizador_final' && solicitud.estado === 'APROBADO_SUPERVISOR') ||
                                        (rolUsuario === 'autorizador_final' && solicitud.estado === 'PENDIENTE')  // Flujo de un paso
                                        ? `
                                        <div class="btn-group-vertical gap-2">
                                            <button class="btn btn-success btn-sm" onclick="aprobarSolicitud(${solicitud.id})">
                                                <i class="fas fa-check me-1"></i> Aprobar
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="rechazarSolicitud(${solicitud.id})">
                                                <i class="fas fa-times me-1"></i> Rechazar
                                            </button>
                                        </div>
                                    ` : `
                                        <div class="text-muted">
                                            <i class="fas fa-info-circle"></i>
                                            <small>Ya procesado</small>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        // Aprobar solicitud
        async function aprobarSolicitud(id) {
            if (!confirm('¬øEst√°s seguro de aprobar esta solicitud?')) return;
            
            try {
                const response = await fetch(`/api/solicitudes-empleado/aprobar-supervisor/${id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    mostrarToast('success', 'Solicitud aprobada exitosamente');
                    cargarSolicitudesSubordinados(); // Recargar lista
                } else {
                    throw new Error(data.error || 'Error al aprobar solicitud');
                }
                
            } catch (error) {
                mostrarToast('error', error.message);
            }
        }
        
        // Rechazar solicitud
        async function rechazarSolicitud(id) {
            const motivo = prompt('Ingresa el motivo del rechazo:');
            if (!motivo) return;

            try {
                const response = await fetch(`/api/solicitudes-empleado/rechazar-supervisor/${id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ motivo: motivo })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    mostrarToast('success', 'Solicitud rechazada');
                    cargarSolicitudesSubordinados(); // Recargar lista
                } else {
                    throw new Error(data.error || 'Error al rechazar solicitud');
                }
                
            } catch (error) {
                mostrarToast('error', error.message);
            }
        }
    </script>
</body>
</html>